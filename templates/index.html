<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Waste Experts PDF Extractor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Montserrat', sans-serif; margin: 0; background: #1e2e3d; color: #e8ecf1; }
    .wrap { max-width: 980px; margin: 24px auto 48px; padding: 0 16px; }
    .brand { text-align: center; margin: 6px 0 18px; }
    .brand img { max-width: 320px; width: 100%; height: auto; }

    /* --- Cards --- */
    .card { background: #253a4d; border-radius: 4px; box-shadow: 0 2px 12px rgba(0,0,0,.25); margin-bottom: 16px; border: 1px solid #2f4a60; }
    .head { background: #8ec431; color: #fff; padding: 16px 20px; border-radius: 4px 4px 0 0; font-weight: 700; font-size: 15px; }
    .body { padding: 16px 20px; }

    /* --- Drop zone --- */
    .drop { border: 2px dashed #3d5a73; border-radius: 4px; padding: 28px; text-align: center; transition: border-color .2s, background .2s; }
    .drop.drag-over { border-color: #8ec431; background: rgba(142,196,49,.1); }
    .drop p { margin: 0 0 10px; color: #c0cdd8; }

    /* --- Grid / fields --- */
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .field { display: flex; flex-direction: column; gap: 4px; position: relative; }
    .full { grid-column: 1 / -1; }
    label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; color: #8ec431; }
    input, textarea, select {
      border: 1px solid #3d5a73; border-radius: 4px; padding: 10px 12px;
      font-size: 14px; font-family: 'Montserrat', sans-serif;
      background: #1e2e3d; color: #e8ecf1; transition: border-color .2s, box-shadow .2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: #8ec431; box-shadow: 0 0 0 2px rgba(142,196,49,.2);
    }
    input::placeholder, textarea::placeholder { color: #5a7a94; }
    textarea { min-height: 64px; resize: vertical; }
    select option { background: #1e2e3d; color: #e8ecf1; }
    .hidden { display: none; }
    .error { color: #f87171; font-weight: 700; margin-top: 4px; font-size: 12px; }
    .ok { color: #8ec431; font-weight: 700; margin-top: 4px; font-size: 13px; }

    /* --- Buttons --- */
    .btn {
      border: none; background: #8ec431; color: #fff; border-radius: 4px;
      padding: 10px 18px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 13px;
      transition: background .2s;
    }
    .btn:hover { background: #7ab328; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-outline {
      border: 1px solid #8ec431; background: transparent; color: #8ec431;
      border-radius: 4px; padding: 10px 18px; font-weight: 700;
      cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 13px;
      transition: background .2s, color .2s;
    }
    .btn-outline:hover { background: rgba(142,196,49,.15); color: #a5d84e; }
    .pill { display: inline-block; background: rgba(142,196,49,.15); color: #8ec431; border: 1px solid #8ec431; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700; }
    .hl { border: 2px solid #8ec431; box-shadow: 0 0 0 2px rgba(142,196,49,.15) inset; }

    /* --- Typeahead dropdown --- */
    .typeahead-wrap { position: relative; }
    .typeahead-list {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      max-height: 220px; overflow-y: auto;
      background: #253a4d; border: 1px solid #3d5a73; border-radius: 4px;
      box-shadow: 0 6px 20px rgba(0,0,0,.35);
      display: none;
    }
    .typeahead-list.open { display: block; }
    .typeahead-item {
      padding: 9px 12px; cursor: pointer; font-size: 13px; color: #c0cdd8;
      border-bottom: 1px solid #2f4a60; transition: background .1s;
    }
    .typeahead-item:last-child { border-bottom: none; }
    .typeahead-item:hover, .typeahead-item.active { background: rgba(142,196,49,.15); color: #fff; }
    .typeahead-item mark { background: rgba(142,196,49,.35); color: #fff; border-radius: 4px; padding: 0 1px; }

    /* --- Lottie loading --- */
    .lottie-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px 20px;
      margin-bottom: 16px;
    }
    #lottie-player { width: 320px; height: 320px; }
    .loading-text { margin: 4px 0 0; font-size: 14px; color: #8a9bb0; text-align: center; line-height: 1.5; }
    .loading-text em { font-style: italic; }

    /* --- Progress bar --- */
    .progress-wrap { width: 320px; margin-top: 16px; text-align: center; }
    .progress-pct { font-size: 13px; font-weight: 700; color: #8a9bb0; margin-bottom: 6px; }
    .progress-track {
      width: 100%; height: 8px; background: #2f4a60; border-radius: 4px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; width: 0%; background: #8ec431; border-radius: 4px;
      transition: width .3s ease;
    }

    /* --- Brand subtitle --- */
    .brand-subtitle { font-size: 11px; color: #5a7a94; margin-top: 4px; }

    /* --- Fade-in animation --- */
    .fade-in {
      animation: fadeInUp .45s ease-out both;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* --- Section headers inside the result card --- */
    .section-title {
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px;
      color: #fff; border-bottom: 2px solid #8ec431; padding-bottom: 4px;
      margin: 18px 0 10px; grid-column: 1 / -1;
    }
    .section-title:first-child { margin-top: 0; }

    /* --- Document header row --- */
    .doc-header {
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 8px; margin-bottom: 14px;
    }
    .doc-header h2 { margin: 0; font-size: 18px; font-weight: 700; color: #fff; }
    .doc-header .doc-meta { font-size: 12px; color: #8aa3b8; }

    /* --- Copy toast --- */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #8ec431; color: #fff; padding: 10px 20px; border-radius: 4px;
      font-size: 13px; font-weight: 600; opacity: 0; transition: opacity .3s;
      pointer-events: none; z-index: 999;
    }
    .toast.show { opacity: 1; }

    /* --- Line items --- */
    .line-item-row {
      display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px;
      align-items: end; padding: 6px 0; border-bottom: 1px solid #2f4a60;
    }
    .line-item-row:last-child { border-bottom: none; }
    .line-item-row input { font-size: 13px; padding: 8px 10px; }
    .line-item-row .li-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #8aa3b8; margin-bottom: 2px; }
    .btn-remove {
      border: none; background: rgba(180,35,24,.2); color: #f87171; border-radius: 4px;
      padding: 8px 10px; cursor: pointer; font-weight: 700; font-size: 13px;
      font-family: 'Montserrat', sans-serif; transition: background .2s;
    }
    .btn-remove:hover { background: rgba(180,35,24,.35); }
    @media (max-width: 760px) {
      .grid { grid-template-columns: 1fr; }
      .line-item-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="https://i0.wp.com/wasteexperts.co.uk/wp-content/uploads/2022/11/green-grey-logo-1080.png?w=1920&amp;ssl=1" alt="Waste Experts logo" />
      <p class="brand-subtitle">Made with ðŸ’š by Marketing</p>
    </div>

    <div id="state-container">
    <!-- Upload card -->
    <div id="upload-card" class="card">
      <div class="head">Upload Purchase Order PDF</div>
      <div class="body">
        <div id="drop-zone" class="drop">
          <p><strong>Drop a PDF here</strong> or choose a file</p>
          <button class="btn" type="button" onclick="document.getElementById('file-input').click()">Choose PDF</button>
          <input id="file-input" type="file" accept=".pdf" class="hidden" />
          <p id="file-label" style="margin-top:8px; font-size:13px; color:#5a6e80;"></p>
        </div>
      </div>
    </div>

    <!-- Extracted data card (detached from DOM by JS on init) -->
    <div id="edit" class="card">
      <div class="head">Extracted Order Data</div>
      <div class="body">

        <!-- Reset button -->
        <div style="margin-bottom:14px;">
          <button class="btn-outline" type="button" onclick="resetToUpload()">&larr; Convert Another Purchase Order</button>
        </div>

        <!-- Document header -->
        <div class="doc-header">
          <h2 id="doc-title">Purchase Order</h2>
          <span class="doc-meta" id="doc-supplier-label"></span>
        </div>

        <div class="grid">

          <!-- ===== Supplier / Account ===== -->
          <div class="section-title">Supplier &amp; Reference</div>

          <div class="field full typeahead-wrap">
            <label for="account_name">Account Name</label>
            <input id="account_name" type="text" autocomplete="off" placeholder="Enter your supplier here..." />
            <div id="typeahead-dropdown" class="typeahead-list"></div>
            <div id="account-error" class="error hidden">Please choose a valid supplier from the list</div>
          </div>

          <div class="field">
            <label>Supplier (From)</label>
            <input id="supplier" type="text" />
          </div>
          <div class="field">
            <label>Purchase Order Number</label>
            <input id="purchase_order_number" type="text" />
          </div>

          <div class="field full">
            <label>Service / Product Description</label>
            <input id="service_description" type="text" placeholder="e.g. Corrugated Flo Tube Pipe - Exchange" />
          </div>

          <div class="field full">
            <label>Bill To (Representative Address)</label>
            <textarea id="supplier_address" placeholder="Supplier address will appear here"></textarea>
          </div>

          <div class="field">
            <label>Document Type</label>
            <select id="document_type" class="hl">
              <option>Consignment Note</option>
              <option>Waste Transfer Note</option>
            </select>
          </div>

          <!-- ===== Products & Services ===== -->
          <div class="section-title">Products &amp; Services</div>

          <div class="full" id="line-items-container">
            <!-- Line item rows are injected here by JS -->
          </div>

          <div class="full" style="display:flex; gap:10px; align-items:center; margin-bottom:4px;">
            <button class="btn-outline" type="button" onclick="addLineItem()">+ Add Line Item</button>
            <span style="margin-left:auto; font-weight:700; font-size:14px; color:#8ec431;">
              Overall Total: <span id="overall_total_display">Â£0.00</span>
            </span>
          </div>

          <!-- ===== Contact Info ===== -->
          <div class="section-title">Contact Information</div>

          <div class="field"><label>Site Contact</label><input id="site_contact" type="text" /></div>
          <div class="field"><label>Site Contact Number</label><input id="site_contact_number" type="text" /></div>
          <div class="field full"><label>Site Contact Email</label><input id="site_contact_email" type="email" /></div>

          <div class="field"><label>Secondary Site Contact</label><input id="secondary_site_contact" type="text" /></div>
          <div class="field"><label>Secondary Site Contact Number</label><input id="secondary_site_contact_number" type="text" /></div>
          <div class="field full"><label>Secondary Site Contact Email</label><input id="secondary_site_contact_email" type="email" /></div>

          <!-- ===== Site Info ===== -->
          <div class="section-title">Site Information</div>

          <div class="field"><label>Site Name</label><input id="site_name" type="text" /></div>
          <div class="field"><label>Site Postcode</label><input id="site_postcode" type="text" /></div>
          <div class="field full"><label>Site Address</label><textarea id="site_address"></textarea></div>

          <!-- ===== Instructions ===== -->
          <div class="section-title">Access &amp; Instructions</div>

          <div class="field"><label>Opening Times</label><textarea id="opening_times"></textarea></div>
          <div class="field"><label>Access</label><textarea id="access"></textarea></div>
          <div class="field"><label>Site Restrictions</label><textarea id="site_restrictions"></textarea></div>
          <div class="field"><label>Special Instructions</label><textarea id="special_instructions"></textarea></div>
        </div>

        <!-- Action bar -->
        <div style="margin-top:18px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="btn-download" class="btn" type="button" onclick="downloadReviewPDF()">Download PDF</button>
          <button class="btn" type="button" onclick="saveReview()">Save Review</button>
          <button class="btn-outline" type="button" onclick="copyAllToClipboard()">Copy All Data</button>
          <span class="pill">Extracted PDF includes selected note type</span>
          <span id="save-status" class="ok hidden">Review saved.</span>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <script>
    /* â”€â”€ Lottie animation data & setup â”€â”€ */
    const scanAnimation = {"v":"5.5.7","meta":{"g":"LottieFiles AE 0.1.20","a":"","k":"","d":"","tc":"#ffffff"},"fr":60,"ip":0,"op":227,"w":600,"h":600,"nm":"Artboard","ddd":0,"assets":[{"id":"comp_0","layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle Copy 10","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[274,400.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[128,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 3","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"Rectangle Copy 9","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[368.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[41,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 5","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"Rectangle Copy 8","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[348.5,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[81,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 4","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":4,"nm":"Rectangle Copy 7","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[249,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[78,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 2","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":4,"nm":"Rectangle Copy 6","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[270.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[121,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":6,"ty":4,"nm":"Rectangle 3","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[255,234.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[90,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":7,"ty":4,"nm":"Rectangle 2","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[299.89,304.75,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[245.78,319.5],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":19,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[1,1,1,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0}]},{"id":"comp_1","layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle Copy 3","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[274,400.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[128,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 3","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"Rectangle Copy 5","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[368.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[41,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 5","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"Rectangle Copy 4","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[348.5,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[81,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 4","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":4,"nm":"Rectangle Copy 2","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[249,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[78,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 2","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":4,"nm":"Rectangle Copy","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[270.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[121,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":6,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[255,234.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[90,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":7,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":60,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[299.89,304.75,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[245.78,319.5],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":19,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[1,1,1,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0}]}],"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.376,"y":1},"o":{"x":0.275,"y":0},"t":0,"s":[300,485.5,0],"to":[0,-60,0],"ti":[0,0,0]},{"i":{"x":0.725,"y":1},"o":{"x":0.632,"y":0},"t":110,"s":[300,125.5,0],"to":[0,0,0],"ti":[0,-60,0]},{"t":220,"s":[300,485.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,9],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":4.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.094117999077,0.439215987921,0.843137025833,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"bottom-grad","sr":1,"ks":{"o":{"a":1,"k":[{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":120,"s":[0]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":152,"s":[40]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":199,"s":[40]},{"t":218,"s":[0]}],"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.374,"y":1},"o":{"x":0.274,"y":0},"t":1,"s":[300,463.5,0],"to":[0,-52.833,0],"ti":[0,-7.167,0]},{"i":{"x":0.726,"y":1},"o":{"x":0.621,"y":0},"t":111,"s":[300,146.5,0],"to":[0,7.167,0],"ti":[0,-60,0]},{"t":221,"s":[300,506.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,-100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,45],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":0,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"gf","o":{"a":0,"k":100,"ix":10},"r":1,"bm":0,"g":{"p":3,"k":{"a":0,"k":[0,0.094,0.439,0.843,0.5,0.094,0.439,0.843,1,0.094,0.439,0.843,0,0,0.252,0.2,0.505,0.4,0.752,0.7,1,1],"ix":9}},"s":{"a":0,"k":[0,-22.5],"ix":5},"e":{"a":0,"k":[0,22.5],"ix":6},"t":1,"nm":"Gradient Fill 1","mn":"ADBE Vector Graphic - G-Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"top-grad","sr":1,"ks":{"o":{"a":1,"k":[{"i":{"x":[0.833],"y":[1]},"o":{"x":[0.167],"y":[0]},"t":0,"s":[0]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":14,"s":[40]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":89,"s":[40]},{"i":{"x":[0.833],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":108,"s":[0]},{"t":221,"s":[0]}],"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.376,"y":1},"o":{"x":0.271,"y":0},"t":1,"s":[300,463.5,0],"to":[0,-60,0],"ti":[0,0,0]},{"i":{"x":0.725,"y":1},"o":{"x":0.632,"y":0},"t":111,"s":[300,103.5,0],"to":[0,0,0],"ti":[0,-60,0]},{"t":221,"s":[300,463.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,45],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":0,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"gf","o":{"a":0,"k":100,"ix":10},"r":1,"bm":0,"g":{"p":3,"k":{"a":0,"k":[0,0.094,0.439,0.843,0.5,0.094,0.439,0.843,1,0.094,0.439,0.843,0,0,0.252,0.2,0.505,0.4,0.752,0.7,1,1],"ix":9}},"s":{"a":0,"k":[0,-22.5],"ix":5},"e":{"a":0,"k":[0,22.5],"ix":6},"t":1,"nm":"Gradient Fill 1","mn":"ADBE Vector Graphic - G-Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":0,"nm":"full","refId":"comp_0","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[300,300,0],"ix":2},"a":{"a":0,"k":[300,300,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"hasMask":true,"masksProperties":[{"inv":false,"mode":"i","pt":{"a":1,"k":[{"i":{"x":0.364,"y":1},"o":{"x":0.272,"y":0},"t":0,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,479.957],[448.801,479.957]],"c":true}]},{"i":{"x":0.73,"y":1},"o":{"x":0.631,"y":0},"t":110,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,129.957],[448.801,129.957]],"c":true}]},{"t":220,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,479.957],[448.801,479.957]],"c":true}]}],"ix":1},"o":{"a":0,"k":100,"ix":3},"x":{"a":0,"k":0,"ix":4},"nm":"Mask 1"}],"w":600,"h":600,"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":0,"nm":"trans","refId":"comp_1","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[300,300,0],"ix":2},"a":{"a":0,"k":[300,300,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"w":600,"h":600,"ip":0,"op":3600,"st":0,"bm":0}],"markers":[]};

    /* Replace all blue and green colors with grey #6B7280 (RGB 0.42, 0.447, 0.502) */
    (function recolorLottie(obj) {
      var GREY = [0.42, 0.447, 0.502];
      function isBlue(r, g, b) { return b > 0.5 && b > r * 2; }
      function isGreen(r, g, b) { return g > 0.5 && g > r * 1.2 && g > b * 1.2; }
      function shouldReplace(r, g, b) { return isBlue(r, g, b) || isGreen(r, g, b); }

      function walk(node) {
        if (Array.isArray(node)) { node.forEach(walk); return; }
        if (!node || typeof node !== 'object') return;

        /* Solid fill / stroke color */
        if ((node.ty === 'fl' || node.ty === 'st') && node.c) {
          var k = node.c.k;
          if (Array.isArray(k) && k.length >= 4 && typeof k[0] === 'number') {
            if (shouldReplace(k[0], k[1], k[2])) { k[0] = GREY[0]; k[1] = GREY[1]; k[2] = GREY[2]; }
          }
        }

        /* Gradient fill / stroke */
        if ((node.ty === 'gf' || node.ty === 'gs') && node.g) {
          var p = node.g.p;
          var gk = node.g.k;
          if (gk && gk.a === 0 && Array.isArray(gk.k)) {
            for (var i = 0; i < p; i++) {
              var base = i * 4;
              if (shouldReplace(gk.k[base + 1], gk.k[base + 2], gk.k[base + 3])) {
                gk.k[base + 1] = GREY[0]; gk.k[base + 2] = GREY[1]; gk.k[base + 3] = GREY[2];
              }
            }
          }
        }

        Object.keys(node).forEach(function(key) { walk(node[key]); });
      }

      walk(obj);
    })(scanAnimation);

    /* Lottie player â€” created fresh each scan, destroyed after */
    var lottieAnim = null;

    /* â”€â”€ Three-state flow: "upload" | "scanning" | "results" â”€â”€ */
    var appState = 'upload';

    /* â”€â”€ Broker data from Flask â”€â”€ */
    const BROKERS = {{ brokers_json|safe }};
    const brokerNames = BROKERS.map(b => b.name);
    const brokerAddressMap = Object.fromEntries(BROKERS.map(b => [b.name, b.address || '']));

    /* â”€â”€ DOM refs (cached before setState detaches elements) â”€â”€ */
    const stateContainer = document.getElementById('state-container');
    const uploadCard     = document.getElementById('upload-card');
    const editCard       = document.getElementById('edit');
    const fileInput      = document.getElementById('file-input');
    const dropZone       = document.getElementById('drop-zone');
    const accountInput   = document.getElementById('account_name');
    const dropdown       = document.getElementById('typeahead-dropdown');
    let activeIdx        = -1;

    /* â”€â”€ State management â”€â”€ */
    function setState(newState, filename) {
      /* Clean up scanning state */
      if (appState === 'scanning') {
        clearInterval(progressTimer);
        if (lottieAnim) { lottieAnim.destroy(); lottieAnim = null; }
      }

      /* Remove all children from container (detach, not destroy) */
      while (stateContainer.firstChild) {
        stateContainer.removeChild(stateContainer.firstChild);
      }

      appState = newState;

      if (newState === 'upload') {
        fileInput.value = '';
        stateContainer.appendChild(uploadCard);

      } else if (newState === 'scanning') {
        /* Build scanning section dynamically */
        var section = document.createElement('div');
        section.className = 'lottie-loading';
        var safeName = (filename || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        section.innerHTML =
          '<div id="lottie-player"></div>' +
          '<p class="loading-text">We\'re attempting to read <em>' + safeName + '</em>. Hold tight!</p>' +
          '<div class="progress-wrap">' +
            '<div class="progress-pct" id="progress-pct">0%</div>' +
            '<div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>' +
          '</div>';
        stateContainer.appendChild(section);

        /* Init Lottie */
        lottieAnim = lottie.loadAnimation({
          container: document.getElementById('lottie-player'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          animationData: JSON.parse(JSON.stringify(scanAnimation))
        });
        startProgress();

      } else if (newState === 'results') {
        editCard.classList.remove('fade-in');
        stateContainer.appendChild(editCard);
      }
    }

    /* â”€â”€ Reset back to upload state â”€â”€ */
    function resetToUpload() {
      /* Clear all form fields while edit card is still in DOM */
      [
        'supplier', 'purchase_order_number', 'service_description',
        'site_contact', 'site_contact_number', 'site_contact_email',
        'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
        'site_name', 'site_address', 'site_postcode',
        'opening_times', 'access', 'site_restrictions', 'special_instructions',
        'account_name', 'supplier_address'
      ].forEach(function(key) { setField(key, ''); });
      setField('document_type', 'Consignment Note');
      clearLineItems();
      document.getElementById('doc-title').textContent = 'Purchase Order';
      document.getElementById('doc-supplier-label').textContent = '';
      document.getElementById('account-error').classList.add('hidden');
      document.getElementById('save-status').classList.add('hidden');
      dropdown.classList.remove('open');

      setState('upload');
    }

    /* â”€â”€ Helpers â”€â”€ */
    function setField(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value || '';
    }
    function getField(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    }

    /* â”€â”€ Typeahead dropdown â”€â”€ */
    function renderDropdown(term) {
      const q = (term || '').trim().toLowerCase();
      let matches = brokerNames;
      if (q) {
        matches = brokerNames.filter(name => name.toLowerCase().includes(q));
      }
      matches = matches.slice(0, 40);
      activeIdx = -1;

      if (matches.length === 0) {
        dropdown.innerHTML = '<div class="typeahead-item" style="color:#8a9bb0; cursor:default;">No matching suppliers</div>';
        dropdown.classList.add('open');
        return;
      }

      dropdown.innerHTML = matches.map((name, i) => {
        let display = name;
        if (q) {
          const idx = name.toLowerCase().indexOf(q);
          if (idx !== -1) {
            display = name.substring(0, idx)
              + '<mark>' + name.substring(idx, idx + q.length) + '</mark>'
              + name.substring(idx + q.length);
          }
        }
        return `<div class="typeahead-item" data-index="${i}" data-value="${name}">${display}</div>`;
      }).join('');

      dropdown.classList.add('open');
    }

    function closeDropdown() {
      setTimeout(() => {
        dropdown.classList.remove('open');
        activeIdx = -1;
      }, 150);
    }

    function selectSupplier(name) {
      accountInput.value = name;
      dropdown.classList.remove('open');
      updateSupplierAddress();
      validateAccount();
    }

    dropdown.addEventListener('mousedown', e => {
      const item = e.target.closest('.typeahead-item');
      if (item && item.dataset.value) {
        e.preventDefault();
        selectSupplier(item.dataset.value);
      }
    });

    accountInput.addEventListener('focus', () => renderDropdown(accountInput.value));
    accountInput.addEventListener('input', () => {
      renderDropdown(accountInput.value);
      updateSupplierAddress();
      validateAccount();
    });
    accountInput.addEventListener('blur', closeDropdown);
    accountInput.addEventListener('keydown', e => {
      const items = dropdown.querySelectorAll('.typeahead-item[data-value]');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIdx = Math.min(activeIdx + 1, items.length - 1);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
        items[activeIdx].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIdx = Math.max(activeIdx - 1, 0);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
        items[activeIdx].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (activeIdx >= 0 && activeIdx < items.length) {
          selectSupplier(items[activeIdx].dataset.value);
        }
      } else if (e.key === 'Escape') {
        dropdown.classList.remove('open');
      }
    });

    /* â”€â”€ Smart supplier address lookup (exact â†’ case-insensitive â†’ partial) â”€â”€ */
    function lookupSupplierAddress(name) {
      if (!name) return '';

      /* 1. Exact match */
      if (brokerAddressMap[name]) return brokerAddressMap[name];

      var nameLower = name.trim().toLowerCase();

      /* 2. Case-insensitive match */
      for (var key in brokerAddressMap) {
        if (key.toLowerCase() === nameLower) return brokerAddressMap[key];
      }

      /* 3. Partial match â€” input is substring of a key, or key is substring of input */
      var best = '';
      var bestLen = 0;
      for (var key in brokerAddressMap) {
        if (!brokerAddressMap[key]) continue;
        var keyLower = key.toLowerCase();
        if (keyLower.includes(nameLower) || nameLower.includes(keyLower)) {
          /* Prefer longest matching key (most specific) */
          if (key.length > bestLen) {
            best = brokerAddressMap[key];
            bestLen = key.length;
          }
        }
      }

      return best;
    }

    /* â”€â”€ Address / validation â”€â”€ */
    function updateSupplierAddress() {
      const account = getField('account_name');
      const current = getField('supplier_address');
      const suggested = lookupSupplierAddress(account);
      if (!current || current === suggested || brokerNames.includes(account)) {
        setField('supplier_address', suggested);
      }
    }

    function validateAccount() {
      const account = getField('account_name');
      const valid = brokerNames.includes(account);
      document.getElementById('account-error').classList.toggle('hidden', valid);
      if (!valid) {
        document.getElementById('supplier_address').value = '';
      }
      return valid;
    }

    /* â”€â”€ Line items â”€â”€ */
    let lineItemCounter = 0;

    function addLineItem(desc, qty, unitPrice, lineTotal) {
      const container = document.getElementById('line-items-container');
      const idx = lineItemCounter++;
      const row = document.createElement('div');
      row.className = 'line-item-row';
      row.dataset.liIdx = idx;
      row.innerHTML = `
        <div><div class="li-label">Description</div><input type="text" class="li-desc" value="${(desc || '').replace(/"/g, '&quot;')}" /></div>
        <div><div class="li-label">Quantity</div><input type="number" class="li-qty" value="${qty || 1}" min="0" step="1" onchange="recalcLineItem(this)" /></div>
        <div><div class="li-label">Price / Unit</div><input type="number" class="li-unit" value="${unitPrice || 0}" min="0" step="0.01" onchange="recalcLineItem(this)" /></div>
        <div><div class="li-label">Line Total</div><input type="number" class="li-total" value="${lineTotal || 0}" min="0" step="0.01" onchange="recalcOverallTotal()" /></div>
        <div style="padding-bottom:1px;"><button class="btn-remove" type="button" onclick="removeLineItem(this)">&times;</button></div>
      `;
      container.appendChild(row);
      recalcOverallTotal();
    }

    function removeLineItem(btn) {
      btn.closest('.line-item-row').remove();
      recalcOverallTotal();
    }

    function recalcLineItem(input) {
      const row = input.closest('.line-item-row');
      const qty = parseFloat(row.querySelector('.li-qty').value) || 0;
      const unit = parseFloat(row.querySelector('.li-unit').value) || 0;
      row.querySelector('.li-total').value = (qty * unit).toFixed(2);
      recalcOverallTotal();
    }

    function recalcOverallTotal() {
      let total = 0;
      document.querySelectorAll('.line-item-row').forEach(row => {
        total += parseFloat(row.querySelector('.li-total').value) || 0;
      });
      document.getElementById('overall_total_display').textContent = 'Â£' + total.toFixed(2);
    }

    function getLineItems() {
      const items = [];
      document.querySelectorAll('.line-item-row').forEach(row => {
        items.push({
          description: row.querySelector('.li-desc').value.trim(),
          quantity: parseFloat(row.querySelector('.li-qty').value) || 1,
          unit_price: parseFloat(row.querySelector('.li-unit').value) || 0,
          line_total: parseFloat(row.querySelector('.li-total').value) || 0
        });
      });
      return items;
    }

    function clearLineItems() {
      document.getElementById('line-items-container').innerHTML = '';
      lineItemCounter = 0;
      recalcOverallTotal();
    }

    /* â”€â”€ Fill form from extraction response â”€â”€ */
    function fillForm(data) {
      [
        'supplier', 'purchase_order_number', 'service_description',
        'site_contact', 'site_contact_number', 'site_contact_email',
        'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
        'site_name', 'site_address', 'site_postcode',
        'opening_times', 'access', 'site_restrictions', 'special_instructions'
      ].forEach(key => setField(key, data[key]));

      /* Account name left blank â€” user must select via typeahead */
      setField('account_name', '');

      const docType = data.document_type === 'Waste Transfer Note' ? 'Waste Transfer Note' : 'Consignment Note';
      setField('document_type', docType);

      /* Update document header */
      const supplierName = data.supplier || 'Unknown Supplier';
      const poNum = data.purchase_order_number || '';
      document.getElementById('doc-title').textContent = 'Purchase Order' + (poNum ? ' â€” ' + poNum : '');
      document.getElementById('doc-supplier-label').textContent = 'From: ' + supplierName;

      setField('supplier_address', '');
      validateAccount();

      /* Populate line items */
      clearLineItems();
      const items = data.line_items || [];
      items.forEach(item => {
        addLineItem(item.description, item.quantity, item.unit_price, item.line_total);
      });
    }

    /* â”€â”€ Collect payload â”€â”€ */
    function collectReviewPayload() {
      const items = getLineItems();
      const overallTotal = items.reduce((sum, i) => sum + (i.line_total || 0), 0);
      return {
        account_name: getField('account_name'),
        supplier_address: getField('supplier_address'),
        purchase_order_number: getField('purchase_order_number'),
        service_description: getField('service_description'),
        document_type: getField('document_type'),
        site_contact: getField('site_contact'),
        site_contact_number: getField('site_contact_number'),
        site_contact_email: getField('site_contact_email'),
        secondary_site_contact: getField('secondary_site_contact'),
        secondary_site_contact_number: getField('secondary_site_contact_number'),
        secondary_site_contact_email: getField('secondary_site_contact_email'),
        site_name: getField('site_name'),
        site_address: getField('site_address'),
        site_postcode: getField('site_postcode'),
        opening_times: getField('opening_times'),
        access: getField('access'),
        site_restrictions: getField('site_restrictions'),
        special_instructions: getField('special_instructions'),
        line_items: items,
        overall_total: overallTotal
      };
    }

    /* â”€â”€ Download PDF â”€â”€ */
    async function downloadReviewPDF() {
      if (!validateAccount()) return;
      const btn = document.getElementById('btn-download');
      const origText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Generating PDFâ€¦';
      const payload = collectReviewPayload();
      try {
        const resp = await fetch('/download-review-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ error: 'Unable to download PDF' }));
          throw new Error(err.error || 'Unable to download PDF');
        }
        const blob = await resp.blob();
        if (blob.size === 0) throw new Error('Received empty PDF â€” please try again');
        const disposition = resp.headers.get('Content-Disposition') || '';
        const match = disposition.match(/filename[^;=\n]*=\s*(?:UTF-8''|"?)([^";\n]+)/i);
        const filename = match ? decodeURIComponent(match[1].replace(/"/g, '')) : 'review.pdf';
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 2000);
        showToast('PDF downloaded successfully');
      } catch (err) { alert(err.message); }
      finally { btn.disabled = false; btn.textContent = origText; }
    }

    /* â”€â”€ Save review â”€â”€ */
    async function saveReview() {
      if (!validateAccount()) return;
      const status = document.getElementById('save-status');
      status.classList.add('hidden');
      const payload = collectReviewPayload();
      try {
        const resp = await fetch('/save-review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if (!resp.ok || json.error) throw new Error(json.error || 'Unable to save review');
        window.lastReviewedPayload = json.data || payload;
        status.textContent = json.message || 'Review saved.';
        status.classList.remove('hidden');
        setTimeout(() => status.classList.add('hidden'), 2500);
      } catch (err) { alert(err.message); }
    }

    /* â”€â”€ Copy all data to clipboard â”€â”€ */
    function copyAllToClipboard() {
      const payload = collectReviewPayload();
      const labels = {
        account_name: 'Account Name',
        supplier_address: 'Bill To Address',
        purchase_order_number: 'Purchase Order Number',
        service_description: 'Service Description',
        document_type: 'Document Type',
        site_contact: 'Site Contact',
        site_contact_number: 'Site Contact Number',
        site_contact_email: 'Site Contact Email',
        secondary_site_contact: 'Secondary Site Contact',
        secondary_site_contact_number: 'Secondary Site Contact Number',
        secondary_site_contact_email: 'Secondary Site Contact Email',
        site_name: 'Site Name',
        site_address: 'Site Address',
        site_postcode: 'Site Postcode',
        opening_times: 'Opening Times',
        access: 'Access',
        site_restrictions: 'Site Restrictions',
        special_instructions: 'Special Instructions'
      };
      let text = Object.entries(labels)
        .map(([key, label]) => `${label}: ${payload[key] || '-'}`)
        .join('\n');

      /* Append line items */
      const items = payload.line_items || [];
      if (items.length) {
        text += '\n\nProducts & Services:';
        items.forEach((item, i) => {
          text += `\n  ${i + 1}. ${item.description || '-'} | Qty: ${item.quantity} | Unit: Â£${(item.unit_price || 0).toFixed(2)} | Total: Â£${(item.line_total || 0).toFixed(2)}`;
        });
        text += `\nOverall Total: Â£${(payload.overall_total || 0).toFixed(2)}`;
      }

      navigator.clipboard.writeText(text).then(() => {
        showToast('All data copied to clipboard');
      }).catch(() => {
        /* Fallback for older browsers */
        const ta = document.createElement('textarea');
        ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('All data copied to clipboard');
      });
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    /* â”€â”€ Progress bar helpers â”€â”€ */
    var progressTimer = null;
    var currentProgress = 0;

    function startProgress() {
      currentProgress = 0;
      updateProgressUI(0);
      progressTimer = setInterval(function() {
        /* Ease towards 90% â€” slows as it approaches */
        var remaining = 90 - currentProgress;
        currentProgress += remaining * 0.03;
        if (currentProgress > 89.5) currentProgress = 90;
        updateProgressUI(currentProgress);
        if (currentProgress >= 90) clearInterval(progressTimer);
      }, 200);
    }

    function finishProgress() {
      clearInterval(progressTimer);
      currentProgress = 100;
      updateProgressUI(100);
    }

    function resetProgress() {
      clearInterval(progressTimer);
      currentProgress = 0;
      updateProgressUI(0);
    }

    function updateProgressUI(pct) {
      var rounded = Math.round(pct);
      var pctEl = document.getElementById('progress-pct');
      var fillEl = document.getElementById('progress-fill');
      if (pctEl) pctEl.textContent = rounded + '%';
      if (fillEl) fillEl.style.width = rounded + '%';
    }

    /* â”€â”€ Upload & extract â”€â”€ */
    async function uploadAndExtract(file) {
      /* Transition to scanning state (removes upload card, shows animation) */
      setState('scanning', file.name);

      const fd = new FormData();
      fd.append('pdf', file);

      try {
        const resp = await fetch('/extract', { method: 'POST', body: fd });
        const json = await resp.json();
        if (!resp.ok || json.error) throw new Error(json.error || 'Extraction failed');

        /* Jump progress to 100% */
        finishProgress();

        /* Brief delay so user sees 100% before transition (~500ms) */
        await new Promise(function(r) { setTimeout(r, 500); });

        /* Transition to results state (removes scanning, shows edit card) */
        setState('results');
        fillForm(json.data || {});
        requestAnimationFrame(function() { editCard.classList.add('fade-in'); });
      } catch (err) {
        alert(err.message);
        setState('upload');
      }
    }

    /* â”€â”€ Drag & drop â”€â”€ */
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.pdf')) uploadAndExtract(file);
    });
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) uploadAndExtract(file);
    });

    /* â”€â”€ Initialize: show only upload state â”€â”€ */
    setState('upload');
  </script>
</body>
</html>
