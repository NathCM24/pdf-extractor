<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Extractor - Waste Logics</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f7fb; color: #1e2e3d; }
    .wrap { max-width: 980px; margin: 24px auto 48px; padding: 0 16px; }
    .brand { text-align: center; margin: 6px 0 18px; }
    .brand img { max-width: 320px; width: 100%; height: auto; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.08); margin-bottom: 16px; }
    .head { background: #1e2e3d; color: #fff; padding: 16px 20px; border-radius: 8px 8px 0 0; font-weight: 700; }
    .body { padding: 16px 20px; }
    .drop { border: 2px dashed #cfd8e3; border-radius: 8px; padding: 28px; text-align: center; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .full { grid-column: 1 / -1; }
    label { font-size: 12px; font-weight: 700; text-transform: uppercase; }
    input, textarea, select { border: 1px solid #ccd6e2; border-radius: 6px; padding: 10px; font-size: 14px; }
    textarea { min-height: 64px; resize: vertical; }
    .hidden { display: none; }
    .error { color: #b42318; font-weight: 700; margin-top: 4px; }
    .ok { color: #246d19; font-weight: 700; margin-top: 4px; }
    .btn { border: none; background: #8ec431; color: #fff; border-radius: 6px; padding: 10px 16px; font-weight: 700; cursor: pointer; }
    .pill { display:inline-block; background:#f0f8e0; color:#3f5f08; border:1px solid #8ec431; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
    .hl { border: 2px solid #8ec431; box-shadow: 0 0 0 2px #f0f8e0 inset; }
    @media (max-width: 760px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="https://i0.wp.com/wasteexperts.co.uk/wp-content/uploads/2022/11/green-grey-logo-1080.png?w=1920&amp;ssl=1" alt="Waste Experts logo" />
    </div>

    <div class="card">
      <div class="head">Upload Purchase Order PDF</div>
      <div class="body">
        <div id="drop-zone" class="drop">
          <p><strong>Drop a PDF here</strong> or choose a file</p>
          <button class="btn" type="button" onclick="document.getElementById('file-input').click()">Choose PDF</button>
          <input id="file-input" type="file" accept=".pdf" class="hidden" />
          <p id="file-label"></p>
        </div>
      </div>
    </div>

    <div id="loading" class="card hidden">
      <div class="body">Extracting data from PDFâ€¦</div>
    </div>

    <div id="edit" class="card hidden">
      <div class="head">Review &amp; Edit Extracted Data</div>
      <div class="body">
        <div class="grid">
          <div class="field full">
            <label for="account_name">Account Name (Waste Logics)</label>
            <input id="account_name" list="account-list" autocomplete="off" placeholder="Start typing account name..." />
            <datalist id="account-list"></datalist>
            <div id="account-error" class="error hidden">Please choose supplier</div>
          </div>

          <div class="field full">
            <label>Bill To (Representative Address)</label>
            <textarea id="supplier_address" readonly placeholder="Supplier address will appear here"></textarea>
          </div>

          <div class="field">
            <label>Purchase order number</label>
            <input id="purchase_order_number" type="text" />
          </div>
          <div class="field">
            <label>Document Type</label>
            <select id="document_type" class="hl">
              <option>Consignment Note</option>
              <option>Waste Transfer Note</option>
            </select>
          </div>

          <div class="field"><label>Site contact</label><input id="site_contact" type="text" /></div>
          <div class="field"><label>Site contact number</label><input id="site_contact_number" type="text" /></div>
          <div class="field full"><label>Site contact email</label><input id="site_contact_email" type="email" /></div>

          <div class="field"><label>Secondary site contact</label><input id="secondary_site_contact" type="text" /></div>
          <div class="field"><label>Secondary site contact number</label><input id="secondary_site_contact_number" type="text" /></div>
          <div class="field full"><label>Secondary site contact email</label><input id="secondary_site_contact_email" type="email" /></div>

          <div class="field"><label>Site name</label><input id="site_name" type="text" /></div>
          <div class="field"><label>Site postcode</label><input id="site_postcode" type="text" /></div>
          <div class="field full"><label>Site address</label><textarea id="site_address"></textarea></div>

          <div class="field"><label>Opening times</label><textarea id="opening_times"></textarea></div>
          <div class="field"><label>Access</label><textarea id="access"></textarea></div>
          <div class="field"><label>Site restrictions</label><textarea id="site_restrictions"></textarea></div>
          <div class="field"><label>Special instructions</label><textarea id="special_instructions"></textarea></div>
        </div>

        <div style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
          <button class="btn" type="button" onclick="saveReview()">Save Review</button>
          <span class="pill">Extracted PDF includes selected note type</span>
          <span id="save-status" class="ok hidden">Review saved.</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BROKERS = {{ brokers_json|safe }};
    const brokerNames = BROKERS.map(b => b.name);
    const brokerAddressMap = Object.fromEntries(BROKERS.map(b => [b.name, b.address || '']));

    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');

    function renderAccountOptions(term = '') {
      const list = document.getElementById('account-list');
      const q = term.trim().toLowerCase();
      const matches = brokerNames.filter(name => name.toLowerCase().startsWith(q));
      const options = (q ? matches : brokerNames).slice(0, 50);
      list.innerHTML = options.map(name => `<option value="${name}"></option>`).join('');
    }

    function setField(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value || '';
    }

    function getField(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    }

    function fillForm(data) {
      const extractedAccount = data.account_name || data.supplier || '';
      [
        'purchase_order_number','site_contact','site_contact_number','site_contact_email',
        'secondary_site_contact','secondary_site_contact_number','secondary_site_contact_email',
        'site_name','site_address','site_postcode','opening_times','access','site_restrictions','special_instructions'
      ].forEach(key => setField(key, data[key]));

      setField('account_name', extractedAccount);
      const docType = data.document_type === 'Waste Transfer Note' ? 'Waste Transfer Note' : 'Consignment Note';
      setField('document_type', docType);
      updateSupplierAddress();
      validateAccount();
    }

    function updateSupplierAddress() {
      const account = getField('account_name');
      setField('supplier_address', brokerAddressMap[account] || '');
    }

    function validateAccount() {
      const account = getField('account_name');
      const valid = brokerNames.includes(account);
      document.getElementById('account-error').classList.toggle('hidden', valid);
      if (!valid) {
        document.getElementById('supplier_address').value = '';
      }
      return valid;
    }

    function collectReviewPayload() {
      return {
        account_name: getField('account_name'),
        supplier_address: getField('supplier_address'),
        purchase_order_number: getField('purchase_order_number'),
        document_type: getField('document_type'),
        site_contact: getField('site_contact'),
        site_contact_number: getField('site_contact_number'),
        site_contact_email: getField('site_contact_email'),
        secondary_site_contact: getField('secondary_site_contact'),
        secondary_site_contact_number: getField('secondary_site_contact_number'),
        secondary_site_contact_email: getField('secondary_site_contact_email'),
        site_name: getField('site_name'),
        site_address: getField('site_address'),
        site_postcode: getField('site_postcode'),
        opening_times: getField('opening_times'),
        access: getField('access'),
        site_restrictions: getField('site_restrictions'),
        special_instructions: getField('special_instructions')
      };
    }

    function saveReview() {
      const valid = validateAccount();
      const status = document.getElementById('save-status');
      status.classList.add('hidden');
      if (!valid) return;
      const payload = collectReviewPayload();
      window.lastReviewedPayload = payload;
      status.textContent = 'Review saved.';
      status.classList.remove('hidden');
      setTimeout(() => status.classList.add('hidden'), 2500);
    }

    async function uploadAndExtract(file) {
      document.getElementById('file-label').textContent = file.name;
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('edit').classList.add('hidden');

      const fd = new FormData();
      fd.append('pdf', file);

      try {
        const resp = await fetch('/extract', { method: 'POST', body: fd });
        const json = await resp.json();
        if (!resp.ok || json.error) throw new Error(json.error || 'Extraction failed');
        fillForm(json.data || {});
        document.getElementById('edit').classList.remove('hidden');
      } catch (err) {
        alert(err.message);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    dropZone.addEventListener('dragover', e => { e.preventDefault(); });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.pdf')) uploadAndExtract(file);
    });
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) uploadAndExtract(file);
    });

    const accountInput = document.getElementById('account_name');
    accountInput.addEventListener('focus', () => renderAccountOptions(accountInput.value));
    accountInput.addEventListener('input', () => {
      renderAccountOptions(accountInput.value);
      updateSupplierAddress();
      validateAccount();
    });
    accountInput.addEventListener('change', () => {
      updateSupplierAddress();
      validateAccount();
    });

    renderAccountOptions('');
  </script>
</body>
</html>
