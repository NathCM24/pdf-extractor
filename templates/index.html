<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Waste Experts PDF Extractor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Montserrat', sans-serif; margin: 0; background: #1e2e3d; color: #e8ecf1; }
    .wrap { max-width: 980px; margin: 24px auto 48px; padding: 0 16px; position: relative; }
    .brand { text-align: center; margin: 6px 0 18px; }
    .brand img { max-width: 224px; width: 100%; height: auto; }

    /* --- Cards --- */
    .card { background: #253a4d; border-radius: 4px; box-shadow: 0 2px 12px rgba(0,0,0,.25); margin-bottom: 16px; border: 1px solid #2f4a60; }
    .head { background: #8ec431; color: #fff; padding: 16px 20px; border-radius: 4px 4px 0 0; font-weight: 700; font-size: 15px; }
    .body { padding: 16px 20px; }

    /* --- Drop zone --- */
    .drop { border: 2px dashed #3d5a73; border-radius: 4px; padding: 28px; text-align: center; transition: border-color .2s, background .2s; }
    .drop.drag-over { border-color: #8ec431; background: rgba(142,196,49,.1); }
    .drop p { margin: 0 0 10px; color: #c0cdd8; }

    /* --- Grid / fields --- */
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .field { display: flex; flex-direction: column; gap: 4px; position: relative; }
    .full { grid-column: 1 / -1; }
    label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; color: #8ec431; }
    input, textarea, select {
      border: 1px solid #3d5a73; border-radius: 4px; padding: 10px 12px;
      font-size: 14px; font-family: 'Montserrat', sans-serif;
      background: #1e2e3d; color: #e8ecf1; transition: border-color .2s, box-shadow .2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: #8ec431; box-shadow: 0 0 0 2px rgba(142,196,49,.2);
    }
    input::placeholder, textarea::placeholder { color: #5a7a94; }
    textarea { min-height: 64px; resize: vertical; }
    select option { background: #1e2e3d; color: #e8ecf1; }
    .hidden { display: none; }
    .error { color: #f87171; font-weight: 700; margin-top: 4px; font-size: 12px; }
    .ok { color: #8ec431; font-weight: 700; margin-top: 4px; font-size: 13px; }

    /* --- Buttons --- */
    .btn {
      border: none; background: #8ec431; color: #fff; border-radius: 4px;
      padding: 10px 18px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 13px;
      transition: background .2s;
    }
    .btn:hover { background: #7ab328; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-outline {
      border: 1px solid #8ec431; background: transparent; color: #8ec431;
      border-radius: 4px; padding: 10px 18px; font-weight: 700;
      cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 13px;
      transition: background .2s, color .2s;
    }
    .btn-outline:hover { background: rgba(142,196,49,.15); color: #a5d84e; }
    .btn-debug {
      border: 1px solid #4b5563; background: #374151; color: #9CA3AF;
      border-radius: 4px; padding: 6px 12px; font-weight: 600;
      cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 11px;
      transition: background .2s;
    }
    .btn-debug:hover { background: #4b5563; }
    .pill { display: inline-block; background: rgba(142,196,49,.15); color: #8ec431; border: 1px solid #8ec431; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700; }
    .hl { border: 2px solid #8ec431; box-shadow: 0 0 0 2px rgba(142,196,49,.15) inset; }

    /* --- Typeahead dropdown --- */
    .typeahead-wrap { position: relative; }
    .typeahead-list {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      max-height: 220px; overflow-y: auto;
      background: #253a4d; border: 1px solid #3d5a73; border-radius: 4px;
      box-shadow: 0 6px 20px rgba(0,0,0,.35);
      display: none;
    }
    .typeahead-list.open { display: block; }
    .typeahead-item {
      padding: 9px 12px; cursor: pointer; font-size: 13px; color: #c0cdd8;
      border-bottom: 1px solid #2f4a60; transition: background .1s;
    }
    .typeahead-item:last-child { border-bottom: none; }
    .typeahead-item:hover, .typeahead-item.active { background: rgba(142,196,49,.15); color: #fff; }
    .typeahead-item mark { background: rgba(142,196,49,.35); color: #fff; border-radius: 4px; padding: 0 1px; }

    /* --- Lottie loading --- */
    .lottie-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px 20px;
      margin-bottom: 16px;
    }
    #lottie-player, #cef-lottie-player { width: 320px; height: 320px; }
    .loading-text { margin: 4px 0 0; font-size: 14px; color: #8a9bb0; text-align: center; line-height: 1.5; }
    .loading-text em { font-style: italic; }

    /* --- Progress bar --- */
    .progress-wrap { width: 320px; margin-top: 16px; text-align: center; }
    .progress-pct { font-size: 13px; font-weight: 700; color: #8a9bb0; margin-bottom: 6px; }
    .progress-track {
      width: 100%; height: 8px; background: #2f4a60; border-radius: 4px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; width: 0%; background: #8ec431; border-radius: 4px;
      transition: width .3s ease;
    }

    /* --- Brand subtitle --- */
    .brand-subtitle { font-size: 11px; color: #5a7a94; margin-top: 6px; }
    .brand-title { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 28px; color: #e8ecf1; text-align: center; margin: 14px 0 4px; letter-spacing: -.3px; }

    /* --- Fade-in animation --- */
    .fade-in {
      animation: fadeInUp .45s ease-out both;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* --- Section headers inside the result card --- */
    .section-title {
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px;
      color: #fff; border-bottom: 2px solid #5a7a94; padding-bottom: 4px;
      margin: 18px 0 10px; grid-column: 1 / -1;
    }
    .section-title:first-child { margin-top: 0; }

    /* --- Document header row --- */
    .doc-header {
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 8px; margin-bottom: 14px;
    }
    .doc-header h2 { margin: 0; font-size: 18px; font-weight: 700; color: #fff; }
    .doc-header .doc-meta { font-size: 12px; color: #8aa3b8; }

    /* --- HubSpot button --- */
    .btn-hubspot {
      border: none; background: #ff7a59; color: #fff; border-radius: 4px;
      padding: 10px 18px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 13px;
      transition: background .2s; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-hubspot:hover { background: #e56a4a; }
    .btn-hubspot:disabled { opacity: .6; cursor: not-allowed; }
    .btn-hubspot svg { width: 18px; height: 18px; flex-shrink: 0; }

    /* --- HubSpot modal overlay --- */
    .hs-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 900;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn .2s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .hs-modal {
      background: #253a4d; border: 1px solid #2f4a60; border-radius: 4px;
      width: 600px; max-width: 94vw; max-height: 85vh; overflow-y: auto;
      box-shadow: 0 8px 40px rgba(0,0,0,.5);
    }
    .hs-modal-head {
      background: #ff7a59; color: #fff; padding: 14px 20px; border-radius: 4px 4px 0 0;
      font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 10px;
    }
    .hs-modal-body { padding: 20px; }
    .hs-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2f4a60; font-size: 13px; }
    .hs-row:last-child { border-bottom: none; }
    .hs-label { color: #8aa3b8; font-weight: 600; min-width: 140px; }
    .hs-value { color: #e8ecf1; text-align: right; word-break: break-word; }
    .hs-section { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: #ff7a59; margin: 16px 0 6px; padding-bottom: 4px; border-bottom: 1px solid #3d5a73; }
    .hs-section:first-child { margin-top: 0; }
    .hs-li-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 6px; }
    .hs-li-table th { text-align: left; color: #8aa3b8; font-weight: 600; padding: 4px 6px; border-bottom: 1px solid #3d5a73; }
    .hs-li-table td { padding: 4px 6px; color: #c0cdd8; border-bottom: 1px solid #2f4a60; }
    .hs-li-table td:last-child { text-align: right; }
    .hs-actions { display: flex; gap: 10px; margin-top: 18px; justify-content: flex-end; }
    .hs-match { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; }
    .hs-match.found { color: #8ec431; }
    .hs-match.not-found { color: #8aa3b8; }

    /* --- HubSpot banner --- */
    .hs-banner {
      padding: 12px 16px; border-radius: 4px; font-size: 13px; font-weight: 600;
      margin-top: 12px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    .hs-banner.success { background: rgba(142,196,49,.15); color: #8ec431; border: 1px solid #8ec431; }
    .hs-banner.error { background: rgba(248,113,113,.12); color: #f87171; border: 1px solid rgba(248,113,113,.3); }
    .hs-banner a { color: inherit; text-decoration: underline; }
    .hs-banner .hs-banner-close { margin-left: auto; cursor: pointer; opacity: .7; }
    .hs-banner .hs-banner-close:hover { opacity: 1; }

    /* --- Persistent settings gear icon (always visible) --- */
    .persistent-gear {
      position: absolute; top: 10px; right: 16px; z-index: 100;
      background: none; border: none; padding: 4px; cursor: pointer;
      display: flex; align-items: center;
      color: #5a7a94; transition: opacity .2s, transform .3s;
    }
    .persistent-gear:hover { opacity: .7; transform: rotate(45deg); }
    .persistent-gear svg { width: 22px; height: 22px; }

    /* --- Top navigation bar (matches detail card) --- */
    .top-nav {
      background: #253a4d; border: 1px solid #2f4a60; border-radius: 4px;
      box-shadow: 0 2px 12px rgba(0,0,0,.25); padding: 0 20px;
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px; min-height: 48px;
    }
    .nav-btn {
      background: none; border: none; cursor: pointer; padding: 12px 4px;
      display: inline-flex; align-items: center; gap: 6px;
      font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 600;
      color: #c0cdd8; transition: opacity .2s;
    }
    .nav-btn:hover { opacity: .7; }
    .nav-btn svg { width: 16px; height: 16px; flex-shrink: 0; }
    .nav-btn.nav-hidden { visibility: hidden; pointer-events: none; }

    /* --- Settings modal overlay --- */
    .settings-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 900;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn .2s ease-out;
    }
    .settings-modal {
      background: #253a4d; border: 1px solid #2f4a60; border-radius: 4px;
      width: 650px; max-width: 94vw; max-height: 80vh; overflow-y: auto;
      box-shadow: 0 8px 40px rgba(0,0,0,.5); position: relative;
    }
    .settings-modal-head {
      background: #3d5a73; color: #fff; padding: 14px 20px; border-radius: 4px 4px 0 0;
      font-weight: 700; font-size: 15px; display: flex; align-items: center; justify-content: space-between;
    }
    .settings-modal-head .close-x { cursor: pointer; font-size: 20px; opacity: .8; background: none; border: none; color: #fff; padding: 0 2px; }
    .settings-modal-head .close-x:hover { opacity: 1; }
    .settings-modal-body { padding: 20px; }

    /* --- Collapsible section --- */
    .collapsible-header {
      display: flex; align-items: center; gap: 8px; cursor: pointer;
      padding: 12px 0; user-select: none;
    }
    .collapsible-header h3 {
      margin: 0; font-size: 13px; font-weight: 700; text-transform: uppercase;
      letter-spacing: .5px; color: #c0cdd8;
    }
    .collapsible-chevron {
      font-size: 12px; color: #8aa3b8; transition: transform .2s; display: inline-block;
    }
    .collapsible-header.open .collapsible-chevron { transform: rotate(90deg); }
    .collapsible-body {
      max-height: 0; overflow: hidden; transition: max-height .3s ease;
    }
    .collapsible-body.open {
      max-height: 2000px;
    }

    /* --- Document Type row (styled as line item) --- */
    .doc-type-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid #2f4a60;
    }
    .doc-type-row .dt-label {
      font-size: 13px; font-weight: 700; color: #8ec431;
    }
    .doc-type-row select {
      max-width: 220px; border: 1px solid #3d5a73; border-radius: 4px;
      padding: 8px 10px; font-size: 13px; font-family: 'Montserrat', sans-serif;
      background: #1e2e3d; color: #e8ecf1;
    }

    /* --- Settings card --- */
    .settings-card { background: #253a4d; border-radius: 4px; border: 1px solid #2f4a60; margin-bottom: 16px; }
    .settings-body { padding: 16px 20px; }
    .owners-list { max-height: 200px; overflow-y: auto; font-size: 12px; margin-top: 10px; }
    .owners-list .owner-row { padding: 6px 0; border-bottom: 1px solid #2f4a60; color: #c0cdd8; display: flex; justify-content: space-between; }
    .owners-list .owner-row:last-child { border-bottom: none; }
    .owner-id { color: #5a7a94; font-family: monospace; font-size: 11px; }

    /* --- Copy toast --- */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #8ec431; color: #fff; padding: 10px 20px; border-radius: 4px;
      font-size: 13px; font-weight: 600; opacity: 0; transition: opacity .3s;
      pointer-events: none; z-index: 999;
    }
    .toast.show { opacity: 1; }

    /* --- Line items (5-column: Container | WEEE # | Waste Stream | Movement Type | Price | Remove) --- */
    .line-item-row {
      display: grid; grid-template-columns: 15% 8% 30% 17% 15% 5%; gap: 6px;
      align-items: end; padding: 8px 0; border-bottom: 1px solid #2f4a60;
    }
    .line-item-row:last-child { border-bottom: none; }
    .line-item-row input, .line-item-row select { font-size: 12px; padding: 7px 8px; }
    .line-item-row .li-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #8aa3b8; margin-bottom: 2px; }
    .line-item-row select {
      border: 1px solid #3d5a73; border-radius: 4px;
      background: #1e2e3d; color: #e8ecf1;
      font-family: 'Montserrat', sans-serif; cursor: pointer;
    }
    .line-item-row select option { background: #1e2e3d; color: #e8ecf1; }
    /* WEEE # dropdown: compact */
    .li-weee-num {
      width: 50px; min-width: 42px; text-align: center;
      border: 1px solid #3d5a73; border-radius: 4px;
      background: #1e2e3d; color: #e8ecf1;
      font-family: 'Montserrat', sans-serif; font-size: 12px;
      padding: 7px 4px; cursor: pointer;
    }
    .li-weee-num option { background: #1e2e3d; color: #e8ecf1; }
    /* WEEE tooltip wrapper */
    .weee-wrap { position: relative; display: inline-block; width: 100%; }
    .weee-tooltip {
      display: none; position: absolute; bottom: calc(100% + 6px); left: 50%;
      transform: translateX(-50%); background: #162432; color: #e8ecf1;
      padding: 6px 10px; border-radius: 4px; font-size: 11px; white-space: nowrap;
      z-index: 100; pointer-events: none; border: 1px solid #3d5a73;
      box-shadow: 0 2px 8px rgba(0,0,0,.35);
    }
    .weee-tooltip::after {
      content: ''; position: absolute; top: 100%; left: 50%;
      transform: translateX(-50%); border: 5px solid transparent;
      border-top-color: #162432;
    }
    .weee-wrap:hover .weee-tooltip { display: block; }
    /* Product description text input */
    .li-waste-desc {
      width: 100%; border: 1px solid #3d5a73; border-radius: 4px;
      background: #1e2e3d; color: #e8ecf1;
      font-family: 'Montserrat', sans-serif; font-size: 12px;
      padding: 7px 8px;
    }
    .li-waste-desc:focus { outline: none; border-color: #8ec431; box-shadow: 0 0 0 2px rgba(142,196,49,.2); }
    .li-price-wrap {
      display: flex; align-items: center; position: relative;
    }
    .li-price-wrap .li-price-prefix {
      position: absolute; left: 8px; top: 50%; transform: translateY(-50%);
      font-size: 12px; font-weight: 600; color: #8aa3b8; pointer-events: none; z-index: 1;
    }
    .li-price-wrap input {
      padding-left: 22px; text-align: right; width: 100%;
    }
    .btn-remove {
      border: none; background: rgba(180,35,24,.2); color: #f87171; border-radius: 4px;
      padding: 7px 8px; cursor: pointer; font-weight: 700; font-size: 13px;
      font-family: 'Montserrat', sans-serif; transition: background .2s;
    }
    .btn-remove:hover { background: rgba(180,35,24,.35); }


    @media (max-width: 760px) {
      .grid { grid-template-columns: 1fr; }
      .line-item-row { grid-template-columns: 1fr; }
    }

    /* --- Supplier Template Management --- */
    .template-progress { margin-bottom: 14px; }
    .template-progress-text { font-size: 13px; font-weight: 600; color: #c0cdd8; margin-bottom: 6px; }
    .template-list { max-height: 400px; overflow-y: auto; }
    .template-row {
      display: flex; align-items: center; gap: 10px; padding: 8px 0;
      border-bottom: 1px solid #2f4a60; font-size: 13px;
    }
    .template-row:last-child { border-bottom: none; }
    .template-row .tmpl-name { flex: 1; color: #c0cdd8; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .template-row .tmpl-date { font-size: 11px; color: #5a7a94; white-space: nowrap; }
    .badge-trained { display: inline-block; background: rgba(142,196,49,.18); color: #8ec431; border: 1px solid rgba(142,196,49,.35); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
    .badge-untrained { display: inline-block; background: rgba(90,122,148,.15); color: #8aa3b8; border: 1px solid rgba(90,122,148,.3); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
    .btn-train {
      border: 1px solid #8ec431; background: transparent; color: #8ec431;
      border-radius: 4px; padding: 4px 10px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 11px; transition: background .2s;
      white-space: nowrap;
    }
    .btn-train:hover { background: rgba(142,196,49,.15); }
    .btn-del-tmpl {
      border: 1px solid rgba(248,113,113,.3); background: transparent; color: #f87171;
      border-radius: 4px; padding: 4px 8px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 11px; transition: background .2s;
      white-space: nowrap;
    }
    .btn-del-tmpl:hover { background: rgba(248,113,113,.12); }
    .template-search { margin-bottom: 10px; }
    .template-search input { width: 100%; font-size: 13px; padding: 8px 12px; }

    /* --- Training modal --- */
    .train-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 900;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn .2s ease-out;
    }
    .train-modal {
      background: #253a4d; border: 1px solid #2f4a60; border-radius: 4px;
      width: 700px; max-width: 96vw; max-height: 90vh; overflow-y: auto;
      box-shadow: 0 8px 40px rgba(0,0,0,.5);
    }
    .train-modal-head {
      background: #8ec431; color: #fff; padding: 14px 20px; border-radius: 4px 4px 0 0;
      font-weight: 700; font-size: 15px; display: flex; align-items: center; justify-content: space-between;
    }
    .train-modal-head .close-x { cursor: pointer; font-size: 20px; opacity: .8; }
    .train-modal-head .close-x:hover { opacity: 1; }
    .train-modal-body { padding: 20px; }
    .train-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .train-grid .full { grid-column: 1 / -1; }
    .train-grid label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; color: #8ec431; }
    .train-grid input, .train-grid textarea, .train-grid select {
      width: 100%; border: 1px solid #3d5a73; border-radius: 4px; padding: 8px 10px;
      font-size: 13px; font-family: 'Montserrat', sans-serif;
      background: #1e2e3d; color: #e8ecf1;
    }
    .train-grid textarea { min-height: 52px; resize: vertical; }
    .train-grid select option { background: #1e2e3d; color: #e8ecf1; }
    .train-section-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px;
      color: #fff; border-bottom: 2px solid #5a7a94; padding-bottom: 4px;
      margin: 14px 0 8px; grid-column: 1 / -1;
    }
    .train-actions { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; }
    .train-li-row {
      display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 6px;
      align-items: end; padding: 4px 0; border-bottom: 1px solid #2f4a60;
    }
    .train-li-row input { font-size: 12px; padding: 6px 8px; }
    .train-upload-area { text-align: center; padding: 24px; border: 2px dashed #3d5a73; border-radius: 4px; }
    .train-upload-area.drag-over { border-color: #8ec431; background: rgba(142,196,49,.1); }

    /* --- Confidence dots --- */
    .conf-dot {
      display: inline-block; width: 8px; height: 8px; border-radius: 50%;
      margin-left: 6px; vertical-align: middle;
    }
    .conf-dot.high { background: #8ec431; }
    .conf-dot.medium { background: #f59e0b; }
    .conf-dot.low { background: #f87171; }
    .conf-low-border { border-color: rgba(245,158,11,.5) !important; box-shadow: 0 0 0 1px rgba(245,158,11,.15) inset !important; }

    /* --- Template prompt banner --- */
    .template-prompt-banner {
      padding: 10px 14px; border-radius: 4px; font-size: 12px; font-weight: 600;
      margin-bottom: 14px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      background: rgba(142,196,49,.1); color: #8ec431; border: 1px solid rgba(142,196,49,.25);
    }
    .template-prompt-banner .dismiss { margin-left: auto; cursor: pointer; opacity: .7; font-size: 14px; }
    .template-prompt-banner .dismiss:hover { opacity: 1; }

    /* --- Customer Delivery confirmation modal --- */
    .cd-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 900;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn .2s ease-out;
    }
    .cd-modal {
      background: #253a4d; border: 1px solid #2f4a60; border-radius: 4px;
      width: 420px; max-width: 92vw; box-shadow: 0 8px 40px rgba(0,0,0,.5);
    }
    .cd-modal-head {
      background: #3d5a73; color: #fff; padding: 14px 20px; border-radius: 4px 4px 0 0;
      font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 10px;
    }
    .cd-modal-head svg { width: 20px; height: 20px; flex-shrink: 0; }
    .cd-modal-body { padding: 20px; }
    .cd-email-display {
      font-size: 15px; font-weight: 700; color: #8ec431;
      background: rgba(142,196,49,.08); border: 1px solid rgba(142,196,49,.25);
      border-radius: 4px; padding: 10px 14px; margin: 10px 0 14px; word-break: break-all;
    }
    .cd-summary { font-size: 13px; color: #c0cdd8; margin-bottom: 16px; }
    .cd-summary .cd-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #2f4a60; }
    .cd-summary .cd-row:last-child { border-bottom: none; }
    .cd-summary .cd-lbl { color: #8aa3b8; font-weight: 600; }
    .cd-summary .cd-val { color: #e8ecf1; text-align: right; }
    .cd-actions { display: flex; gap: 10px; justify-content: flex-end; }

    /* --- Top-right toast notification --- */
    .toast-tr {
      position: fixed; top: 24px; right: 24px; z-index: 9999;
      padding: 12px 20px; border-radius: 4px; font-size: 13px; font-weight: 600;
      box-shadow: 0 4px 16px rgba(0,0,0,.35); transform: translateX(120%);
      transition: transform .3s ease; max-width: 380px;
    }
    .toast-tr.show { transform: translateX(0); }
    .toast-tr.success { background: rgba(142,196,49,.15); color: #8ec431; border: 1px solid #8ec431; }
    .toast-tr.error { background: rgba(248,113,113,.12); color: #f87171; border: 1px solid rgba(248,113,113,.3); }
    .toast-tr .toast-close { margin-left: 12px; cursor: pointer; opacity: .7; font-weight: 700; }
    .toast-tr .toast-close:hover { opacity: 1; }
    .toast-tr .toast-retry { margin-left: 10px; border: 1px solid #f87171; background: transparent; color: #f87171; border-radius: 4px; padding: 3px 10px; font-weight: 700; cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 11px; }
    .toast-tr .toast-retry:hover { background: rgba(248,113,113,.12); }
    .toast-tr.warning { background: rgba(245,158,11,.12); color: #f59e0b; border: 1px solid rgba(245,158,11,.35); }
    .toast-tr.warning .toast-retry { border-color: #f59e0b; color: #f59e0b; }
    .toast-tr.warning .toast-retry:hover { background: rgba(245,158,11,.12); }

    /* --- WasteLogics button --- */
    .btn-wastelogics {
      border: 1px solid #6B7280; background: transparent; color: #9CA3AF;
      border-radius: 4px; padding: 10px 20px; font-weight: 600;
      cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 12px;
      transition: background .2s, color .2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-wastelogics:hover { background: rgba(107,114,128,.15); color: #c0cdd8; }
    .btn-wastelogics:disabled { opacity: .5; cursor: not-allowed; }
    .beta-badge {
      display: inline-block; font-size: 9px; font-weight: 700; letter-spacing: .5px;
      color: #f59e0b; border: 1px solid rgba(245,158,11,.4); border-radius: 3px;
      padding: 1px 5px; margin-left: 6px; vertical-align: middle; line-height: 1.4;
      text-transform: uppercase;
    }

    /* --- Help tooltips --- */
    .help-tooltip-wrap {
      position: relative; display: inline-flex; align-items: center;
      margin-left: 6px; vertical-align: middle;
    }
    .help-tooltip-icon {
      width: 18px; height: 18px; border-radius: 50%;
      border: 1px solid #4B5563; color: #9CA3AF; background: transparent;
      font-size: 11px; font-weight: 700; line-height: 1;
      display: inline-flex; align-items: center; justify-content: center;
      cursor: help; transition: border-color .2s, color .2s;
      flex-shrink: 0; padding: 0;
    }
    .help-tooltip-icon:hover { border-color: #8EC431; color: #8EC431; }
    .help-tooltip-popup {
      position: absolute; z-index: 9999;
      background: #1e293b; color: #e2e8f0;
      padding: 10px 14px; border: 1px solid #334155; border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
      font-size: 12.5px; line-height: 1.6; font-weight: 400;
      max-width: 280px; width: max-content;
      pointer-events: none; opacity: 0;
      transition: opacity .2s ease;
      text-transform: none; letter-spacing: 0;
    }
    .help-tooltip-wrap:hover .help-tooltip-popup { opacity: 1; }
    .help-tooltip-popup--above {
      bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%);
    }
    .help-tooltip-popup--above::after {
      content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      border: 6px solid transparent; border-top-color: #1e293b;
    }
    .help-tooltip-popup--above::before {
      content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
      border: 7px solid transparent; border-top-color: #334155;
    }
    .help-tooltip-popup--right {
      left: calc(100% + 8px); top: 50%; transform: translateY(-50%);
    }
    .help-tooltip-popup--right::after {
      content: ''; position: absolute; right: 100%; top: 50%; transform: translateY(-50%);
      border: 6px solid transparent; border-right-color: #1e293b;
    }
    .help-tooltip-popup--right::before {
      content: ''; position: absolute; right: 100%; top: 50%; transform: translateY(-50%);
      border: 7px solid transparent; border-right-color: #334155;
    }
    /* === Tab Navigation === */
    .tab-bar {
      display: flex; align-items: stretch; background: #151f2a;
      border-bottom: 2px solid #253a4d; padding: 0;
      max-width: 980px; margin: 0 auto; border-radius: 4px 4px 0 0;
    }
    .tab-btn {
      position: relative; background: none; border: none;
      padding: 14px 28px; font-family: 'Montserrat', sans-serif;
      font-size: 14px; font-weight: 700; cursor: pointer;
      color: #5a7a94; transition: color .2s, background .2s;
      display: inline-flex; align-items: center; gap: 8px;
      border-radius: 4px 4px 0 0;
    }
    .tab-btn:hover { color: #c0cdd8; background: rgba(255,255,255,.03); }
    .tab-btn.active { color: #e8ecf1; background: rgba(142,196,49,.06); }
    .tab-btn.active::after {
      content: ''; position: absolute; bottom: -2px; left: 0; right: 0;
      height: 3px; background: #8EC431; border-radius: 4px 4px 0 0;
    }
    .tab-btn.locked {
      color: #3d5a73; cursor: not-allowed; opacity: .6;
    }
    .tab-btn.locked:hover { background: none; color: #3d5a73; }
    .tab-btn .lock-icon { width: 14px; height: 14px; opacity: .5; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <!-- Tab Navigation Bar -->
  <div class="tab-bar" id="tab-bar">
    <button class="tab-btn active" data-tab="broker" onclick="switchTab('broker')">Broker</button>
    <button class="tab-btn" data-tab="cef" onclick="switchTab('cef')">CEF</button>
    <button class="tab-btn locked" data-tab="sales" title="Coming Soon" onclick="return false">
      <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      Sales
    </button>
  </div>

  <!-- ====== BROKER TAB (existing app â€” completely unchanged) ====== -->
  <div class="tab-content active" id="broker-tab-content">
  <div class="wrap">
    <div class="brand">
      <img src="https://i0.wp.com/wasteexperts.co.uk/wp-content/uploads/2022/11/green-grey-logo-1080.png?w=1920&amp;ssl=1" alt="Waste Experts logo" />
      <h1 class="brand-title">Improving Efficiency, Reducing Input</h1>
      <p class="brand-subtitle">Made with ðŸ’š by Marketing</p>
    </div>

    <!-- Top navigation bar â€” always visible -->
    <div class="top-nav" id="top-nav">
      <button class="nav-btn nav-hidden" id="nav-upload-btn" type="button" onclick="resetToUpload()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload New PDF
      </button>
      <button class="nav-btn" id="nav-settings-btn" type="button" onclick="openSettingsModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </button>
    </div>

    <div id="state-container">
    <!-- Upload card -->
    <div id="upload-card" class="card">
      <div class="head">Upload Purchase Order PDF</div>
      <div class="body">
        <div id="drop-zone" class="drop">
          <p><strong>Drop a PDF here</strong> or choose a file</p>
          <button class="btn" type="button" onclick="document.getElementById('file-input').click()">Choose PDF</button>
          <input id="file-input" type="file" accept=".pdf" class="hidden" />
          <p id="file-label" style="margin-top:8px; font-size:13px; color:#5a6e80;"></p>
        </div>
      </div>
    </div>

    <!-- Extracted data card (detached from DOM by JS on init) -->
    <div id="edit" class="card">
      <div class="head">Extracted Order Data</div>
      <div class="body">

        <!-- Document header -->
        <div class="doc-header">
          <h2 id="doc-title">Purchase Order</h2>
          <span class="doc-meta" id="doc-supplier-label"></span>
        </div>

        <!-- Template prompt banner (shown for untrained suppliers) -->
        <div id="template-prompt-area"></div>

        <div class="grid">

          <!-- ===== Supplier / Account ===== -->
          <div class="section-title">Supplier &amp; Reference<span class="help-tooltip-wrap"><span class="help-tooltip-icon">?</span><span class="help-tooltip-popup help-tooltip-popup--right">This section shows the supplier name, PO number, and reference details extracted from your PDF. If anything looks wrong, click the field to edit it manually.</span></span></div>

          <div class="field full typeahead-wrap">
            <label for="account_name">Account Name</label>
            <input id="account_name" type="text" autocomplete="off" placeholder="Enter your supplier here..." />
            <div id="typeahead-dropdown" class="typeahead-list"></div>
            <div id="account-error" class="error hidden">Please choose a valid supplier from the list</div>
          </div>

          <div class="field">
            <label>Supplier (From)</label>
            <input id="supplier" type="text" />
          </div>
          <div class="field">
            <label>Purchase Order Number</label>
            <input id="purchase_order_number" type="text" />
          </div>

          <div class="field full">
            <label>Service / Product Description</label>
            <input id="service_description" type="text" placeholder="e.g. Corrugated Flo Tube Pipe - Exchange" />
          </div>

          <div class="field full">
            <label>Bill To (Representative Address)</label>
            <textarea id="supplier_address" placeholder="Supplier address will appear here"></textarea>
          </div>

          <!-- ===== Products & Services ===== -->
          <div class="section-title">Products &amp; Services<span class="help-tooltip-wrap"><span class="help-tooltip-icon">?</span><span class="help-tooltip-popup help-tooltip-popup--right">All line items found in the purchase order. Check quantities, unit prices, and totals are correct. You can edit any field by clicking on it.</span></span></div>

          <!-- Document Type row -->
          <div class="full doc-type-row">
            <span class="dt-label">Document Type<span class="help-tooltip-wrap"><span class="help-tooltip-icon">?</span><span class="help-tooltip-popup help-tooltip-popup--right">Select the document type for this order. A &pound;40 line will be added automatically to the PDF download, HubSpot, email, and webhook outputs.</span></span></span>
            <select id="document_type" onchange="onDocTypeChange()">
              <option value="">None</option>
              <option value="Consignment Note">Consignment Note</option>
              <option value="Waste Transfer Note">Waste Transfer Note</option>
            </select>
          </div>

          <!-- Line item header row -->
          <div class="full" style="display:grid; grid-template-columns:15% 8% 30% 17% 15% 5%; gap:6px; padding:6px 0; border-bottom:1px solid #3d5a73;">
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">Container</span>
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">WEEE</span>
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">Waste Stream</span>
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">Movement Type</span>
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">Price</span>
            <span></span>
          </div>

          <div class="full" id="line-items-container">
            <!-- Line item rows are injected here by JS -->
          </div>

          <div class="full" style="display:flex; gap:10px; align-items:center; margin-bottom:4px;">
            <button class="btn-outline" type="button" onclick="addLineItem()">+ Add Line Item</button>
            <span style="margin-left:auto; font-weight:700; font-size:14px; color:#8ec431;">
              Overall Total: <span id="overall_total_display">&pound;0.00</span>
            </span>
          </div>

          <!-- ===== Customer / Site Information ===== -->
          <div class="section-title">Customer / Site Information<span class="help-tooltip-wrap"><span class="help-tooltip-icon">?</span><span class="help-tooltip-popup help-tooltip-popup--right">Customer and site details extracted from the PO. All fields are editable &mdash; correct anything the AI didn&rsquo;t extract accurately.</span></span></div>

          <div class="field">
            <label>Customer Name / Waste Producer</label>
            <input id="customer_name" type="text" placeholder="Extracted from PO" />
          </div>
          <div class="field">
            <label>SIC Code</label>
            <input id="sic_code" type="text" placeholder="AI-extracted or enter manually" />
          </div>

          <div class="section-title" style="margin-top:10px;">Contact Information</div>
          <div class="field"><label>Site Contact</label><input id="site_contact" type="text" /></div>
          <div class="field"><label>Site Contact Number</label><input id="site_contact_number" type="text" /></div>
          <div class="field full"><label>Site Contact Email</label><input id="site_contact_email" type="email" /></div>
          <div class="field"><label>Secondary Site Contact</label><input id="secondary_site_contact" type="text" /></div>
          <div class="field"><label>Secondary Site Contact Number</label><input id="secondary_site_contact_number" type="text" /></div>
          <div class="field full"><label>Secondary Site Contact Email</label><input id="secondary_site_contact_email" type="email" /></div>

          <div class="section-title" style="margin-top:10px;">Site Information</div>
          <div class="field"><label>Site Name</label><input id="site_name" type="text" /></div>
          <div class="field"><label>Site Postcode</label><input id="site_postcode" type="text" /></div>
          <div class="field full"><label>Site Address</label><textarea id="site_address"></textarea></div>

          <div class="section-title" style="margin-top:10px;">Access &amp; Instructions</div>
          <div class="field"><label>Opening Times</label><textarea id="opening_times"></textarea></div>
          <div class="field"><label>Access</label><textarea id="access"></textarea></div>
          <div class="field"><label>Site Restrictions</label><textarea id="site_restrictions"></textarea></div>
          <div class="field"><label>Special Instructions</label><textarea id="special_instructions"></textarea></div>
        </div>

        <!-- Download PDF (top area) -->
        <div style="margin-top:18px; display:flex; align-items:center; gap:10px;">
          <button id="btn-download" class="btn" type="button" onclick="downloadReviewPDF()">Download PDF</button><span class="help-tooltip-wrap"><span class="help-tooltip-icon">?</span><span class="help-tooltip-popup help-tooltip-popup--above">Downloads a formatted PDF of the extracted purchase order data, including all fields and the selected document type.</span></span>
        </div>

        <!-- Action bar (integrations) -->
        <div style="margin-top:20px; padding:20px 0 0; border-top:1px solid #3d5a73; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <button id="btn-hubspot" class="btn-hubspot" type="button" onclick="openHubSpotPreview()" style="padding:10px 20px;">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.83 11.41V7.55a2.2 2.2 0 0 0 1.27-1.98 2.22 2.22 0 0 0-2.22-2.22h-.04V1.5a.75.75 0 0 0-1.5 0v1.85h-.04a2.22 2.22 0 0 0-2.22 2.22c0 .9.54 1.67 1.31 2.01v3.83a5.1 5.1 0 0 0-2.53 1.27l-6.63-5.16a2.03 2.03 0 0 0 .05-.42 2.08 2.08 0 1 0-2.08 2.08c.4 0 .77-.12 1.09-.32l6.45 5.02a5.17 5.17 0 0 0 .42 5.53l-1.79 1.79a1.7 1.7 0 0 0-.5-.08 1.72 1.72 0 1 0 1.72 1.72c0-.17-.03-.34-.08-.5l1.76-1.76a5.18 5.18 0 1 0 5.96-8.52zM16.84 18a2.68 2.68 0 1 1 0-5.37 2.68 2.68 0 0 1 0 5.37z"/></svg>
              Send to HubSpot
            </button><span class="help-tooltip-wrap"><span class="help-tooltip-icon">?</span><span class="help-tooltip-popup help-tooltip-popup--above">Creates a deal in HubSpot with the extracted data. You&rsquo;ll see a preview of exactly what will be sent before confirming. The deal will be assigned to the default owner and marked as closed won.</span></span>
            <button id="btn-delivery" class="btn-outline" type="button" onclick="openDeliveryConfirm()" style="display:inline-flex; align-items:center; gap:6px; padding:10px 20px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,7 12,13 2,7"/></svg>
              Send to Customer Delivery
            </button><span class="help-tooltip-wrap"><span class="help-tooltip-icon">?</span><span class="help-tooltip-popup help-tooltip-popup--above">Emails the generated PDF to the configured customer delivery email address.</span></span>
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <button id="btn-wastelogics" class="btn-wastelogics" type="button" onclick="sendToWasteLogics()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              Send to WasteLogics<span class="beta-badge">BETA</span>
            </button><span class="help-tooltip-wrap"><span class="help-tooltip-icon">?</span><span class="help-tooltip-popup help-tooltip-popup--above">Sends extracted PO data to WasteLogics via automation. Currently in testing &mdash; data is sent but not yet inputted automatically.</span></span>
          </div>
        </div>

        <!-- HubSpot feedback banner area -->
        <div id="hs-banner-area"></div>
      </div>
    </div>
    </div>

  </div>
  </div><!-- /broker-tab-content -->

  <!-- ====== CEF TAB ====== -->
  <div class="tab-content" id="cef-tab-content">
  <div class="wrap">
    <div class="brand">
      <img src="https://i0.wp.com/wasteexperts.co.uk/wp-content/uploads/2022/11/green-grey-logo-1080.png?w=1920&amp;ssl=1" alt="Waste Experts logo" />
      <h1 class="brand-title">CEF Purchase Orders</h1>
      <p class="brand-subtitle">Made with &#x1F49A; by Marketing</p>
    </div>

    <!-- CEF Top navigation bar -->
    <div class="top-nav" id="cef-top-nav">
      <button class="nav-btn nav-hidden" id="cef-nav-upload-btn" type="button" onclick="cefResetToUpload()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload New PDF
      </button>
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="field" style="margin:0; gap:2px; min-width:180px;">
          <label style="font-size:10px; margin:0;">Person</label>
          <select id="cef-person-select" style="padding:6px 10px; font-size:12px;">
            <option value="Katie Wooton" selected>Katie Wooton</option>
            <option value="David Williams">David Williams</option>
          </select>
        </div>
      </div>
    </div>

    <div id="cef-state-container">
    <!-- CEF Upload card -->
    <div id="cef-upload-card" class="card">
      <div class="head">Upload CEF Purchase Order PDF</div>
      <div class="body">
        <div id="cef-drop-zone" class="drop">
          <p><strong>Drop a CEF PO here</strong> or choose a file</p>
          <button class="btn" type="button" onclick="document.getElementById('cef-file-input').click()">Choose PDF</button>
          <input id="cef-file-input" type="file" accept=".pdf" class="hidden" />
          <p id="cef-file-label" style="margin-top:8px; font-size:13px; color:#5a6e80;"></p>
        </div>
      </div>
    </div>

    <!-- CEF Extracted data card -->
    <div id="cef-edit" class="card">
      <div class="head">Extracted CEF Order Data</div>
      <div class="body">

        <!-- Document header -->
        <div class="doc-header">
          <h2 id="cef-doc-title">CEF Purchase Order</h2>
          <span class="doc-meta" id="cef-doc-supplier-label"></span>
        </div>

        <div class="grid">

          <!-- ===== Supplier & Reference ===== -->
          <div class="section-title">Supplier &amp; Reference</div>

          <div class="field">
            <label>CEF Branch</label>
            <input id="cef_branch_name" type="text" placeholder="e.g. C.E.F. (Airdrie)" />
          </div>
          <div class="field">
            <label>PO Reference</label>
            <input id="cef_po_reference" type="text" placeholder="e.g. AIR/135200" />
          </div>

          <div class="field full">
            <label>Branch Address</label>
            <textarea id="cef_branch_address" placeholder="CEF branch address"></textarea>
          </div>

          <div class="field">
            <label>Branch Postcode</label>
            <input id="cef_branch_postcode" type="text" />
          </div>
          <div class="field">
            <label>Branch Phone</label>
            <input id="cef_branch_phone" type="text" />
          </div>
          <div class="field full">
            <label>Branch Email</label>
            <input id="cef_branch_email" type="email" />
          </div>

          <div class="field">
            <label>PO Date</label>
            <input id="cef_po_date" type="text" />
          </div>
          <div class="field">
            <label>Entered By</label>
            <input id="cef_entered_by" type="text" />
          </div>

          <!-- ===== Products & Services ===== -->
          <div class="section-title">Products &amp; Services</div>

          <!-- Document Type row -->
          <div class="full doc-type-row">
            <span class="dt-label">Document Type</span>
            <select id="cef_document_type" onchange="cefOnDocTypeChange()">
              <option value="">None</option>
              <option value="Consignment Note">Consignment Note</option>
              <option value="Waste Transfer Note">Waste Transfer Note</option>
            </select>
          </div>

          <!-- Line item header row -->
          <div class="full" style="display:grid; grid-template-columns:15% 8% 30% 17% 15% 5%; gap:6px; padding:6px 0; border-bottom:1px solid #3d5a73;">
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">Container</span>
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">WEEE</span>
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">Waste Stream</span>
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">Movement Type</span>
            <span style="font-size:10px; font-weight:700; text-transform:uppercase; color:#8ec431; letter-spacing:.3px;">Price</span>
            <span></span>
          </div>

          <div class="full" id="cef-line-items-container">
            <!-- CEF Line item rows injected by JS -->
          </div>

          <div class="full" style="display:flex; gap:10px; align-items:center; margin-bottom:4px;">
            <button class="btn-outline" type="button" onclick="cefAddLineItem()">+ Add Line Item</button>
            <span style="margin-left:auto; font-weight:700; font-size:14px; color:#8ec431;">
              Overall Total: <span id="cef_overall_total_display">&pound;0.00</span>
            </span>
          </div>

          <!-- ===== Customer / Site Information ===== -->
          <div class="section-title">Customer / Site Information</div>

          <div class="field full">
            <label>Site Contact (from PO)</label>
            <input id="cef_site_contact" type="text" placeholder="e.g. Katie Wooton" />
          </div>

          <div class="section-title" style="margin-top:10px;">Delivery Address</div>
          <div class="field full">
            <label>Delivery Address</label>
            <textarea id="cef_delivery_address" placeholder="Defaults to CEF branch address if not specified"></textarea>
          </div>
          <div class="field">
            <label>Delivery Postcode</label>
            <input id="cef_delivery_postcode" type="text" />
          </div>

          <div class="section-title" style="margin-top:10px;">Additional</div>
          <div class="field full">
            <label>Special Instructions</label>
            <textarea id="cef_special_instructions"></textarea>
          </div>

          <!-- ===== Prepared By ===== -->
          <div class="section-title" style="margin-top:10px;">Prepared By</div>
          <div class="full" id="cef-prepared-by-block" style="background:#162432; border:1px solid #3d5a73; border-radius:6px; padding:14px 16px; display:grid; grid-template-columns:1fr 1fr; gap:6px 20px;">
            <div>
              <span style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.3px; color:#8ec431;">Name</span>
              <div id="cef-prep-name" style="font-size:14px; font-weight:600; color:#e8ecf1; margin-top:2px;">Katie Wooton</div>
            </div>
            <div>
              <span style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.3px; color:#8ec431;">Title</span>
              <div id="cef-prep-title" style="font-size:13px; color:#c5d0db; margin-top:2px;">CEF Internal Account Manager</div>
            </div>
            <div>
              <span style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.3px; color:#8ec431;">Email</span>
              <div id="cef-prep-email" style="font-size:13px; color:#c5d0db; margin-top:2px;">katie@wasteexperts.co.uk</div>
            </div>
            <div>
              <span style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.3px; color:#8ec431;">Phone</span>
              <div id="cef-prep-phone" style="font-size:13px; color:#c5d0db; margin-top:2px;">01388 721 000</div>
            </div>
          </div>
        </div>

        <!-- Download PDF (top area) -->
        <div style="margin-top:18px; display:flex; align-items:center; gap:10px;">
          <button id="cef-btn-download" class="btn" type="button" onclick="cefDownloadReviewPDF()">Download PDF</button>
        </div>

        <!-- Action bar (integrations) -->
        <div style="margin-top:20px; padding:20px 0 0; border-top:1px solid #3d5a73; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <button id="cef-btn-hubspot" class="btn-hubspot" type="button" onclick="cefOpenHubSpotPreview()" style="padding:10px 20px;">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.83 11.41V7.55a2.2 2.2 0 0 0 1.27-1.98 2.22 2.22 0 0 0-2.22-2.22h-.04V1.5a.75.75 0 0 0-1.5 0v1.85h-.04a2.22 2.22 0 0 0-2.22 2.22c0 .9.54 1.67 1.31 2.01v3.83a5.1 5.1 0 0 0-2.53 1.27l-6.63-5.16a2.03 2.03 0 0 0 .05-.42 2.08 2.08 0 1 0-2.08 2.08c.4 0 .77-.12 1.09-.32l6.45 5.02a5.17 5.17 0 0 0 .42 5.53l-1.79 1.79a1.7 1.7 0 0 0-.5-.08 1.72 1.72 0 1 0 1.72 1.72c0-.17-.03-.34-.08-.5l1.76-1.76a5.18 5.18 0 1 0 5.96-8.52zM16.84 18a2.68 2.68 0 1 1 0-5.37 2.68 2.68 0 0 1 0 5.37z"/></svg>
              Send to HubSpot
            </button>
            <button id="cef-btn-delivery" class="btn-outline" type="button" onclick="cefOpenDeliveryConfirm()" style="display:inline-flex; align-items:center; gap:6px; padding:10px 20px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,7 12,13 2,7"/></svg>
              Send to Customer Delivery
            </button>
          </div>
          <div style="display:flex; align-items:center; gap:6px;">
            <button id="cef-btn-wastelogics" class="btn-wastelogics" type="button" disabled title="WasteLogics integration coming soon" style="opacity:0.45;cursor:not-allowed;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              Send to WasteLogics
            </button>
          </div>
        </div>

        <!-- CEF HubSpot feedback banner area -->
        <div id="cef-hs-banner-area"></div>
      </div>
    </div>
    </div>

  </div>
  </div><!-- /cef-tab-content -->

  <!-- ====== SALES TAB (Locked) ====== -->
  <div class="tab-content" id="sales-tab-content">
  <div class="wrap">
    <div class="brand">
      <img src="https://i0.wp.com/wasteexperts.co.uk/wp-content/uploads/2022/11/green-grey-logo-1080.png?w=1920&amp;ssl=1" alt="Waste Experts logo" />
      <h1 class="brand-title">Sales</h1>
      <p class="brand-subtitle">Made with &#x1F49A; by Marketing</p>
    </div>
    <div class="card">
      <div class="body" style="text-align:center; padding:60px 20px;">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#5a7a94" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom:16px;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <h2 style="margin:0 0 8px; color:#5a7a94; font-size:18px;">Coming Soon</h2>
        <p style="color:#3d5a73; font-size:14px; margin:0;">The Sales tab is under development and will be available in a future update.</p>
      </div>
    </div>
  </div>
  </div><!-- /sales-tab-content -->

  <!-- Settings modal (rendered outside .wrap for proper fixed overlay) -->
  <div id="settings-modal-root"></div>

  <!-- HubSpot preview modal (injected dynamically) -->
  <div id="hs-modal-root"></div>

  <!-- Training modal (injected dynamically) -->
  <div id="training-modal-root"></div>

  <!-- Customer Delivery confirmation modal (injected dynamically) -->
  <div id="cd-modal-root"></div>

  <!-- Top-right toast notification -->
  <div id="toast-tr" class="toast-tr"></div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <script>
    /* â”€â”€ Lottie animation data & setup â”€â”€ */
    const scanAnimation = {"v":"5.5.7","meta":{"g":"LottieFiles AE 0.1.20","a":"","k":"","d":"","tc":"#ffffff"},"fr":60,"ip":0,"op":227,"w":600,"h":600,"nm":"Artboard","ddd":0,"assets":[{"id":"comp_0","layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle Copy 10","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[274,400.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[128,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 3","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"Rectangle Copy 9","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[368.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[41,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 5","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"Rectangle Copy 8","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[348.5,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[81,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 4","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":4,"nm":"Rectangle Copy 7","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[249,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[78,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 2","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":4,"nm":"Rectangle Copy 6","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[270.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[121,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":6,"ty":4,"nm":"Rectangle 3","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[255,234.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[90,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":7,"ty":4,"nm":"Rectangle 2","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[299.89,304.75,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[245.78,319.5],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":19,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[1,1,1,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0}]},{"id":"comp_1","layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle Copy 3","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[274,400.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[128,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 3","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"Rectangle Copy 5","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[368.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[41,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 5","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"Rectangle Copy 4","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[348.5,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[81,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 4","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":4,"nm":"Rectangle Copy 2","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[249,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[78,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 2","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":4,"nm":"Rectangle Copy","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[270.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[121,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":6,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[255,234.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[90,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":7,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":60,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[299.89,304.75,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[245.78,319.5],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":19,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[1,1,1,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0}]}],"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.376,"y":1},"o":{"x":0.275,"y":0},"t":0,"s":[300,485.5,0],"to":[0,-60,0],"ti":[0,0,0]},{"i":{"x":0.725,"y":1},"o":{"x":0.632,"y":0},"t":110,"s":[300,125.5,0],"to":[0,0,0],"ti":[0,-60,0]},{"t":220,"s":[300,485.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,9],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":4.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.094117999077,0.439215987921,0.843137025833,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"bottom-grad","sr":1,"ks":{"o":{"a":1,"k":[{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":120,"s":[0]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":152,"s":[40]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":199,"s":[40]},{"t":218,"s":[0]}],"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.374,"y":1},"o":{"x":0.274,"y":0},"t":1,"s":[300,463.5,0],"to":[0,-52.833,0],"ti":[0,-7.167,0]},{"i":{"x":0.726,"y":1},"o":{"x":0.621,"y":0},"t":111,"s":[300,146.5,0],"to":[0,7.167,0],"ti":[0,-60,0]},{"t":221,"s":[300,506.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,-100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,45],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":0,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"gf","o":{"a":0,"k":100,"ix":10},"r":1,"bm":0,"g":{"p":3,"k":{"a":0,"k":[0,0.094,0.439,0.843,0.5,0.094,0.439,0.843,1,0.094,0.439,0.843,0,0,0.252,0.2,0.505,0.4,0.752,0.7,1,1],"ix":9}},"s":{"a":0,"k":[0,-22.5],"ix":5},"e":{"a":0,"k":[0,22.5],"ix":6},"t":1,"nm":"Gradient Fill 1","mn":"ADBE Vector Graphic - G-Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"top-grad","sr":1,"ks":{"o":{"a":1,"k":[{"i":{"x":[0.833],"y":[1]},"o":{"x":[0.167],"y":[0]},"t":0,"s":[0]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":14,"s":[40]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":89,"s":[40]},{"i":{"x":[0.833],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":108,"s":[0]},{"t":221,"s":[0]}],"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.376,"y":1},"o":{"x":0.271,"y":0},"t":1,"s":[300,463.5,0],"to":[0,-60,0],"ti":[0,0,0]},{"i":{"x":0.725,"y":1},"o":{"x":0.632,"y":0},"t":111,"s":[300,103.5,0],"to":[0,0,0],"ti":[0,-60,0]},{"t":221,"s":[300,463.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,45],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":0,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"gf","o":{"a":0,"k":100,"ix":10},"r":1,"bm":0,"g":{"p":3,"k":{"a":0,"k":[0,0.094,0.439,0.843,0.5,0.094,0.439,0.843,1,0.094,0.439,0.843,0,0,0.252,0.2,0.505,0.4,0.752,0.7,1,1],"ix":9}},"s":{"a":0,"k":[0,-22.5],"ix":5},"e":{"a":0,"k":[0,22.5],"ix":6},"t":1,"nm":"Gradient Fill 1","mn":"ADBE Vector Graphic - G-Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":0,"nm":"full","refId":"comp_0","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[300,300,0],"ix":2},"a":{"a":0,"k":[300,300,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"hasMask":true,"masksProperties":[{"inv":false,"mode":"i","pt":{"a":1,"k":[{"i":{"x":0.364,"y":1},"o":{"x":0.272,"y":0},"t":0,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,479.957],[448.801,479.957]],"c":true}]},{"i":{"x":0.73,"y":1},"o":{"x":0.631,"y":0},"t":110,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,129.957],[448.801,129.957]],"c":true}]},{"t":220,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,479.957],[448.801,479.957]],"c":true}]}],"ix":1},"o":{"a":0,"k":100,"ix":3},"x":{"a":0,"k":0,"ix":4},"nm":"Mask 1"}],"w":600,"h":600,"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":0,"nm":"trans","refId":"comp_1","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[300,300,0],"ix":2},"a":{"a":0,"k":[300,300,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"w":600,"h":600,"ip":0,"op":3600,"st":0,"bm":0}],"markers":[]};

    /* Replace all blue and green colors with grey #6B7280 (RGB 0.42, 0.447, 0.502) */
    (function recolorLottie(obj) {
      var GREY = [0.42, 0.447, 0.502];
      function isBlue(r, g, b) { return b > 0.5 && b > r * 2; }
      function isGreen(r, g, b) { return g > 0.5 && g > r * 1.2 && g > b * 1.2; }
      function shouldReplace(r, g, b) { return isBlue(r, g, b) || isGreen(r, g, b); }

      function walk(node) {
        if (Array.isArray(node)) { node.forEach(walk); return; }
        if (!node || typeof node !== 'object') return;

        /* Solid fill / stroke color */
        if ((node.ty === 'fl' || node.ty === 'st') && node.c) {
          var k = node.c.k;
          if (Array.isArray(k) && k.length >= 4 && typeof k[0] === 'number') {
            if (shouldReplace(k[0], k[1], k[2])) { k[0] = GREY[0]; k[1] = GREY[1]; k[2] = GREY[2]; }
          }
        }

        /* Gradient fill / stroke */
        if ((node.ty === 'gf' || node.ty === 'gs') && node.g) {
          var p = node.g.p;
          var gk = node.g.k;
          if (gk && gk.a === 0 && Array.isArray(gk.k)) {
            for (var i = 0; i < p; i++) {
              var base = i * 4;
              if (shouldReplace(gk.k[base + 1], gk.k[base + 2], gk.k[base + 3])) {
                gk.k[base + 1] = GREY[0]; gk.k[base + 2] = GREY[1]; gk.k[base + 3] = GREY[2];
              }
            }
          }
        }

        Object.keys(node).forEach(function(key) { walk(node[key]); });
      }

      walk(obj);
    })(scanAnimation);

    /* Lottie player â€” created fresh each scan, destroyed after */
    var lottieAnim = null;

    /* â”€â”€ Three-state flow: "upload" | "scanning" | "results" â”€â”€ */
    var appState = 'upload';

    /* â”€â”€ Nav bar visibility helper â”€â”€ */
    function updateNavButtons() {
      var uploadBtn = document.getElementById('nav-upload-btn');
      if (uploadBtn) {
        /* Hide "Upload New PDF" when already on upload screen */
        if (appState === 'upload') {
          uploadBtn.classList.add('nav-hidden');
        } else {
          uploadBtn.classList.remove('nav-hidden');
        }
      }
    }

    /* â”€â”€ Broker data from Flask â”€â”€ */
    const BROKERS = {{ brokers_json|safe }};
    const brokerNames = BROKERS.map(b => b.name);
    const brokerAddressMap = Object.fromEntries(BROKERS.map(b => [b.name, b.address || '']));

    /* â”€â”€ DOM refs (cached before setState detaches elements) â”€â”€ */
    const stateContainer = document.getElementById('state-container');
    const uploadCard     = document.getElementById('upload-card');
    const editCard       = document.getElementById('edit');
    const fileInput      = document.getElementById('file-input');
    const dropZone       = document.getElementById('drop-zone');
    const accountInput   = document.getElementById('account_name');
    const dropdown       = document.getElementById('typeahead-dropdown');
    let activeIdx        = -1;

    /* â”€â”€ State management â”€â”€ */
    function setState(newState, filename) {
      /* Clean up scanning state */
      if (appState === 'scanning') {
        clearInterval(progressTimer);
        if (lottieAnim) { lottieAnim.destroy(); lottieAnim = null; }
      }

      /* Remove all children from container (detach, not destroy) */
      while (stateContainer.firstChild) {
        stateContainer.removeChild(stateContainer.firstChild);
      }

      appState = newState;

      if (newState === 'upload') {
        fileInput.value = '';
        stateContainer.appendChild(uploadCard);

      } else if (newState === 'scanning') {
        /* Build scanning section dynamically */
        var section = document.createElement('div');
        section.className = 'lottie-loading';
        var safeName = (filename || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        section.innerHTML =
          '<div id="lottie-player"></div>' +
          '<p class="loading-text">We\'re attempting to read <em>' + safeName + '</em>. Hold tight!</p>' +
          '<div class="progress-wrap">' +
            '<div class="progress-pct" id="progress-pct">0%</div>' +
            '<div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>' +
          '</div>';
        stateContainer.appendChild(section);

        /* Init Lottie */
        lottieAnim = lottie.loadAnimation({
          container: document.getElementById('lottie-player'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          animationData: JSON.parse(JSON.stringify(scanAnimation))
        });
        startProgress();

      } else if (newState === 'results') {
        editCard.classList.remove('fade-in');
        stateContainer.appendChild(editCard);
      }

      updateNavButtons();
    }

    /* â”€â”€ Reset back to upload state â”€â”€ */
    function resetToUpload() {
      /* Clear all form fields while edit card is still in DOM */
      [
        'supplier', 'purchase_order_number', 'service_description',
        'customer_name', 'sic_code',
        'site_contact', 'site_contact_number', 'site_contact_email',
        'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
        'site_name', 'site_address', 'site_postcode',
        'opening_times', 'access', 'site_restrictions', 'special_instructions',
        'account_name', 'supplier_address'
      ].forEach(function(key) { setField(key, ''); });
      setField('document_type', '');
      clearLineItems();
      var elDocTitle = document.getElementById('doc-title');
      if (elDocTitle) elDocTitle.textContent = 'Purchase Order';
      var elDocLabel = document.getElementById('doc-supplier-label');
      if (elDocLabel) elDocLabel.textContent = '';
      var elAccErr = document.getElementById('account-error');
      if (elAccErr) elAccErr.classList.add('hidden');
      var elBanner = document.getElementById('hs-banner-area');
      if (elBanner) elBanner.innerHTML = '';
      var elTmplArea = document.getElementById('template-prompt-area');
      if (elTmplArea) elTmplArea.innerHTML = '';
      document.querySelectorAll('.conf-dot').forEach(function(d) { d.remove(); });
      document.querySelectorAll('.conf-low-border').forEach(function(el) { el.classList.remove('conf-low-border'); });
      if (dropdown) dropdown.classList.remove('open');
      _lastExtractedData = null;
      _lastConfidence = null;
      _lastSupplierTrained = false;

      setState('upload');
    }

    /* â”€â”€ Helpers â”€â”€ */
    function setField(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value || '';
    }
    function getField(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    }

    /* â”€â”€ Help tooltip helper â”€â”€ */
    function helpTooltip(text, position) {
      var pos = position || 'above';
      return '<span class="help-tooltip-wrap">' +
        '<span class="help-tooltip-icon">?</span>' +
        '<span class="help-tooltip-popup help-tooltip-popup--' + pos + '">' + text + '</span>' +
      '</span>';
    }

    /* â”€â”€ Typeahead dropdown â”€â”€ */
    function renderDropdown(term) {
      if (!dropdown) return;
      const q = (term || '').trim().toLowerCase();
      let matches = brokerNames;
      if (q) {
        matches = brokerNames.filter(name => name.toLowerCase().includes(q));
      }
      matches = matches.slice(0, 40);
      activeIdx = -1;

      if (matches.length === 0) {
        dropdown.innerHTML = '<div class="typeahead-item" style="color:#8a9bb0; cursor:default;">No matching suppliers</div>';
        dropdown.classList.add('open');
        return;
      }

      dropdown.innerHTML = matches.map((name, i) => {
        let display = name;
        if (q) {
          const idx = name.toLowerCase().indexOf(q);
          if (idx !== -1) {
            display = name.substring(0, idx)
              + '<mark>' + name.substring(idx, idx + q.length) + '</mark>'
              + name.substring(idx + q.length);
          }
        }
        return `<div class="typeahead-item" data-index="${i}" data-value="${name}">${display}</div>`;
      }).join('');

      dropdown.classList.add('open');
    }

    function closeDropdown() {
      setTimeout(() => {
        if (dropdown) dropdown.classList.remove('open');
        activeIdx = -1;
      }, 150);
    }

    function selectSupplier(name) {
      if (accountInput) accountInput.value = name;
      if (dropdown) dropdown.classList.remove('open');
      updateSupplierAddress();
      validateAccount();
    }

    dropdown.addEventListener('mousedown', e => {
      const item = e.target.closest('.typeahead-item');
      if (item && item.dataset.value) {
        e.preventDefault();
        selectSupplier(item.dataset.value);
      }
    });

    accountInput.addEventListener('focus', () => renderDropdown(accountInput.value));
    accountInput.addEventListener('input', () => {
      renderDropdown(accountInput.value);
      updateSupplierAddress();
      validateAccount();
    });
    accountInput.addEventListener('blur', closeDropdown);
    accountInput.addEventListener('keydown', e => {
      const items = dropdown.querySelectorAll('.typeahead-item[data-value]');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIdx = Math.min(activeIdx + 1, items.length - 1);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
        items[activeIdx].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIdx = Math.max(activeIdx - 1, 0);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
        items[activeIdx].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (activeIdx >= 0 && activeIdx < items.length) {
          selectSupplier(items[activeIdx].dataset.value);
        }
      } else if (e.key === 'Escape') {
        if (dropdown) dropdown.classList.remove('open');
      }
    });

    /* â”€â”€ Smart supplier address lookup (exact â†’ case-insensitive â†’ partial) â”€â”€ */
    function lookupSupplierAddress(name) {
      if (!name) return '';

      /* 1. Exact match */
      if (brokerAddressMap[name]) return brokerAddressMap[name];

      var nameLower = name.trim().toLowerCase();

      /* 2. Case-insensitive match */
      for (var key in brokerAddressMap) {
        if (key.toLowerCase() === nameLower) return brokerAddressMap[key];
      }

      /* 3. Partial match â€” input is substring of a key, or key is substring of input */
      var best = '';
      var bestLen = 0;
      for (var key in brokerAddressMap) {
        if (!brokerAddressMap[key]) continue;
        var keyLower = key.toLowerCase();
        if (keyLower.includes(nameLower) || nameLower.includes(keyLower)) {
          /* Prefer longest matching key (most specific) */
          if (key.length > bestLen) {
            best = brokerAddressMap[key];
            bestLen = key.length;
          }
        }
      }

      return best;
    }

    /* â”€â”€ Address / validation â”€â”€ */
    function updateSupplierAddress() {
      const account = getField('account_name');
      const current = getField('supplier_address');
      const suggested = lookupSupplierAddress(account);
      if (!current || current === suggested || brokerNames.includes(account)) {
        setField('supplier_address', suggested);
      }
    }

    function validateAccount() {
      const account = getField('account_name');
      const valid = brokerNames.includes(account);
      var elErr = document.getElementById('account-error');
      if (elErr) elErr.classList.toggle('hidden', valid);
      if (!valid) {
        var elAddr = document.getElementById('supplier_address');
        if (elAddr) elAddr.value = '';
      }
      return valid;
    }

    /* â”€â”€ HTML escaping (used throughout) â”€â”€ */
    function escHtml(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* â”€â”€ Line items â”€â”€ */
    let lineItemCounter = 0;
    const MOVEMENT_TYPES = ['', 'Remove', 'Uplift', 'Exchange', 'WWL', 'Delivery'];
    const CONTAINER_TYPES = ['Green Steel', 'Magnum', 'Collapsible', 'Pallet', 'Non-Linear Crate', 'Durapipe', 'Battery POD'];

    /* WEEE category number â†’ name mapping */
    const WEEE_CATEGORIES = {
      1: 'Large Household Appliances',
      2: 'Small Household Appliances',
      3: 'IT and Telecommunications Equipment',
      4: 'Consumer Equipment',
      5: 'Lighting Equipment',
      6: 'Electrical and Electronic Tools',
      7: 'Toys, Leisure and Sports Equipment',
      8: 'Medical Devices',
      9: 'Monitoring and Control Equipment',
      10: 'Automatic Dispensers',
      11: 'Display Equipment',
      12: 'Appliances Containing Refrigerants',
      13: 'Gas Discharge Lamps and LED Light Sources',
      14: 'PV Panels (Solar Panels)',
      15: 'Vapes and Electronic Cigarettes'
    };

    /* Parse a WEEE number from a waste_stream string like "13. Gas Discharge..." or just "13" */
    function parseWeeeNum(ws) {
      if (!ws) return '';
      var s = String(ws).trim();
      /* If it's just a number */
      var n = parseInt(s, 10);
      if (n >= 1 && n <= 15 && String(n) === s) return String(n);
      /* If it starts with "N. " */
      var m = s.match(/^(\d{1,2})\.\s/);
      if (m && parseInt(m[1],10) >= 1 && parseInt(m[1],10) <= 15) return m[1];
      /* Try matching by category name */
      var lower = s.toLowerCase();
      for (var k = 1; k <= 15; k++) {
        if (lower === WEEE_CATEGORIES[k].toLowerCase()) return String(k);
        if (lower === k + '. ' + WEEE_CATEGORIES[k].toLowerCase()) return String(k);
      }
      return '';
    }

    function addLineItem(desc, movementType, price, isDocTypeLine, containerType, wasteStream) {
      const containerEl = document.getElementById('line-items-container');
      const idx = lineItemCounter++;
      const row = document.createElement('div');
      row.className = 'line-item-row';
      row.dataset.liIdx = idx;
      if (isDocTypeLine) row.dataset.docTypeLine = 'true';
      var ctOptions = CONTAINER_TYPES.map(function(ct) {
        var sel = (containerType || 'Magnum') === ct ? ' selected' : '';
        return '<option value="' + escHtml(ct) + '"' + sel + '>' + escHtml(ct) + '</option>';
      }).join('');
      /* WEEE # dropdown (1-15) */
      var weeeNum = parseWeeeNum(wasteStream);
      var weeeOpts = '<option value="">\u2014</option>';
      for (var w = 1; w <= 15; w++) {
        var wSel = (weeeNum === String(w)) ? ' selected' : '';
        weeeOpts += '<option value="' + w + '"' + wSel + '>' + w + '</option>';
      }
      /* Tooltip text for current selection */
      var tooltipText = weeeNum ? WEEE_CATEGORIES[parseInt(weeeNum,10)] || '' : '';
      var mtOptions = MOVEMENT_TYPES.map(function(mt) {
        var sel = (movementType || '') === mt ? ' selected' : '';
        var label = mt || '\u2014';
        return '<option value="' + escHtml(mt) + '"' + sel + '>' + escHtml(label) + '</option>';
      }).join('');
      var priceVal = (price != null && price !== '') ? parseFloat(price) : 0;
      var descVal = desc || '';
      row.innerHTML =
        '<div><select class="li-container">' + ctOptions + '</select></div>' +
        '<div><div class="weee-wrap"><select class="li-weee-num" onchange="updateWeeeTooltip(this)">' + weeeOpts + '</select><span class="weee-tooltip">' + escHtml(tooltipText) + '</span></div></div>' +
        '<div><input type="text" class="li-waste-desc" value="' + escHtml(descVal) + '" placeholder="Product description" /></div>' +
        '<div><select class="li-movement">' + mtOptions + '</select></div>' +
        '<div><div class="li-price-wrap"><span class="li-price-prefix">\u00a3</span><input type="number" class="li-price" value="' + priceVal.toFixed(2) + '" min="0" step="0.01" onchange="recalcOverallTotal()" /></div></div>' +
        '<div style="padding-bottom:1px;"><button class="btn-remove" type="button" onclick="removeLineItem(this)">&times;</button></div>';
      containerEl.appendChild(row);
      recalcOverallTotal();
    }

    function updateWeeeTooltip(sel) {
      var num = parseInt(sel.value, 10);
      var tooltip = sel.closest('.weee-wrap').querySelector('.weee-tooltip');
      if (tooltip) tooltip.textContent = (num >= 1 && num <= 15) ? WEEE_CATEGORIES[num] : '';
    }

    /* Format waste stream display: "{WEEE Category Name} | {Product Description}" */
    function formatWasteStreamDisplay(li) {
      var cat = li.weee_category || '';
      var desc = li.description || '';
      if (cat && desc) return cat + ' | ' + desc;
      if (cat) return cat;
      if (desc) return desc;
      return li.waste_stream || '';
    }

    /* Two-line waste stream: returns {weee: "13. Gas Discharge...", desc: "Lamp Green..."} */
    function wasteStreamParts(li) {
      var cat = li.weee_category || '';
      var num = li.weee_number || '';
      var desc = li.description || '';
      // Try to resolve number from category name
      if (cat && !num) {
        for (var n in WEEE_CATEGORIES) {
          if (WEEE_CATEGORIES[n] === cat) { num = n; break; }
        }
      }
      // Try to parse from waste_stream string "N. Category Name"
      if (!cat && li.waste_stream) {
        var m = (li.waste_stream || '').match(/^(\d{1,2})\.\s+(.+)/);
        if (m) { num = m[1]; cat = m[2].trim(); }
        else {
          for (var n2 in WEEE_CATEGORIES) {
            if (WEEE_CATEGORIES[n2] === li.waste_stream) { num = n2; cat = li.waste_stream; break; }
          }
        }
      }
      var weeeLine = (cat && num) ? num + '. ' + cat : cat;
      return { weee: weeeLine, desc: desc };
    }

    function removeLineItem(btn) {
      var row = btn.closest('.line-item-row');
      /* If removing a doc-type auto-added line, reset the tracking */
      if (row.dataset.docTypeLine === 'true') {
        _docTypeLineAdded = '';
      }
      row.remove();
      recalcOverallTotal();
    }

    function recalcOverallTotal() {
      let total = 0;
      document.querySelectorAll('#line-items-container .line-item-row').forEach(row => {
        total += parseFloat(row.querySelector('.li-price').value) || 0;
      });
      document.getElementById('overall_total_display').textContent = '\u00a3' + total.toFixed(2);
    }

    function getLineItems() {
      const items = [];
      document.querySelectorAll('#line-items-container .line-item-row').forEach(row => {
        var weeeNum = (row.querySelector('.li-weee-num') || {}).value || '';
        var weeeCategory = (weeeNum && WEEE_CATEGORIES[parseInt(weeeNum,10)]) || '';
        var descText = (row.querySelector('.li-waste-desc') || {}).value || '';
        /* Build waste_stream: "N. Category Name" for backward compat, or empty */
        var wsVal = weeeNum ? (weeeNum + '. ' + weeeCategory) : '';
        items.push({
          container: (row.querySelector('.li-container') || {}).value || 'Magnum',
          waste_stream: wsVal,
          weee_number: weeeNum,
          weee_category: weeeCategory,
          description: descText,
          movement_type: (row.querySelector('.li-movement') || {}).value || '',
          price: parseFloat((row.querySelector('.li-price') || {}).value) || 0
        });
      });
      return items;
    }

    function clearLineItems() {
      document.getElementById('line-items-container').innerHTML = '';
      lineItemCounter = 0;
      _docTypeLineAdded = '';
      recalcOverallTotal();
    }

    /* â”€â”€ Document Type change handler (no longer auto-adds Â£40 line) â”€â”€ */
    var _docTypeLineAdded = '';  /* Kept for compatibility */

    function onDocTypeChange() {
      /* No auto-add â€” the Â£40 line is injected only in PDF/HubSpot/email/webhook outputs */
    }

    /* â”€â”€ Fill form from extraction response â”€â”€ */
    var _lastExtractedData = null;  /* Stored for template save */
    var _lastConfidence = null;
    var _lastSupplierTrained = false;

    function fillForm(data, confidence, supplierTrained) {
      _lastExtractedData = JSON.parse(JSON.stringify(data));
      _lastConfidence = confidence || {};
      _lastSupplierTrained = !!supplierTrained;

      [
        'supplier', 'purchase_order_number', 'service_description',
        'customer_name', 'sic_code',
        'site_contact', 'site_contact_number', 'site_contact_email',
        'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
        'site_name', 'site_address', 'site_postcode',
        'opening_times', 'access', 'site_restrictions', 'special_instructions'
      ].forEach(key => setField(key, data[key]));

      /* Pre-fill account name with extracted supplier (if it matches a broker) */
      setField('account_name', data.account_name || '');

      /* Document Type: set to extracted value or empty */
      var docType = (data.document_type || '').trim();
      if (docType !== 'Consignment Note' && docType !== 'Waste Transfer Note') docType = '';
      setField('document_type', docType);

      /* Update document header */
      const supplierName = data.supplier || 'Unknown Supplier';
      const poNum = data.purchase_order_number || '';
      document.getElementById('doc-title').textContent = 'Purchase Order' + (poNum ? ' \u2014 ' + poNum : '');
      document.getElementById('doc-supplier-label').textContent = 'From: ' + supplierName;

      /* Set supplier address from pre-filled account name */
      updateSupplierAddress();
      validateAccount();

      /* Populate line items (map from old format to new) */
      clearLineItems();
      const items = data.line_items || [];
      items.forEach(item => {
        var price = item.price != null ? item.price : (item.line_total || item.unit_price || 0);
        addLineItem(item.description, item.movement_type || '', price, false, item.container || 'Magnum', item.waste_stream || '');
      });

      /* Document type change (no longer auto-adds Â£40 line) */
      onDocTypeChange();

      /* Render confidence dots */
      renderConfidenceDots(confidence || {});

      /* Show template prompt for untrained suppliers */
      showTemplatePrompt(supplierName, supplierTrained);
    }

    /* â”€â”€ Collect payload â”€â”€ */
    function collectReviewPayload() {
      const items = getLineItems();
      const overallTotal = items.reduce((sum, i) => sum + (i.price || 0), 0);
      return {
        account_name: getField('account_name'),
        supplier_address: getField('supplier_address'),
        purchase_order_number: getField('purchase_order_number'),
        service_description: getField('service_description'),
        document_type: getField('document_type'),
        customer_name: getField('customer_name'),
        sic_code: getField('sic_code'),
        site_contact: getField('site_contact'),
        site_contact_number: getField('site_contact_number'),
        site_contact_email: getField('site_contact_email'),
        secondary_site_contact: getField('secondary_site_contact'),
        secondary_site_contact_number: getField('secondary_site_contact_number'),
        secondary_site_contact_email: getField('secondary_site_contact_email'),
        site_name: getField('site_name'),
        site_address: getField('site_address'),
        site_postcode: getField('site_postcode'),
        opening_times: getField('opening_times'),
        access: getField('access'),
        site_restrictions: getField('site_restrictions'),
        special_instructions: getField('special_instructions'),
        line_items: items,
        overall_total: overallTotal
      };
    }

    /* â”€â”€ Download PDF â”€â”€ */
    async function downloadReviewPDF() {
      if (!validateAccount()) return;
      const btn = document.getElementById('btn-download');
      const origText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Generating PDF\u2026';
      const payload = collectReviewPayload();
      try {
        const resp = await fetch('/download-review-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ error: 'Unable to download PDF' }));
          throw new Error(err.error || 'Unable to download PDF');
        }
        const blob = await resp.blob();
        if (blob.size === 0) throw new Error('Received empty PDF \u2014 please try again');
        const disposition = resp.headers.get('Content-Disposition') || '';
        const match = disposition.match(/filename[^;=\n]*=\s*(?:UTF-8''|"?)([^";\n]+)/i);
        const filename = match ? decodeURIComponent(match[1].replace(/"/g, '')) : 'review.pdf';
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 2000);
        showToast('PDF downloaded successfully');
      } catch (err) { alert(err.message); }
      finally { btn.disabled = false; btn.textContent = origText; }
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => { if (toast) toast.classList.remove('show'); }, 2000);
    }

    /* â”€â”€ Progress bar helpers â”€â”€ */
    var progressTimer = null;
    var currentProgress = 0;

    function startProgress() {
      currentProgress = 0;
      updateProgressUI(0);
      progressTimer = setInterval(function() {
        /* Ease towards 90% â€” slows as it approaches */
        var remaining = 90 - currentProgress;
        currentProgress += remaining * 0.03;
        if (currentProgress > 89.5) currentProgress = 90;
        updateProgressUI(currentProgress);
        if (currentProgress >= 90) clearInterval(progressTimer);
      }, 200);
    }

    function finishProgress() {
      clearInterval(progressTimer);
      currentProgress = 100;
      updateProgressUI(100);
    }

    function resetProgress() {
      clearInterval(progressTimer);
      currentProgress = 0;
      updateProgressUI(0);
    }

    function updateProgressUI(pct) {
      var rounded = Math.round(pct);
      var pctEl = document.getElementById('progress-pct');
      var fillEl = document.getElementById('progress-fill');
      if (pctEl) pctEl.textContent = rounded + '%';
      if (fillEl) fillEl.style.width = rounded + '%';
    }

    /* â”€â”€ Upload & extract â”€â”€ */
    async function uploadAndExtract(file) {
      /* Transition to scanning state (removes upload card, shows animation) */
      setState('scanning', file.name);

      const fd = new FormData();
      fd.append('pdf', file);

      try {
        const resp = await fetch('/extract', { method: 'POST', body: fd });
        const json = await resp.json();
        if (!resp.ok || json.error) throw new Error(json.error || 'Extraction failed');

        /* Jump progress to 100% */
        finishProgress();

        /* Brief delay so user sees 100% before transition (~500ms) */
        await new Promise(function(r) { setTimeout(r, 500); });

        /* Transition to results state (removes scanning, shows edit card) */
        setState('results');
        fillForm(json.data || {}, json.confidence || {}, json.supplier_trained);
        requestAnimationFrame(function() { if (editCard) editCard.classList.add('fade-in'); });

        /* Data ready â€” user can now send to WasteLogics manually */
      } catch (err) {
        alert(err.message);
        setState('upload');
      }
    }

    /* â”€â”€ Drag & drop â”€â”€ */
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      if (dropZone) dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => {
      if (dropZone) dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      if (dropZone) dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.pdf')) uploadAndExtract(file);
    });
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) uploadAndExtract(file);
    });

    /* â”€â”€ Initialize: show only upload state â”€â”€ */
    setState('upload');

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HubSpot Integration
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    var uploadedFileName = '';  /* Stored when file is uploaded */

    /* â”€â”€ HubSpot Owners cache â”€â”€ */
    var _cachedOwners = null; /* [{id, firstName, lastName, name, email}] */

    async function ensureOwnersLoaded() {
      if (_cachedOwners) return _cachedOwners;
      try {
        var resp = await fetch('/api/hubspot/owners');
        var data = await resp.json();
        if (resp.ok && data.owners) {
          _cachedOwners = data.owners;
        } else {
          _cachedOwners = [];
        }
      } catch(e) {
        _cachedOwners = [];
      }
      return _cachedOwners;
    }

    function getLastSelectedOwnerId() {
      try { return localStorage.getItem('hs_deal_owner_id') || ''; } catch(e) { return ''; }
    }

    function saveLastSelectedOwnerId(id) {
      try { localStorage.setItem('hs_deal_owner_id', id); } catch(e) { /* ignore */ }
    }

    function getDefaultOwnerId(owners) {
      /* 1. Last selection from localStorage */
      var lastId = getLastSelectedOwnerId();
      if (lastId && owners.some(function(o) { return o.id === lastId; })) return lastId;
      /* 2. Emma Dedeke */
      var emma = owners.find(function(o) { return o.name.toLowerCase() === 'emma dedeke'; });
      if (emma) return emma.id;
      /* 3. First owner */
      return owners.length ? owners[0].id : '';
    }

    /* â”€â”€ Test HubSpot Connection â”€â”€ */
    async function testHubSpotConnection() {
      var btn = document.getElementById('btn-hs-test');
      var output = document.getElementById('hs-test-output');
      btn.disabled = true;
      btn.textContent = 'Testingâ€¦';
      output.classList.remove('hidden');
      output.textContent = 'Connecting to HubSpotâ€¦';
      try {
        var resp = await fetch('/api/hubspot/test');
        var data = await resp.json();
        output.textContent = JSON.stringify(data, null, 2);
      } catch(err) {
        output.textContent = 'Error: ' + err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test HubSpot Connection';
      }
    }

    /* Patch uploadAndExtract to remember filename */
    var _origUploadAndExtract = uploadAndExtract;
    uploadAndExtract = async function(file) {
      uploadedFileName = file.name.replace(/\.pdf$/i, '');
      return _origUploadAndExtract(file);
    };

    /* â”€â”€ Settings modal â”€â”€ */
    function openSettingsModal() {
      var root = document.getElementById('settings-modal-root');
      root.innerHTML =
        '<div class="settings-overlay" id="settings-overlay" onclick="if(event.target===this)closeSettingsModal()">' +
          '<div class="settings-modal">' +
            '<div class="settings-modal-head">' +
              '<span>Settings</span>' +
              '<button class="close-x" type="button" onclick="closeSettingsModal()">&times;</button>' +
            '</div>' +
            '<div class="settings-modal-body">' +
              '<div style="margin-bottom:18px;">' +
                '<h3 style="margin:0 0 12px; font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:#c0cdd8;">HubSpot Integration</h3>' +
                '<div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start; margin-bottom:10px;">' +
                  '<button class="btn-outline" type="button" onclick="fetchHubSpotOwners()" id="btn-fetch-owners">Fetch HubSpot Owners</button>' +
                  '<div style="display:flex; flex-direction:column; gap:3px;">' +
                    '<button class="btn-debug" type="button" onclick="testHubSpotConnection()" id="btn-hs-test">Test HubSpot Connection</button>' +
                    '<span style="font-size:10px; color:#6b7280;">Developer use only</span>' +
                  '</div>' +
                '</div>' +
                '<pre id="hs-test-output" class="hidden" style="margin-top:10px; background:#0d1b28; border:1px solid #2a4054; border-radius:4px; padding:14px; color:#c8dce8; font-size:12px; line-height:1.5; white-space:pre-wrap; word-break:break-word; max-height:300px; overflow:auto;"></pre>' +
                '<div id="owners-list-container" class="owners-list hidden"></div>' +
              '</div>' +
              '<div style="border-top:1px solid #2f4a60; padding-top:14px; margin-bottom:18px;">' +
                '<h3 style="margin:0 0 10px; font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:#c0cdd8;">Customer Delivery Email</h3>' +
                '<div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">' +
                  '<label style="margin:0; font-size:11px; font-weight:600; color:#8aa3b8;">Delivery email address</label>' +
                  helpTooltip('The email address where extracted PDFs are sent when you click \'Send to Customer Delivery\'.', 'right') +
                '</div>' +
                '<input type="email" id="settings-delivery-email" value="' + escHtml(getDeliveryEmail()) + '" style="width:100%; border:1px solid #3d5a73; border-radius:4px; padding:10px 12px; font-size:14px; font-family:Montserrat,sans-serif; background:#1e2e3d; color:#e8ecf1;" onchange="saveDeliveryEmail(this.value)" />' +
                '<div style="margin-top:6px; font-size:10px; color:#6b7280;">Emails sent via Microsoft Graph API from orders@wasteexperts.co.uk</div>' +
              '</div>' +
              '<div style="border-top:1px solid #2f4a60; padding-top:14px;">' +
                '<div class="collapsible-header" id="templates-toggle" onclick="toggleTemplatesSection()">' +
                  '<span class="collapsible-chevron" id="templates-chevron">&#9656;</span>' +
                  '<h3>Supplier Templates</h3>' +
                  helpTooltip('Train the system to recognise different supplier PO formats. Upload a sample PDF from each supplier and correct the extraction. Once trained, future POs from that supplier will extract more accurately.', 'right') +
                '</div>' +
                '<div class="collapsible-body" id="templates-body">' +
                  '<div class="template-progress">' +
                    '<div class="template-progress-text" id="template-progress-label">Loading suppliers...</div>' +
                    helpTooltip('Shows how many of your suppliers have been trained. The more you train, the better the extraction accuracy across all your purchase orders.', 'right') +
                    '<div class="progress-track" style="margin-top:6px;">' +
                      '<div class="progress-fill" id="template-progress-fill" style="width:0%; background:#8EC431;"></div>' +
                    '</div>' +
                  '</div>' +
                  '<div class="template-search">' +
                    '<input type="text" id="template-search-input" placeholder="Search suppliers..." oninput="filterTemplateList(this.value)" />' +
                  '</div>' +
                  '<div id="template-supplier-list" class="template-list"></div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      /* Re-load templates into the fresh modal DOM */
      loadTemplates();
    }

    function closeSettingsModal() {
      document.getElementById('settings-modal-root').innerHTML = '';
    }

    function toggleTemplatesSection() {
      var header = document.getElementById('templates-toggle');
      var body = document.getElementById('templates-body');
      if (!header || !body) return;
      header.classList.toggle('open');
      body.classList.toggle('open');
    }

    /* â”€â”€ Fetch HubSpot Owners â”€â”€ */
    async function fetchHubSpotOwners() {
      var btn = document.getElementById('btn-fetch-owners');
      var container = document.getElementById('owners-list-container');
      if (!btn || !container) return;
      btn.disabled = true;
      btn.textContent = 'Fetchingâ€¦';
      try {
        var resp = await fetch('/api/hubspot/owners');
        var data = await resp.json();
        if (!resp.ok || data.error) throw new Error(data.error || 'Failed to fetch owners');
        var owners = data.owners || [];
        container.innerHTML = owners.map(function(o) {
          return '<div class="owner-row"><span>' + escHtml(o.name) + ' <span style="color:#5a7a94">(' + escHtml(o.email) + ')</span></span><span class="owner-id">' + escHtml(o.id) + '</span></div>';
        }).join('');
        if (!owners.length) container.innerHTML = '<div style="color:#8aa3b8; padding:8px 0;">No owners found</div>';
        container.classList.remove('hidden');
        if (data.nathan_id) {
          showToast('Nathan Malone found â€” Owner ID: ' + data.nathan_id);
        }
      } catch(err) {
        container.innerHTML = '<div style="color:#f87171; padding:8px 0;">' + escHtml(err.message) + '</div>';
        container.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Fetch HubSpot Owners';
      }
    }

    /* â”€â”€ HubSpot preview modal â”€â”€ */
    async function openHubSpotPreview() {
      var payload = collectReviewPayload();
      var dealName = uploadedFileName || 'Untitled Deal';
      var today = new Date().toISOString().split('T')[0];
      var totalAmount = (payload.overall_total || 0).toFixed(2);
      var poNumber = payload.purchase_order_number || 'â€”';
      var supplierName = payload.account_name || payload.supplier || '';
      var items = payload.line_items || [];

      /* Fetch owners (cached after first call) */
      var owners = await ensureOwnersLoaded();
      var defaultId = getDefaultOwnerId(owners);

      /* Build owner dropdown options */
      var ownerOptionsHtml = '';
      if (owners.length) {
        owners.forEach(function(o) {
          var sel = o.id === defaultId ? ' selected' : '';
          ownerOptionsHtml += '<option value="' + escHtml(o.id) + '"' + sel + '>' + escHtml(o.name) + '</option>';
        });
      } else {
        ownerOptionsHtml = '<option value="">No owners available</option>';
      }

      /* Build description from line items + delivery details (two-line waste stream) */
      var desc = items.map(function(li, i) {
        var ct = li.container ? li.container + ' | ' : '';
        var parts = wasteStreamParts(li);
        var mt = li.movement_type ? ' [' + li.movement_type + ']' : '';
        if (parts.weee && parts.desc) {
          return (i+1) + '. ' + ct + parts.weee + '\n   ' + parts.desc + mt + ' \u2014 \u00a3' + (li.price||0).toFixed(2);
        }
        return (i+1) + '. ' + ct + (parts.weee || parts.desc || 'Item') + mt + ' \u2014 \u00a3' + (li.price||0).toFixed(2);
      }).join('\n');

      /* Append delivery details to description */
      var ddFields = [
        ['Account Name (WL)', payload.account_name],
        ['Supplier', 'Waste Experts'],
        ['Site Contact', payload.site_contact],
        ['Site Contact Number', payload.site_contact_number],
        ['Site Contact Email', payload.site_contact_email],
        ['Site Name', payload.site_name],
        ['Site Address', payload.site_address],
        ['Site Postcode', payload.site_postcode],
        ['Opening Times', payload.opening_times],
        ['Access', payload.access],
        ['Site Restrictions', payload.site_restrictions],
        ['Special Instructions', payload.special_instructions]
      ];
      var ddDesc = ddFields.filter(function(f) { return f[1]; }).map(function(f) { return f[0] + ': ' + f[1]; }).join('\n');
      if (ddDesc) desc += '\n\nDelivery Details:\n' + ddDesc;

      /* Build line items table (two-line waste stream) */
      var liHtml = '';
      if (items.length) {
        liHtml = '<table class="hs-li-table"><thead><tr><th>Container</th><th>Waste Stream</th><th>Movement</th><th>Price</th></tr></thead><tbody>';
        items.forEach(function(li) {
          var pts = wasteStreamParts(li);
          var wsCell = '';
          if (pts.weee && pts.desc) {
            wsCell = '<span style="font-size:10px;color:#718096;">' + escHtml(pts.weee) + '</span><br/>' + escHtml(pts.desc);
          } else {
            wsCell = escHtml(pts.weee || pts.desc || formatWasteStreamDisplay(li) || '\u2014');
          }
          liHtml += '<tr><td>' + escHtml(li.container || '\u2014') + '</td><td>' + wsCell + '</td><td>' + escHtml(li.movement_type || '\u2014') + '</td><td>\u00a3' + (li.price||0).toFixed(2) + '</td></tr>';
        });
        liHtml += '</tbody></table>';
      } else {
        liHtml = '<div style="color:#8aa3b8; font-size:12px;">No line items</div>';
      }

      var modalHtml =
        '<div class="hs-overlay" id="hs-overlay" onclick="if(event.target===this)closeHubSpotModal()">' +
          '<div class="hs-modal">' +
            '<div class="hs-modal-head">' +
              '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.83 11.41V7.55a2.2 2.2 0 0 0 1.27-1.98 2.22 2.22 0 0 0-2.22-2.22h-.04V1.5a.75.75 0 0 0-1.5 0v1.85h-.04a2.22 2.22 0 0 0-2.22 2.22c0 .9.54 1.67 1.31 2.01v3.83a5.1 5.1 0 0 0-2.53 1.27l-6.63-5.16a2.03 2.03 0 0 0 .05-.42 2.08 2.08 0 1 0-2.08 2.08c.4 0 .77-.12 1.09-.32l6.45 5.02a5.17 5.17 0 0 0 .42 5.53l-1.79 1.79a1.7 1.7 0 0 0-.5-.08 1.72 1.72 0 1 0 1.72 1.72c0-.17-.03-.34-.08-.5l1.76-1.76a5.18 5.18 0 1 0 5.96-8.52zM16.84 18a2.68 2.68 0 1 1 0-5.37 2.68 2.68 0 0 1 0 5.37z"/></svg>' +
              'HubSpot Deal Preview' +
            '</div>' +
            '<div class="hs-modal-body">' +
              /* â”€â”€ Deal Owner dropdown (above deal details) â”€â”€ */
              '<div style="margin-bottom:16px;">' +
                '<div style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">' +
                  '<label style="margin:0; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.3px; color:#8ec431;">Deal Owner</label>' +
                  '<span class="help-tooltip-wrap" style="margin-left:0;">' +
                    '<span class="help-tooltip-icon">?</span>' +
                    '<span class="help-tooltip-popup help-tooltip-popup--right">Choose who this deal will be assigned to in HubSpot. Your last selection is remembered.</span>' +
                  '</span>' +
                '</div>' +
                '<select id="hs-owner-select" style="width:100%; border:1px solid #3d5a73; border-radius:4px; padding:10px 12px; font-size:14px; font-family:Montserrat,sans-serif; background:#1e2e3d; color:#e8ecf1;" onchange="saveLastSelectedOwnerId(this.value)">' +
                  ownerOptionsHtml +
                '</select>' +
              '</div>' +

              '<div class="hs-section">Deal Properties</div>' +
              '<div class="hs-row"><span class="hs-label">Deal Name</span><span class="hs-value">' + escHtml(dealName) + '</span></div>' +
              '<div class="hs-row"><span class="hs-label">Create Date</span><span class="hs-value">' + today + '</span></div>' +
              '<div class="hs-row"><span class="hs-label">Close Date</span><span class="hs-value">' + today + '</span></div>' +
              '<div class="hs-row"><span class="hs-label">Forecast Amount</span><span class="hs-value">Â£' + totalAmount + '</span></div>' +
              '<div class="hs-row"><span class="hs-label">Is Deal Closed</span><span class="hs-value">Yes</span></div>' +
              '<div class="hs-row"><span class="hs-label">PO Number</span><span class="hs-value">' + escHtml(poNumber) + '</span></div>' +

              '<div class="hs-section">Line Items</div>' +
              liHtml +

              '<div class="hs-section">Company Association</div>' +
              '<div class="hs-row"><span class="hs-label">Supplier</span><span class="hs-value">' + escHtml(supplierName || 'â€”') + '</span></div>' +
              '<div style="padding:6px 0; font-size:12px; color:#8aa3b8;"><em>Company match will be checked when creating the deal</em></div>' +

              '<div class="hs-actions">' +
                '<button class="btn-outline" type="button" onclick="closeHubSpotModal()">Cancel</button>' +
                '<button class="btn-hubspot" type="button" id="btn-hs-confirm" onclick="confirmCreateDeal()">' +
                  'Confirm &amp; Create Deal' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      document.getElementById('hs-modal-root').innerHTML = modalHtml;

      /* Store deal data for submission */
      window._hsDealData = {
        deal_name: dealName,
        amount: payload.overall_total || 0,
        po_number: payload.purchase_order_number || '',
        supplier_name: supplierName,
        document_type: payload.document_type || '',
        line_items: items,
        description: desc,
        delivery_details: {
          customer_name: payload.account_name || '',
          supplier: 'Waste Experts',
          purchase_order_number: payload.purchase_order_number || '',
          site_contact: payload.site_contact || '',
          site_contact_number: payload.site_contact_number || '',
          site_contact_email: payload.site_contact_email || '',
          secondary_site_contact: payload.secondary_site_contact || '',
          secondary_site_contact_number: payload.secondary_site_contact_number || '',
          secondary_site_contact_email: payload.secondary_site_contact_email || '',
          site_name: payload.site_name || '',
          site_address: payload.site_address || '',
          site_postcode: payload.site_postcode || '',
          opening_times: payload.opening_times || '',
          access: payload.access || '',
          site_restrictions: payload.site_restrictions || '',
          special_instructions: payload.special_instructions || ''
        }
      };
    }

    function closeHubSpotModal() {
      document.getElementById('hs-modal-root').innerHTML = '';
    }

    /* â”€â”€ Create deal â”€â”€ */
    async function confirmCreateDeal() {
      var btn = document.getElementById('btn-hs-confirm');
      btn.disabled = true;
      btn.textContent = 'Creating dealâ€¦';

      /* Include selected owner ID */
      var ownerSelect = document.getElementById('hs-owner-select');
      if (ownerSelect && ownerSelect.value) {
        window._hsDealData.owner_id = ownerSelect.value;
        saveLastSelectedOwnerId(ownerSelect.value);
      }

      try {
        var resp = await fetch('/api/hubspot/create-deal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(window._hsDealData)
        });
        var data = await resp.json();

        if (!resp.ok || data.error) {
          throw new Error(data.error || 'Failed to create deal');
        }

        closeHubSpotModal();

        /* Success banner */
        var bannerHtml = '<div class="hs-banner success">' +
          '<span>Deal created in HubSpot &#10003;</span>' +
          '<a href="' + escHtml(data.deal_url) + '" target="_blank" rel="noopener">View in HubSpot</a>';

        if (!data.company_id) {
          bannerHtml += '<div style="width:100%; font-size:11px; margin-top:4px; color:#8aa3b8;">No matching company found in HubSpot â€” deal created without association. You can link it manually.</div>';
        } else {
          bannerHtml += '<div style="width:100%; font-size:11px; margin-top:4px;"><span class="hs-match found">&#10003; Company matched: ' + escHtml(data.company_found || 'Unknown') + '</span></div>';
        }

        if (data.po_number_warning) {
          bannerHtml += '<div style="width:100%; font-size:11px; margin-top:4px; color:#ff7a59;">' + escHtml(data.po_number_warning) + '</div>';
        }

        if (data.association_warnings && data.association_warnings.length) {
          data.association_warnings.forEach(function(w) {
            bannerHtml += '<div style="width:100%; font-size:11px; margin-top:2px; color:#ff7a59;">' + escHtml(w) + '</div>';
          });
        }

        bannerHtml += '<span class="hs-banner-close" onclick="this.parentNode.remove()">&#10005;</span></div>';
        document.getElementById('hs-banner-area').innerHTML = bannerHtml;

      } catch(err) {
        closeHubSpotModal();

        /* Error banner with retry */
        var errHtml = '<div class="hs-banner error">' +
          '<span>' + escHtml(err.message) + '</span>' +
          '<button class="btn-hubspot" style="padding:6px 12px; font-size:12px;" onclick="openHubSpotPreview()">Retry</button>' +
          '<span class="hs-banner-close" onclick="this.parentNode.remove()">&#10005;</span>' +
          '</div>';
        document.getElementById('hs-banner-area').innerHTML = errHtml;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Supplier Template Training System
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    var _allTemplateSuppliers = [];

    /* â”€â”€ Load & render templates in settings â”€â”€ */
    async function loadTemplates() {
      try {
        var resp = await fetch('/api/templates');
        var data = await resp.json();
        _allTemplateSuppliers = data.suppliers || [];
        renderTemplateList(_allTemplateSuppliers, data.trained_count, data.total_count);
      } catch(e) {
        var el = document.getElementById('template-progress-label');
        if (el) el.textContent = 'Failed to load suppliers';
      }
    }

    function renderTemplateList(suppliers, trainedCount, totalCount) {
      var pct = totalCount > 0 ? Math.round((trainedCount / totalCount) * 100) : 0;
      var progLabel = document.getElementById('template-progress-label');
      var progFill = document.getElementById('template-progress-fill');
      if (progLabel) progLabel.textContent = trainedCount + '/' + totalCount + ' suppliers trained';
      if (progFill) progFill.style.width = pct + '%';

      var sorted = suppliers.slice().sort(function(a, b) {
        if (a.trained !== b.trained) return a.trained ? 1 : -1;
        return a.name.localeCompare(b.name);
      });

      var container = document.getElementById('template-supplier-list');
      if (!container) return;
      container.innerHTML = sorted.map(function(s) {
        var badge = s.trained
          ? '<span class="badge-trained">Trained</span>'
          : '<span class="badge-untrained">Untrained</span>';
        var dateStr = s.trained_date
          ? '<span class="tmpl-date">' + new Date(s.trained_date).toLocaleDateString() + '</span>'
          : '';
        var safeName = s.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        var trainBtn = '<button class="btn-train" onclick="startTraining(\'' + safeName + '\')">' + (s.trained ? 'Re-train' : 'Train') + '</button>';
        var delBtn = s.trained
          ? '<button class="btn-del-tmpl" onclick="deleteTemplate(\'' + safeName + '\')">&times;</button>'
          : '';
        return '<div class="template-row" data-supplier="' + escHtml(s.name) + '">' +
          '<span class="tmpl-name" title="' + escHtml(s.name) + '">' + escHtml(s.name) + '</span>' +
          dateStr + badge + trainBtn + delBtn + '</div>';
      }).join('');
    }

    function filterTemplateList(term) {
      var q = (term || '').trim().toLowerCase();
      document.querySelectorAll('#template-supplier-list .template-row').forEach(function(row) {
        var name = (row.getAttribute('data-supplier') || '').toLowerCase();
        row.style.display = (!q || name.indexOf(q) !== -1) ? '' : 'none';
      });
    }

    /* â”€â”€ Delete template â”€â”€ */
    async function deleteTemplate(supplier) {
      if (!confirm('Delete template for ' + supplier + '?')) return;
      try {
        await fetch('/api/templates/' + encodeURIComponent(supplier), { method: 'DELETE' });
        showToast('Template deleted');
        loadTemplates();
      } catch(e) { alert('Failed to delete template'); }
    }

    /* â”€â”€ Training flow â”€â”€ */
    var _trainingSupplier = '';
    var _trainingOriginalData = null;

    function startTraining(supplier) {
      _trainingSupplier = supplier;
      _trainingOriginalData = null;

      var html =
        '<div class="train-overlay" id="train-overlay" onclick="if(event.target===this)closeTrainingModal()">' +
          '<div class="train-modal">' +
            '<div class="train-modal-head">' +
              '<span>Train Template: ' + escHtml(supplier) + '</span>' +
              '<span class="close-x" onclick="closeTrainingModal()">&times;</span>' +
            '</div>' +
            '<div class="train-modal-body" id="train-modal-body">' +
              '<div class="train-upload-area" id="train-drop-zone">' +
                '<p style="margin:0 0 10px; color:#c0cdd8;"><strong>Upload a sample PO PDF</strong> from this supplier</p>' +
                '<button class="btn" type="button" onclick="document.getElementById(\'train-file-input\').click()">Choose PDF</button>' +
                '<input id="train-file-input" type="file" accept=".pdf" class="hidden" />' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      document.getElementById('training-modal-root').innerHTML = html;

      var trainDrop = document.getElementById('train-drop-zone');
      var trainInput = document.getElementById('train-file-input');

      trainDrop.addEventListener('dragover', function(e) { e.preventDefault(); trainDrop.classList.add('drag-over'); });
      trainDrop.addEventListener('dragleave', function() { trainDrop.classList.remove('drag-over'); });
      trainDrop.addEventListener('drop', function(e) {
        e.preventDefault(); trainDrop.classList.remove('drag-over');
        var f = e.dataTransfer.files[0];
        if (f && f.name.toLowerCase().endsWith('.pdf')) uploadTrainingPDF(f);
      });
      trainInput.addEventListener('change', function(e) {
        var f = e.target.files[0];
        if (f) uploadTrainingPDF(f);
      });
    }

    function closeTrainingModal() {
      document.getElementById('training-modal-root').innerHTML = '';
      _trainingSupplier = '';
      _trainingOriginalData = null;
    }

    async function uploadTrainingPDF(file) {
      var body = document.getElementById('train-modal-body');
      body.innerHTML =
        '<div style="text-align:center; padding:32px;">' +
          '<p style="color:#c0cdd8; margin:0 0 12px;">Extracting data from <em>' + escHtml(file.name) + '</em>...</p>' +
          '<div class="progress-track" style="width:240px; margin:0 auto;">' +
            '<div class="progress-fill" id="train-progress" style="width:0%;"></div>' +
          '</div>' +
        '</div>';

      var tp = 0;
      var tTimer = setInterval(function() {
        tp += (90 - tp) * 0.03;
        var el = document.getElementById('train-progress');
        if (el) el.style.width = Math.round(tp) + '%';
        if (tp >= 89) clearInterval(tTimer);
      }, 200);

      var fd = new FormData();
      fd.append('pdf', file);
      fd.append('training', 'true');
      fd.append('training_supplier', _trainingSupplier);

      try {
        var resp = await fetch('/extract', { method: 'POST', body: fd });
        var json = await resp.json();
        clearInterval(tTimer);
        if (!resp.ok || json.error) throw new Error(json.error || 'Extraction failed');

        _trainingOriginalData = JSON.parse(JSON.stringify(json.data || {}));
        showTrainingForm(json.data || {});
      } catch(err) {
        clearInterval(tTimer);
        body.innerHTML = '<div style="padding:20px; color:#f87171;">' + escHtml(err.message) +
          '<br><br><button class="btn-outline" onclick="closeTrainingModal()">Close</button></div>';
      }
    }

    function showTrainingForm(data) {
      var body = document.getElementById('train-modal-body');
      var fields = [
        { id: 'purchase_order_number', label: 'PO Number', type: 'input' },
        { id: 'service_description', label: 'Service Description', type: 'input', full: true },
        { id: 'document_type', label: 'Document Type', type: 'select', options: ['Consignment Note', 'Waste Transfer Note'] },
        { id: 'site_contact', label: 'Site Contact', type: 'input' },
        { id: 'site_contact_number', label: 'Contact Number', type: 'input' },
        { id: 'site_contact_email', label: 'Contact Email', type: 'input', full: true },
        { id: 'secondary_site_contact', label: 'Secondary Contact', type: 'input' },
        { id: 'secondary_site_contact_number', label: 'Sec. Contact Number', type: 'input' },
        { id: 'secondary_site_contact_email', label: 'Sec. Contact Email', type: 'input', full: true },
        { id: 'site_name', label: 'Site Name', type: 'input' },
        { id: 'site_postcode', label: 'Site Postcode', type: 'input' },
        { id: 'site_address', label: 'Site Address', type: 'textarea', full: true },
        { id: 'opening_times', label: 'Opening Times', type: 'textarea' },
        { id: 'access', label: 'Access', type: 'textarea' },
        { id: 'site_restrictions', label: 'Site Restrictions', type: 'textarea' },
        { id: 'special_instructions', label: 'Special Instructions', type: 'textarea' },
      ];

      var html = '<p style="font-size:12px; color:#8aa3b8; margin:0 0 12px;">Review and correct the extracted data, then save as template.</p>';
      html += '<div class="train-grid">';
      html += '<div class="train-section-title">Extraction Results</div>';

      fields.forEach(function(f) {
        var val = escHtml(String(data[f.id] || ''));
        var cls = f.full ? 'full' : '';
        html += '<div class="field ' + cls + '">';
        html += '<label>' + escHtml(f.label) + '</label>';
        if (f.type === 'select') {
          html += '<select id="train_' + f.id + '">';
          f.options.forEach(function(opt) {
            var sel = (data[f.id] || '') === opt ? ' selected' : '';
            html += '<option' + sel + '>' + escHtml(opt) + '</option>';
          });
          html += '</select>';
        } else if (f.type === 'textarea') {
          html += '<textarea id="train_' + f.id + '">' + val + '</textarea>';
        } else {
          html += '<input id="train_' + f.id + '" type="text" value="' + val + '" />';
        }
        html += '</div>';
      });

      html += '<div class="train-section-title">Line Items</div>';
      html += '<div class="full" id="train-line-items">';
      var items = data.line_items || [];
      if (items.length) {
        html += '<div class="train-li-row" style="border:none; padding-bottom:2px; grid-template-columns:1.5fr 2.5fr 1.5fr 1fr;">' +
          '<span style="font-size:10px; font-weight:700; color:#8aa3b8; text-transform:uppercase;">Container</span>' +
          '<span style="font-size:10px; font-weight:700; color:#8aa3b8; text-transform:uppercase;">Waste Stream</span>' +
          '<span style="font-size:10px; font-weight:700; color:#8aa3b8; text-transform:uppercase;">Movement Type</span>' +
          '<span style="font-size:10px; font-weight:700; color:#8aa3b8; text-transform:uppercase;">Price</span></div>';
        var trainContainerTypes = ['Green Steel', 'Magnum', 'Collapsible', 'Pallet', 'Non-Linear Crate', 'Durapipe', 'Battery POD'];
        var trainWsCategories = ['', '1. Large Household Appliances', '2. Small Household Appliances', '3. IT and Telecommunications Equipment', '4. Consumer Equipment', '5. Lighting Equipment', '6. Electrical and Electronic Tools', '7. Toys, Leisure and Sports Equipment', '8. Medical Devices', '9. Monitoring and Control Equipment', '10. Automatic Dispensers', '11. Display Equipment', '12. Appliances Containing Refrigerants', '13. Gas Discharge Lamps and LED Light Sources', '14. PV Panels (Solar Panels)', '15. Vapes and Electronic Cigarettes'];
        items.forEach(function(li) {
          var ctOpts = trainContainerTypes.map(function(ct) {
            var sel = (li.container || 'Magnum') === ct ? ' selected' : '';
            return '<option value="' + escHtml(ct) + '"' + sel + '>' + escHtml(ct) + '</option>';
          }).join('');
          var wsOpts = trainWsCategories.map(function(ws) {
            var sel = (li.waste_stream || '') === ws ? ' selected' : '';
            var label = ws || '\u2014';
            return '<option value="' + escHtml(ws) + '"' + sel + '>' + escHtml(label) + '</option>';
          }).join('');
          var mtOpts = ['', 'Remove', 'Uplift', 'Exchange', 'WWL', 'Delivery'].map(function(mt) {
            var sel = (li.movement_type || '') === mt ? ' selected' : '';
            var label = mt || '\u2014';
            return '<option value="' + escHtml(mt) + '"' + sel + '>' + escHtml(label) + '</option>';
          }).join('');
          var priceVal = li.price != null ? li.price : (li.line_total || li.unit_price || 0);
          html += '<div class="train-li-row" style="grid-template-columns:1.5fr 2.5fr 1.5fr 1fr;">' +
            '<select class="tli-container" style="font-size:12px; padding:6px 8px; background:#1e2e3d; color:#e8ecf1; border:1px solid #3d5a73; border-radius:4px;">' + ctOpts + '</select>' +
            '<select class="tli-desc" style="font-size:12px; padding:6px 8px; background:#1e2e3d; color:#e8ecf1; border:1px solid #3d5a73; border-radius:4px;">' + wsOpts + '</select>' +
            '<select class="tli-movement" style="font-size:12px; padding:6px 8px; background:#1e2e3d; color:#e8ecf1; border:1px solid #3d5a73; border-radius:4px;">' + mtOpts + '</select>' +
            '<input type="number" class="tli-price" value="' + (parseFloat(priceVal) || 0).toFixed(2) + '" min="0" step="0.01" />' +
            '</div>';
        });
      } else {
        html += '<div style="color:#8aa3b8; font-size:12px;">No line items extracted</div>';
      }
      html += '</div></div>';

      html += '<div class="train-actions">' +
        '<button class="btn-outline" type="button" onclick="closeTrainingModal()">Cancel</button>' +
        '<button class="btn" type="button" id="btn-save-template" onclick="saveTrainingTemplate()">Save Template</button>' +
        '</div>';

      body.innerHTML = html;
    }

    async function saveTrainingTemplate() {
      var btn = document.getElementById('btn-save-template');
      btn.disabled = true;
      btn.textContent = 'Saving\u2026';

      var corrected = {};
      ['purchase_order_number', 'service_description', 'document_type',
       'site_contact', 'site_contact_number', 'site_contact_email',
       'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
       'site_name', 'site_postcode', 'site_address',
       'opening_times', 'access', 'site_restrictions', 'special_instructions'
      ].forEach(function(f) {
        var el = document.getElementById('train_' + f);
        corrected[f] = el ? el.value.trim() : '';
      });

      var liRows = document.querySelectorAll('#train-line-items .train-li-row');
      var lineItems = [];
      liRows.forEach(function(row) {
        var desc = row.querySelector('.tli-desc');
        if (!desc) return;
        lineItems.push({
          container: (row.querySelector('.tli-container') || {}).value || 'Magnum',
          waste_stream: desc.value || '',
          description: desc.value || '',
          movement_type: (row.querySelector('.tli-movement') || {}).value || '',
          price: parseFloat((row.querySelector('.tli-price') || {}).value) || 0,
        });
      });
      corrected.line_items = lineItems;

      try {
        var resp = await fetch('/api/templates/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            supplier: _trainingSupplier,
            original_data: _trainingOriginalData || {},
            corrected_data: corrected,
          })
        });
        var data = await resp.json();
        if (!resp.ok || data.error) throw new Error(data.error || 'Failed to save template');

        closeTrainingModal();
        showToast('Template saved for ' + _trainingSupplier);
        loadTemplates();
      } catch(err) {
        alert(err.message);
        btn.disabled = false;
        btn.textContent = 'Save Template';
      }
    }

    /* â”€â”€ Confidence dots â”€â”€ */
    function renderConfidenceDots(confidence) {
      document.querySelectorAll('.conf-dot').forEach(function(d) { d.remove(); });
      document.querySelectorAll('.conf-dot-help').forEach(function(d) { d.remove(); });
      document.querySelectorAll('.conf-low-border').forEach(function(el) { el.classList.remove('conf-low-border'); });

      var fieldIds = [
        'purchase_order_number', 'service_description',
        'site_contact', 'site_contact_number', 'site_contact_email',
        'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
        'site_name', 'site_address', 'site_postcode',
        'opening_times', 'access', 'site_restrictions',
        'special_instructions', 'document_type'
      ];

      var firstDotAdded = false;
      fieldIds.forEach(function(fieldId) {
        var level = confidence[fieldId] || 'medium';
        var input = document.getElementById(fieldId);
        if (!input) return;

        var wrapper = input.closest('.field');
        if (wrapper) {
          var lbl = wrapper.querySelector('label');
          if (lbl) {
            var dot = document.createElement('span');
            dot.className = 'conf-dot ' + level;
            dot.title = level.charAt(0).toUpperCase() + level.slice(1) + ' confidence';
            lbl.appendChild(dot);
            if (!firstDotAdded) {
              firstDotAdded = true;
              var tip = document.createElement('span');
              tip.className = 'conf-dot-help';
              tip.innerHTML = helpTooltip('\ud83d\udfe2 High confidence \u2014 the system is sure about this value. \ud83d\udfe1 Medium \u2014 it may need checking. \ud83d\udd34 Low \u2014 please verify this manually.', 'right');
              lbl.appendChild(tip);
            }
          }
        }
        if (level === 'low') input.classList.add('conf-low-border');
      });
    }

    /* â”€â”€ Template prompt for untrained suppliers â”€â”€ */
    function showTemplatePrompt(supplierName, isTrained) {
      var area = document.getElementById('template-prompt-area');
      if (!area) return;
      if (isTrained || !supplierName || supplierName === 'Unknown Supplier') {
        area.innerHTML = '';
        return;
      }
      area.innerHTML =
        '<div class="template-prompt-banner">' +
          '<span>This supplier hasn\'t been trained yet. Save as template?</span>' +
          helpTooltip('Training a supplier helps the system recognise their PO format. Upload one sample PO, correct any mistakes, and save it. Next time a PO from this supplier is uploaded, extraction will be more accurate.', 'right') +
          '<button class="btn-train" onclick="saveCurrentAsTemplate()" style="padding:5px 12px;">Save as Template</button>' +
          '<span class="dismiss" onclick="this.parentNode.remove()">&times;</span>' +
        '</div>';
    }

    async function saveCurrentAsTemplate() {
      var supplier = getField('supplier');
      if (!supplier) { alert('No supplier identified'); return; }
      var corrected = collectReviewPayload();
      corrected.document_type = getField('document_type');
      try {
        var resp = await fetch('/api/templates/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            supplier: supplier,
            original_data: _lastExtractedData || {},
            corrected_data: corrected,
          })
        });
        var data = await resp.json();
        if (!resp.ok || data.error) throw new Error(data.error || 'Failed to save template');
        var area = document.getElementById('template-prompt-area');
        if (area) area.innerHTML = '<div class="template-prompt-banner"><span>Template saved for ' + escHtml(supplier) + ' &#10003;</span><span class="dismiss" onclick="this.parentNode.remove()">&times;</span></div>';
        showToast('Template saved');
        loadTemplates();
      } catch(err) { alert(err.message); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Customer Delivery Email
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    var _defaultDeliveryEmail = 'solutions@wasteexperts.co.uk';

    function getDeliveryEmail() {
      try { return localStorage.getItem('delivery_email') || _defaultDeliveryEmail; } catch(e) { return _defaultDeliveryEmail; }
    }

    function saveDeliveryEmail(email) {
      try { localStorage.setItem('delivery_email', email.trim()); } catch(e) { /* ignore */ }
    }

    /* â”€â”€ Top-right toast â”€â”€ */
    var _toastTrTimer = null;
    function showToastTR(msg, type, retryFn) {
      var el = document.getElementById('toast-tr');
      if (!el) return;
      clearTimeout(_toastTrTimer);
      var html = '<span>' + escHtml(msg) + '</span>';
      if (retryFn) {
        html += '<button class="toast-retry" onclick="' + retryFn + '">Retry</button>';
      }
      html += '<span class="toast-close" onclick="hideToastTR()">&#10005;</span>';
      el.className = 'toast-tr ' + (type || 'success');
      el.innerHTML = html;
      /* Force reflow then show */
      void el.offsetWidth;
      el.classList.add('show');
      _toastTrTimer = setTimeout(hideToastTR, 5000);
    }

    function hideToastTR() {
      var el = document.getElementById('toast-tr');
      if (el) el.classList.remove('show');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       WasteLogics Webhook Integration
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    async function sendToWasteLogics() {
      var payload = collectReviewPayload();
      var btn = document.getElementById('btn-wastelogics');
      var origHTML = btn.innerHTML;

      btn.disabled = true;
      btn.innerHTML =
        '<svg width="16" height="16" viewBox="0 0 24 24" style="animation:spin 1s linear infinite;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg>' +
        ' Sending\u2026';

      try {
        var resp = await fetch('/api/send-to-webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            data: payload,
            pdf_filename: (uploadedFileName || 'unknown') + '.pdf'
          })
        });
        var result = await resp.json();

        if (result.success) {
          showToastTR('Sent to WasteLogics \u2713', 'success');
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (err) {
        showToastTR("Couldn\u2019t send to WasteLogics \u2014 " + err.message, 'warning', 'sendToWasteLogics()');
      } finally {
        btn.disabled = false;
        btn.innerHTML = origHTML;
      }
    }

    /* â”€â”€ Open confirmation modal â”€â”€ */
    function openDeliveryConfirm() {
      if (!validateAccount()) return;
      var payload = collectReviewPayload();
      var poNumber = payload.purchase_order_number || '\u2014';
      var supplierName = 'Waste Experts';
      var email = getDeliveryEmail();

      /* Build preview of delivery details email */
      var previewFields = [
        ['Account Name (WL)', payload.account_name],
        ['Supplier', 'Waste Experts'],
        ['Purchase Order Number', poNumber],
        ['Site Contact', payload.site_contact],
        ['Site Name', payload.site_name],
        ['Site Postcode', payload.site_postcode]
      ];
      var previewHtml = previewFields.map(function(f) {
        return '<div class="cd-row"><span class="cd-lbl">' + escHtml(f[0]) + '</span><span class="cd-val">' + escHtml(f[1] || '\u2014') + '</span></div>';
      }).join('');

      var modalHtml =
        '<div class="cd-overlay" id="cd-overlay" onclick="if(event.target===this)closeDeliveryModal()">' +
          '<div class="cd-modal">' +
            '<div class="cd-modal-head">' +
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,7 12,13 2,7"/></svg>' +
              'Send to Customer Delivery' +
            '</div>' +
            '<div class="cd-modal-body">' +
              '<div style="font-size:13px; color:#8aa3b8; margin-bottom:4px;">Send delivery details email to:</div>' +
              '<div class="cd-email-display">' + escHtml(email) + '</div>' +
              '<div style="font-size:11px; color:#8aa3b8; margin-bottom:6px;">Subject: Purchase Order \u2014 ' + escHtml(poNumber) + ' \u2014 ' + escHtml(supplierName) + '</div>' +
              '<div class="cd-summary">' + previewHtml + '</div>' +
              '<div style="font-size:11px; color:#5a7a94; margin-bottom:12px;">All delivery detail fields will be included in the email body. PDF attached.</div>' +
              '<div class="cd-actions">' +
                '<button class="btn-outline" type="button" onclick="closeDeliveryModal()" style="color:#8aa3b8; border-color:#4b5563;">Cancel</button>' +
                '<button class="btn" type="button" id="btn-cd-send" onclick="sendDeliveryEmail()" style="display:inline-flex; align-items:center; gap:6px;">' +
                  '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,7 12,13 2,7"/></svg>' +
                  'Send' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      document.getElementById('cd-modal-root').innerHTML = modalHtml;
    }

    function closeDeliveryModal() {
      document.getElementById('cd-modal-root').innerHTML = '';
    }

    /* â”€â”€ Send delivery email â”€â”€ */
    async function sendDeliveryEmail() {
      var btn = document.getElementById('btn-cd-send');
      if (!btn) return;
      btn.disabled = true;
      btn.innerHTML =
        '<svg width="14" height="14" viewBox="0 0 24 24" style="animation:spin 1s linear infinite;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg>' +
        ' Sending\u2026';

      var payload = collectReviewPayload();
      var email = getDeliveryEmail();

      try {
        var resp = await fetch('/api/send-delivery-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to_email: email,
            payload: payload
          })
        });
        var data = await resp.json();
        if (!resp.ok || data.error) throw new Error(data.error || 'Failed to send email');

        closeDeliveryModal();
        showToastTR('PDF sent to ' + email + ' \u2713', 'success');
      } catch(err) {
        closeDeliveryModal();
        showToastTR(err.message, 'error', 'openDeliveryConfirm()');
      }
    }

    /* Spinner keyframes for send button */
    (function() {
      var style = document.createElement('style');
      style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
      document.head.appendChild(style);
    })();

    /* â”€â”€ Init templates â”€â”€ */
    loadTemplates();

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB NAVIGATION SYSTEM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    var _activeTab = 'broker';

    function switchTab(tabName) {
      if (tabName === 'sales') return;
      if (tabName === _activeTab) return;
      _activeTab = tabName;
      document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(function(tc) {
        tc.classList.toggle('active', tc.id === tabName + '-tab-content');
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CEF TAB â€” COMPLETELY INDEPENDENT MODULE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    (function() {
      var cefAppState = 'upload';
      var cefLottieAnim = null;
      var cefProgressTimer = null;
      var cefCurrentProgress = 0;
      var cefLineItemCounter = 0;
      var cefDocTypeLineAdded = '';
      var cefLastExtractedData = null;
      var cefLastConfidence = null;
      var cefUploadedFileName = '';
      var CEF_MT = ['', 'Remove', 'Uplift', 'Exchange', 'WWL', 'Delivery'];

      /* Person details mapping */
      var CEF_PERSONS = {
        'Katie Wooton': { name: 'Katie Wooton', title: 'CEF Internal Account Manager', email: 'katie@wasteexperts.co.uk', phone: '01388 721 000' },
        'David Williams': { name: 'David Williams', title: 'CEF Team Leader', email: 'david@wasteexperts.co.uk', phone: '01388 721 000' }
      };

      function cefUpdatePreparedBy() {
        var sel = document.getElementById('cef-person-select');
        var person = sel ? sel.value : 'Katie Wooton';
        var details = CEF_PERSONS[person] || CEF_PERSONS['Katie Wooton'];
        var ne = document.getElementById('cef-prep-name');
        var te = document.getElementById('cef-prep-title');
        var ee = document.getElementById('cef-prep-email');
        var pe = document.getElementById('cef-prep-phone');
        if (ne) ne.textContent = details.name;
        if (te) te.textContent = details.title;
        if (ee) ee.textContent = details.email;
        if (pe) pe.textContent = details.phone;
      }

      /* Wire up person dropdown */
      document.getElementById('cef-person-select').addEventListener('change', cefUpdatePreparedBy);

      var cefSC = document.getElementById('cef-state-container');
      var cefUC = document.getElementById('cef-upload-card');
      var cefEC = document.getElementById('cef-edit');
      var cefFI = document.getElementById('cef-file-input');
      var cefDZ = document.getElementById('cef-drop-zone');

      function cefSF(id, v) { var el = document.getElementById(id); if (el) el.value = v || ''; }
      function cefGF(id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; }

      function cefUpdateNav() {
        var btn = document.getElementById('cef-nav-upload-btn');
        if (btn) btn.classList.toggle('nav-hidden', cefAppState === 'upload');
      }

      function cefSetState(ns, fn) {
        if (cefAppState === 'scanning') {
          clearInterval(cefProgressTimer);
          if (cefLottieAnim) { cefLottieAnim.destroy(); cefLottieAnim = null; }
        }
        while (cefSC.firstChild) cefSC.removeChild(cefSC.firstChild);
        cefAppState = ns;
        if (ns === 'upload') {
          cefFI.value = '';
          cefSC.appendChild(cefUC);
        } else if (ns === 'scanning') {
          var s = document.createElement('div');
          s.className = 'lottie-loading';
          var sf = (fn || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          s.innerHTML = '<div id="cef-lottie-player"></div>' +
            '<p class="loading-text">Scanning CEF PO <em>' + sf + '</em>. Hold tight!</p>' +
            '<div class="progress-wrap"><div class="progress-pct" id="cef-progress-pct">0%</div>' +
            '<div class="progress-track"><div class="progress-fill" id="cef-progress-fill"></div></div></div>';
          cefSC.appendChild(s);
          cefLottieAnim = lottie.loadAnimation({
            container: document.getElementById('cef-lottie-player'),
            renderer: 'svg', loop: true, autoplay: true,
            animationData: JSON.parse(JSON.stringify(scanAnimation))
          });
          cefStartProgress();
        } else if (ns === 'results') {
          cefEC.classList.remove('fade-in');
          cefSC.appendChild(cefEC);
        }
        cefUpdateNav();
      }

      function cefStartProgress() {
        cefCurrentProgress = 0; cefUpdatePUI(0);
        cefProgressTimer = setInterval(function() {
          cefCurrentProgress += (90 - cefCurrentProgress) * 0.03;
          if (cefCurrentProgress > 89.5) cefCurrentProgress = 90;
          cefUpdatePUI(cefCurrentProgress);
          if (cefCurrentProgress >= 90) clearInterval(cefProgressTimer);
        }, 200);
      }
      function cefFinishProgress() { clearInterval(cefProgressTimer); cefCurrentProgress = 100; cefUpdatePUI(100); }
      function cefUpdatePUI(p) {
        var r = Math.round(p);
        var a = document.getElementById('cef-progress-pct');
        var b = document.getElementById('cef-progress-fill');
        if (a) a.textContent = r + '%';
        if (b) b.style.width = r + '%';
      }

      /* Line items */
      var CEF_CONTAINER_TYPES = ['Green Steel', 'Magnum', 'Collapsible', 'Pallet', 'Non-Linear Crate', 'Durapipe', 'Battery POD'];
      window.cefAddLineItem = function(desc, mt, price, isDoc, containerType, wasteStream) {
        var c = document.getElementById('cef-line-items-container');
        var idx = cefLineItemCounter++;
        var row = document.createElement('div');
        row.className = 'line-item-row'; row.dataset.liIdx = idx;
        if (isDoc) row.dataset.docTypeLine = 'true';
        var ctOpts = CEF_CONTAINER_TYPES.map(function(ct) {
          return '<option value="'+escHtml(ct)+'"'+((containerType||'Magnum')===ct?' selected':'')+'>'+escHtml(ct)+'</option>';
        }).join('');
        /* WEEE # dropdown */
        var weeeNum = parseWeeeNum(wasteStream);
        var weeeOpts = '<option value="">\u2014</option>';
        for (var w = 1; w <= 15; w++) {
          weeeOpts += '<option value="'+w+'"'+(weeeNum===String(w)?' selected':'')+'>'+w+'</option>';
        }
        var tooltipText = weeeNum ? WEEE_CATEGORIES[parseInt(weeeNum,10)] || '' : '';
        var opts = CEF_MT.map(function(m) {
          return '<option value="'+escHtml(m)+'"'+((mt||'')===m?' selected':'')+'>'+escHtml(m||'\u2014')+'</option>';
        }).join('');
        var pv = (price!=null&&price!=='')?parseFloat(price):0;
        var descVal = desc || '';
        row.innerHTML =
          '<div><select class="li-container">'+ctOpts+'</select></div>' +
          '<div><div class="weee-wrap"><select class="li-weee-num" onchange="updateWeeeTooltip(this)">'+weeeOpts+'</select><span class="weee-tooltip">'+escHtml(tooltipText)+'</span></div></div>' +
          '<div><input type="text" class="li-waste-desc" value="'+escHtml(descVal)+'" placeholder="Product description" /></div>' +
          '<div><select class="li-movement">'+opts+'</select></div>' +
          '<div><div class="li-price-wrap"><span class="li-price-prefix">\u00a3</span><input type="number" class="li-price" value="'+pv.toFixed(2)+'" min="0" step="0.01" onchange="cefRecalcTotal()" /></div></div>' +
          '<div style="padding-bottom:1px;"><button class="btn-remove" type="button" onclick="cefRemoveLineItem(this)">&times;</button></div>';
        c.appendChild(row); cefRecalcTotal();
      };
      window.cefRemoveLineItem = function(btn) {
        var row = btn.closest('.line-item-row');
        if (row.dataset.docTypeLine === 'true') cefDocTypeLineAdded = '';
        row.remove(); cefRecalcTotal();
      };
      window.cefRecalcTotal = function() {
        var t = 0;
        document.querySelectorAll('#cef-line-items-container .line-item-row').forEach(function(r) {
          t += parseFloat(r.querySelector('.li-price').value) || 0;
        });
        document.getElementById('cef_overall_total_display').textContent = '\u00a3' + t.toFixed(2);
      };
      function cefGetLI() {
        var items = [];
        document.querySelectorAll('#cef-line-items-container .line-item-row').forEach(function(r) {
          var weeeNum = (r.querySelector('.li-weee-num') || {}).value || '';
          var weeeCategory = (weeeNum && WEEE_CATEGORIES[parseInt(weeeNum,10)]) || '';
          var descText = (r.querySelector('.li-waste-desc') || {}).value || '';
          var wsVal = weeeNum ? (weeeNum + '. ' + weeeCategory) : '';
          items.push({
            container: (r.querySelector('.li-container') || {}).value || 'Magnum',
            waste_stream: wsVal,
            weee_number: weeeNum,
            weee_category: weeeCategory,
            description: descText,
            movement_type: (r.querySelector('.li-movement') || {}).value || '',
            price: parseFloat((r.querySelector('.li-price') || {}).value) || 0
          });
        });
        return items;
      }
      function cefClearLI() {
        document.getElementById('cef-line-items-container').innerHTML = '';
        cefLineItemCounter = 0; cefDocTypeLineAdded = ''; cefRecalcTotal();
      }

      /* Doc type â€” no longer auto-adds Â£40 line; injected in PDF/HubSpot/email/webhook */
      window.cefOnDocTypeChange = function() {
        /* No auto-add */
      };

      /* Fill form */
      function cefFillForm(data, conf) {
        cefLastExtractedData = JSON.parse(JSON.stringify(data));
        cefLastConfidence = conf || {};
        cefSF('cef_branch_name', data.cef_branch_name);
        cefSF('cef_po_reference', data.po_reference);
        cefSF('cef_branch_address', data.cef_branch_address);
        cefSF('cef_branch_postcode', data.cef_branch_postcode);
        cefSF('cef_branch_phone', data.cef_branch_phone);
        cefSF('cef_branch_email', data.cef_branch_email);
        cefSF('cef_po_date', data.po_date);
        cefSF('cef_entered_by', data.entered_by);
        cefSF('cef_site_contact', data.site_contact);
        cefSF('cef_delivery_address', data.delivery_address || data.cef_branch_address || '');
        cefSF('cef_delivery_postcode', data.delivery_postcode || data.cef_branch_postcode || '');
        var pr = data.po_reference || '';
        var bn = data.cef_branch_name || 'CEF';
        document.getElementById('cef-doc-title').textContent = 'CEF Purchase Order' + (pr ? ' \u2014 ' + pr : '');
        document.getElementById('cef-doc-supplier-label').textContent = 'From: ' + bn;
        cefClearLI();
        (data.line_items || []).forEach(function(li) {
          cefAddLineItem(li.description, li.movement_type || '', li.price != null ? li.price : (li.line_total || li.unit_price || 0), false, li.container || 'Magnum', li.waste_stream || '');
        });
        /* Confidence dots */
        var fmap = {cef_po_reference:'po_reference',cef_branch_name:'cef_branch_name',cef_branch_address:'cef_branch_address',cef_branch_postcode:'cef_branch_postcode',cef_branch_phone:'cef_branch_phone',cef_branch_email:'cef_branch_email',cef_po_date:'po_date',cef_entered_by:'entered_by',cef_site_contact:'site_contact',cef_delivery_address:'delivery_address',cef_delivery_postcode:'delivery_postcode'};
        Object.keys(fmap).forEach(function(fid) {
          var lv = (conf||{})[fmap[fid]] || 'medium';
          var inp = document.getElementById(fid);
          if (!inp) return;
          var w = inp.closest('.field');
          if (w) { var lb = w.querySelector('label'); if (lb) { lb.querySelectorAll('.conf-dot').forEach(function(d){d.remove();}); var dot = document.createElement('span'); dot.className='conf-dot '+lv; dot.title=lv+' confidence'; lb.appendChild(dot); } }
          inp.classList.toggle('conf-low-border', lv === 'low');
        });
      }

      /* Collect payload */
      function cefPayload() {
        var li = cefGetLI();
        var personName = cefGF('cef-person-select') || 'Katie Wooton';
        var personDetails = CEF_PERSONS[personName] || CEF_PERSONS['Katie Wooton'];
        return {
          cef_branch_name: cefGF('cef_branch_name'), po_reference: cefGF('cef_po_reference'),
          cef_branch_address: cefGF('cef_branch_address'), cef_branch_postcode: cefGF('cef_branch_postcode'),
          cef_branch_phone: cefGF('cef_branch_phone'), cef_branch_email: cefGF('cef_branch_email'),
          po_date: cefGF('cef_po_date'), entered_by: cefGF('cef_entered_by'),
          site_contact: cefGF('cef_site_contact'),
          delivery_address: cefGF('cef_delivery_address'), delivery_postcode: cefGF('cef_delivery_postcode'),
          document_type: cefGF('cef_document_type'), special_instructions: cefGF('cef_special_instructions'),
          person: personName,
          person_name: personDetails.name,
          person_title: personDetails.title,
          person_email: personDetails.email,
          person_phone: personDetails.phone,
          line_items: li, overall_total: li.reduce(function(s,i){return s+(i.price||0);},0)
        };
      }

      /* Upload & extract */
      async function cefUploadAndExtract(file) {
        cefUploadedFileName = file.name.replace(/\.pdf$/i, '');
        cefSetState('scanning', file.name);
        var fd = new FormData(); fd.append('pdf', file);
        try {
          var resp = await fetch('/extract-cef', { method: 'POST', body: fd });
          var json = await resp.json();
          if (!resp.ok || json.error) throw new Error(json.error || 'Extraction failed');
          cefFinishProgress();
          await new Promise(function(r){setTimeout(r,500);});
          cefSetState('results');
          cefFillForm(json.data || {}, json.confidence || {});
          requestAnimationFrame(function(){ if(cefEC) cefEC.classList.add('fade-in'); });
        } catch(err) { alert(err.message); cefSetState('upload'); }
      }

      /* Reset */
      window.cefResetToUpload = function() {
        ['cef_branch_name','cef_po_reference','cef_branch_address','cef_branch_postcode','cef_branch_phone','cef_branch_email','cef_po_date','cef_entered_by','cef_site_contact','cef_delivery_address','cef_delivery_postcode','cef_special_instructions'].forEach(function(id){cefSF(id,'');});
        cefSF('cef_document_type',''); cefClearLI();
        document.getElementById('cef-doc-title').textContent = 'CEF Purchase Order';
        document.getElementById('cef-doc-supplier-label').textContent = '';
        document.getElementById('cef-hs-banner-area').innerHTML = '';
        document.querySelectorAll('#cef-edit .conf-dot').forEach(function(d){d.remove();});
        document.querySelectorAll('#cef-edit .conf-low-border').forEach(function(el){el.classList.remove('conf-low-border');});
        cefLastExtractedData = null; cefLastConfidence = null;
        cefSetState('upload');
      };

      /* Download PDF */
      window.cefDownloadReviewPDF = async function() {
        var btn = document.getElementById('cef-btn-download');
        var ot = btn.textContent; btn.disabled = true; btn.textContent = 'Generating PDF\u2026';
        try {
          var resp = await fetch('/download-cef-review-pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(cefPayload()) });
          if (!resp.ok) { var e = await resp.json().catch(function(){return{error:'PDF error'};}); throw new Error(e.error); }
          var blob = await resp.blob();
          var disp = resp.headers.get('Content-Disposition') || '';
          var m = disp.match(/filename[^;=\n]*=\s*(?:UTF-8''|"?)([^";\n]+)/i);
          var fn = m ? decodeURIComponent(m[1].replace(/"/g,'')) : 'cef_review.pdf';
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href=url; a.download=fn;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          setTimeout(function(){URL.revokeObjectURL(url);},2000);
          showToast('CEF PDF downloaded');
        } catch(err){alert(err.message);} finally{btn.disabled=false; btn.textContent=ot;}
      };

      /* HubSpot */
      window.cefOpenHubSpotPreview = async function() {
        var p = cefPayload();
        /* Build deal name to match downloaded PDF filename: {Branch} - {PO Ref} - {Postcode} */
        var _sanFn = function(t){ return t.replace(/[/\\:*?"<>|]/g, '-').trim() || 'Unknown'; };
        var _dnBranch = _sanFn(p.cef_branch_name || 'CEF');
        var _dnPoRef  = _sanFn(p.po_reference || 'Unknown');
        var _dnPostcode = _sanFn(p.cef_branch_postcode || 'Unknown');
        var dn = _dnBranch + ' - ' + _dnPoRef + ' - ' + _dnPostcode;
        var td = new Date().toISOString().split('T')[0];
        var ta = (p.overall_total||0).toFixed(2);
        var pr = p.po_reference || '\u2014';
        var bn = p.cef_branch_name || 'CEF';
        var items = p.line_items || [];
        var person = p.person || 'Katie Wooton';

        var owners = await ensureOwnersLoaded();
        var defId = getDefaultOwnerId(owners);
        var ooHtml = '';
        if (owners.length) { owners.forEach(function(o){ ooHtml += '<option value="'+escHtml(o.id)+'"'+(o.id===defId?' selected':'')+'>'+escHtml(o.name)+'</option>'; }); }
        else { ooHtml = '<option value="">No owners</option>'; }

        var personDetails = CEF_PERSONS[person] || CEF_PERSONS['Katie Wooton'];
        var desc = items.map(function(li,i){ var ct=li.container?li.container+' | ':''; var pts=wasteStreamParts(li); var mt=li.movement_type?' ['+li.movement_type+']':''; if(pts.weee&&pts.desc){return (i+1)+'. '+ct+pts.weee+'\n   '+pts.desc+mt+' \u2014 \u00a3'+(li.price||0).toFixed(2);} return (i+1)+'. '+ct+(pts.weee||pts.desc||'Item')+mt+' \u2014 \u00a3'+(li.price||0).toFixed(2); }).join('\n');
        desc += '\n\nPrepared By: '+personDetails.name+' | '+personDetails.title+' | '+personDetails.email+' | '+personDetails.phone;
        if (p.po_date) desc += '\nPO Date: '+p.po_date;
        var dd = [['CEF Branch',bn],['Supplier','Waste Experts'],['Site Contact',p.site_contact],['Delivery Address',p.delivery_address],['Delivery Postcode',p.delivery_postcode]];
        var ddD = dd.filter(function(f){return f[1];}).map(function(f){return f[0]+': '+f[1];}).join('\n');
        if (ddD) desc += '\n\nDelivery Details:\n'+ddD;

        var liH = '';
        if (items.length) {
          liH = '<table class="hs-li-table"><thead><tr><th>Container</th><th>Waste Stream</th><th>Movement</th><th>Price</th></tr></thead><tbody>';
          items.forEach(function(li){ var pts=wasteStreamParts(li); var wsC=''; if(pts.weee&&pts.desc){wsC='<span style="font-size:10px;color:#718096;">'+escHtml(pts.weee)+'</span><br/>'+escHtml(pts.desc);}else{wsC=escHtml(pts.weee||pts.desc||formatWasteStreamDisplay(li)||'\u2014');} liH += '<tr><td>'+escHtml(li.container||'\u2014')+'</td><td>'+wsC+'</td><td>'+escHtml(li.movement_type||'\u2014')+'</td><td>\u00a3'+(li.price||0).toFixed(2)+'</td></tr>'; });
          liH += '</tbody></table>';
        } else { liH = '<div style="color:#8aa3b8;font-size:12px;">No line items</div>'; }

        var mH = '<div class="hs-overlay" onclick="if(event.target===this)cefCloseHSModal()"><div class="hs-modal">' +
          '<div class="hs-modal-head"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.83 11.41V7.55a2.2 2.2 0 0 0 1.27-1.98 2.22 2.22 0 0 0-2.22-2.22h-.04V1.5a.75.75 0 0 0-1.5 0v1.85h-.04a2.22 2.22 0 0 0-2.22 2.22c0 .9.54 1.67 1.31 2.01v3.83a5.1 5.1 0 0 0-2.53 1.27l-6.63-5.16a2.03 2.03 0 0 0 .05-.42 2.08 2.08 0 1 0-2.08 2.08c.4 0 .77-.12 1.09-.32l6.45 5.02a5.17 5.17 0 0 0 .42 5.53l-1.79 1.79a1.7 1.7 0 0 0-.5-.08 1.72 1.72 0 1 0 1.72 1.72c0-.17-.03-.34-.08-.5l1.76-1.76a5.18 5.18 0 1 0 5.96-8.52zM16.84 18a2.68 2.68 0 1 1 0-5.37 2.68 2.68 0 0 1 0 5.37z"/></svg> CEF \u2014 HubSpot Deal Preview</div>' +
          '<div class="hs-modal-body">' +
            '<div style="margin-bottom:16px;"><label style="margin:0;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:#8ec431;">Deal Owner</label>' +
            '<select id="cef-hs-owner" style="width:100%;border:1px solid #3d5a73;border-radius:4px;padding:10px 12px;font-size:14px;font-family:Montserrat,sans-serif;background:#1e2e3d;color:#e8ecf1;margin-top:4px;" onchange="saveLastSelectedOwnerId(this.value)">' + ooHtml + '</select></div>' +
            '<div class="hs-section">Deal Properties</div>' +
            '<div class="hs-row"><span class="hs-label">Deal Name</span><span class="hs-value">'+escHtml(dn)+'</span></div>' +
            '<div class="hs-row"><span class="hs-label">CEF Branch</span><span class="hs-value">'+escHtml(bn)+'</span></div>' +
            '<div class="hs-row"><span class="hs-label">PO Reference</span><span class="hs-value">'+escHtml(pr)+'</span></div>' +
            (p.po_date ? '<div class="hs-row"><span class="hs-label">PO Date</span><span class="hs-value">'+escHtml(p.po_date)+'</span></div>' : '') +
            '<div class="hs-row"><span class="hs-label">Amount</span><span class="hs-value">\u00a3'+ta+'</span></div>' +
            '<div class="hs-row"><span class="hs-label">Close Date</span><span class="hs-value">'+td+'</span></div>' +
            '<div class="hs-section">Prepared By</div>' +
            '<div class="hs-row"><span class="hs-label">Name</span><span class="hs-value">'+escHtml(personDetails.name)+'</span></div>' +
            '<div class="hs-row"><span class="hs-label">Title</span><span class="hs-value">'+escHtml(personDetails.title)+'</span></div>' +
            '<div class="hs-row"><span class="hs-label">Email</span><span class="hs-value">'+escHtml(personDetails.email)+'</span></div>' +
            '<div class="hs-row"><span class="hs-label">Phone</span><span class="hs-value">'+escHtml(personDetails.phone)+'</span></div>' +
            '<div class="hs-section">Line Items</div>' + liH +
            '<div class="hs-actions"><button class="btn-outline" type="button" onclick="cefCloseHSModal()">Cancel</button>' +
            '<button class="btn-hubspot" type="button" id="cef-btn-hs-go" onclick="cefCreateDeal()">Confirm &amp; Create Deal</button></div>' +
          '</div></div></div>';

        document.getElementById('hs-modal-root').innerHTML = mH;
        window._cefDeal = { deal_name:dn, amount:p.overall_total||0, po_number:p.po_reference||'', supplier_name:bn, document_type:p.document_type||'', line_items:items, description:desc,
          delivery_details:{ customer_name:bn, supplier:'Waste Experts', purchase_order_number:p.po_reference||'', site_contact:p.site_contact||'', site_contact_number:p.cef_branch_phone||'', site_contact_email:p.cef_branch_email||'', secondary_site_contact:'', secondary_site_contact_number:'', secondary_site_contact_email:'', site_name:bn, site_address:p.delivery_address||p.cef_branch_address||'', site_postcode:p.delivery_postcode||p.cef_branch_postcode||'', opening_times:'', access:'', site_restrictions:'', special_instructions:p.special_instructions||'' }
        };
      };
      window.cefCloseHSModal = function() { document.getElementById('hs-modal-root').innerHTML = ''; };
      window.cefCreateDeal = async function() {
        var btn = document.getElementById('cef-btn-hs-go'); btn.disabled=true; btn.textContent='Creating\u2026';
        var os = document.getElementById('cef-hs-owner');
        if (os&&os.value) { window._cefDeal.owner_id=os.value; saveLastSelectedOwnerId(os.value); }
        try {
          var resp = await fetch('/api/hubspot/create-deal', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(window._cefDeal) });
          var data = await resp.json();
          if (!resp.ok||data.error) throw new Error(data.error||'Failed');
          cefCloseHSModal();
          document.getElementById('cef-hs-banner-area').innerHTML = '<div class="hs-banner success"><span>CEF deal created &#10003;</span> <a href="'+escHtml(data.deal_url)+'" target="_blank">View in HubSpot</a><span class="hs-banner-close" onclick="this.parentNode.remove()">&#10005;</span></div>';
        } catch(err) {
          cefCloseHSModal();
          document.getElementById('cef-hs-banner-area').innerHTML = '<div class="hs-banner error"><span>'+escHtml(err.message)+'</span><button class="btn-hubspot" style="padding:6px 12px;font-size:12px;" onclick="cefOpenHubSpotPreview()">Retry</button><span class="hs-banner-close" onclick="this.parentNode.remove()">&#10005;</span></div>';
        }
      };

      /* WasteLogics */
      window.cefSendToWasteLogics = async function() {
        var p = cefPayload(); var btn = document.getElementById('cef-btn-wastelogics'); var oH = btn.innerHTML;
        btn.disabled=true; btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" style="animation:spin 1s linear infinite;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg> Sending\u2026';
        var wp = { account_name:p.cef_branch_name||'C.E.F.', supplier_address:p.cef_branch_address||'', purchase_order_number:p.po_reference||'', customer_name:p.cef_branch_name||'', site_contact:p.site_contact||'', site_contact_number:p.cef_branch_phone||'', site_contact_email:p.cef_branch_email||'', site_name:p.cef_branch_name||'', site_address:p.delivery_address||p.cef_branch_address||'', site_postcode:p.delivery_postcode||p.cef_branch_postcode||'', line_items:p.line_items, overall_total:p.overall_total, po_date:p.po_date||'', person_name:p.person_name||'', person_title:p.person_title||'', person_email:p.person_email||'', person_phone:p.person_phone||'' };
        try {
          var resp = await fetch('/api/send-to-webhook', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({data:wp, pdf_filename:(cefUploadedFileName||'cef_po')+'.pdf'}) });
          var r = await resp.json();
          if (r.success) showToastTR('CEF sent to WasteLogics \u2713','success');
          else throw new Error(r.error||'Error');
        } catch(err) { showToastTR("Couldn\u2019t send \u2014 "+err.message,'warning','cefSendToWasteLogics()'); }
        finally { btn.disabled=false; btn.innerHTML=oH; }
      };

      /* Delivery email */
      window.cefOpenDeliveryConfirm = function() {
        var p = cefPayload(); var pr = p.po_reference||'\u2014'; var em = getDeliveryEmail(); var person = p.person||'Katie Wooton';
        var pf = [['CEF Branch',p.cef_branch_name],['PO Date',p.po_date],['Prepared By',p.person_name+' \u2014 '+p.person_title],['Email',p.person_email],['Phone',p.person_phone],['PO Reference',pr],['Site Contact',p.site_contact],['Delivery Postcode',p.delivery_postcode||p.cef_branch_postcode]];
        var ph = pf.map(function(f){ return '<div class="cd-row"><span class="cd-lbl">'+escHtml(f[0])+'</span><span class="cd-val">'+escHtml(f[1]||'\u2014')+'</span></div>'; }).join('');
        document.getElementById('cd-modal-root').innerHTML =
          '<div class="cd-overlay" onclick="if(event.target===this)cefCloseDM()"><div class="cd-modal">' +
          '<div class="cd-modal-head"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,7 12,13 2,7"/></svg> Send CEF Delivery Email</div>' +
          '<div class="cd-modal-body">' +
            '<div style="font-size:13px;color:#8aa3b8;margin-bottom:4px;">Send delivery details to:</div>' +
            '<div class="cd-email-display">'+escHtml(em)+'</div>' +
            '<div style="font-size:11px;color:#8aa3b8;margin-bottom:6px;">Subject: CEF Purchase Order \u2014 '+escHtml(pr)+' \u2014 Waste Experts</div>' +
            '<div class="cd-summary">'+ph+'</div>' +
            '<div style="font-size:11px;color:#5a7a94;margin-bottom:12px;">All details + PDF attached.</div>' +
            '<div class="cd-actions"><button class="btn-outline" type="button" onclick="cefCloseDM()" style="color:#8aa3b8;border-color:#4b5563;">Cancel</button>' +
            '<button class="btn" type="button" id="cef-btn-cd-send" onclick="cefSendEmail()" style="display:inline-flex;align-items:center;gap:6px;">' +
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="22,7 12,13 2,7"/></svg> Send</button></div>' +
          '</div></div></div>';
      };
      window.cefCloseDM = function() { document.getElementById('cd-modal-root').innerHTML = ''; };
      window.cefSendEmail = async function() {
        var btn = document.getElementById('cef-btn-cd-send'); if(!btn)return;
        btn.disabled=true; btn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" style="animation:spin 1s linear infinite;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg> Sending\u2026';
        var p = cefPayload(); var em = getDeliveryEmail();
        try {
          var resp = await fetch('/api/send-cef-delivery-email', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({to_email:em, payload:p, person:p.person||'Katie Wooton'}) });
          var data = await resp.json();
          if (!resp.ok||data.error) throw new Error(data.error||'Failed');
          cefCloseDM(); showToastTR('CEF PDF sent to '+em+' \u2713','success');
        } catch(err) { cefCloseDM(); showToastTR(err.message,'error','cefOpenDeliveryConfirm()'); }
      };

      /* Drag & drop */
      cefDZ.addEventListener('dragover', function(e){ e.preventDefault(); cefDZ.classList.add('drag-over'); });
      cefDZ.addEventListener('dragleave', function(){ cefDZ.classList.remove('drag-over'); });
      cefDZ.addEventListener('drop', function(e){ e.preventDefault(); cefDZ.classList.remove('drag-over'); var f=e.dataTransfer.files[0]; if(f&&f.name.toLowerCase().endsWith('.pdf')) cefUploadAndExtract(f); });
      cefFI.addEventListener('change', function(e){ var f=e.target.files[0]; if(f) cefUploadAndExtract(f); });

      /* Init CEF */
      cefSetState('upload');
    })();

  </script>
</body>
</html>
