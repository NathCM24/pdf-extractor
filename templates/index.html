<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Waste Experts PDF Extractor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Montserrat', sans-serif; margin: 0; background: #1e2e3d; color: #e8ecf1; }
    .wrap { max-width: 980px; margin: 24px auto 48px; padding: 0 16px; position: relative; }
    .brand { text-align: center; margin: 6px 0 18px; }
    .brand img { max-width: 224px; width: 100%; height: auto; }

    /* --- Cards --- */
    .card { background: #253a4d; border-radius: 4px; box-shadow: 0 2px 12px rgba(0,0,0,.25); margin-bottom: 16px; border: 1px solid #2f4a60; }
    .head { background: #8ec431; color: #fff; padding: 16px 20px; border-radius: 4px 4px 0 0; font-weight: 700; font-size: 15px; }
    .body { padding: 16px 20px; }

    /* --- Drop zone --- */
    .drop { border: 2px dashed #3d5a73; border-radius: 4px; padding: 28px; text-align: center; transition: border-color .2s, background .2s; }
    .drop.drag-over { border-color: #8ec431; background: rgba(142,196,49,.1); }
    .drop p { margin: 0 0 10px; color: #c0cdd8; }

    /* --- Grid / fields --- */
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .field { display: flex; flex-direction: column; gap: 4px; position: relative; }
    .full { grid-column: 1 / -1; }
    label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; color: #8ec431; }
    input, textarea, select {
      border: 1px solid #3d5a73; border-radius: 4px; padding: 10px 12px;
      font-size: 14px; font-family: 'Montserrat', sans-serif;
      background: #1e2e3d; color: #e8ecf1; transition: border-color .2s, box-shadow .2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: #8ec431; box-shadow: 0 0 0 2px rgba(142,196,49,.2);
    }
    input::placeholder, textarea::placeholder { color: #5a7a94; }
    textarea { min-height: 64px; resize: vertical; }
    select option { background: #1e2e3d; color: #e8ecf1; }
    .hidden { display: none; }
    .error { color: #f87171; font-weight: 700; margin-top: 4px; font-size: 12px; }
    .ok { color: #8ec431; font-weight: 700; margin-top: 4px; font-size: 13px; }

    /* --- Buttons --- */
    .btn {
      border: none; background: #8ec431; color: #fff; border-radius: 4px;
      padding: 10px 18px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 13px;
      transition: background .2s;
    }
    .btn:hover { background: #7ab328; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-outline {
      border: 1px solid #8ec431; background: transparent; color: #8ec431;
      border-radius: 4px; padding: 10px 18px; font-weight: 700;
      cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 13px;
      transition: background .2s, color .2s;
    }
    .btn-outline:hover { background: rgba(142,196,49,.15); color: #a5d84e; }
    .pill { display: inline-block; background: rgba(142,196,49,.15); color: #8ec431; border: 1px solid #8ec431; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 700; }
    .hl { border: 2px solid #8ec431; box-shadow: 0 0 0 2px rgba(142,196,49,.15) inset; }

    /* --- Typeahead dropdown --- */
    .typeahead-wrap { position: relative; }
    .typeahead-list {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      max-height: 220px; overflow-y: auto;
      background: #253a4d; border: 1px solid #3d5a73; border-radius: 4px;
      box-shadow: 0 6px 20px rgba(0,0,0,.35);
      display: none;
    }
    .typeahead-list.open { display: block; }
    .typeahead-item {
      padding: 9px 12px; cursor: pointer; font-size: 13px; color: #c0cdd8;
      border-bottom: 1px solid #2f4a60; transition: background .1s;
    }
    .typeahead-item:last-child { border-bottom: none; }
    .typeahead-item:hover, .typeahead-item.active { background: rgba(142,196,49,.15); color: #fff; }
    .typeahead-item mark { background: rgba(142,196,49,.35); color: #fff; border-radius: 4px; padding: 0 1px; }

    /* --- Lottie loading --- */
    .lottie-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px 20px;
      margin-bottom: 16px;
    }
    #lottie-player { width: 320px; height: 320px; }
    .loading-text { margin: 4px 0 0; font-size: 14px; color: #8a9bb0; text-align: center; line-height: 1.5; }
    .loading-text em { font-style: italic; }

    /* --- Progress bar --- */
    .progress-wrap { width: 320px; margin-top: 16px; text-align: center; }
    .progress-pct { font-size: 13px; font-weight: 700; color: #8a9bb0; margin-bottom: 6px; }
    .progress-track {
      width: 100%; height: 8px; background: #2f4a60; border-radius: 4px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; width: 0%; background: #8ec431; border-radius: 4px;
      transition: width .3s ease;
    }

    /* --- Brand subtitle --- */
    .brand-subtitle { font-size: 11px; color: #5a7a94; margin-top: 6px; }
    .brand-title { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 28px; color: #e8ecf1; text-align: center; margin: 14px 0 4px; letter-spacing: -.3px; }

    /* --- Fade-in animation --- */
    .fade-in {
      animation: fadeInUp .45s ease-out both;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* --- Section headers inside the result card --- */
    .section-title {
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: .6px;
      color: #fff; border-bottom: 2px solid #5a7a94; padding-bottom: 4px;
      margin: 18px 0 10px; grid-column: 1 / -1;
    }
    .section-title:first-child { margin-top: 0; }

    /* --- Document header row --- */
    .doc-header {
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 8px; margin-bottom: 14px;
    }
    .doc-header h2 { margin: 0; font-size: 18px; font-weight: 700; color: #fff; }
    .doc-header .doc-meta { font-size: 12px; color: #8aa3b8; }

    /* --- HubSpot button --- */
    .btn-hubspot {
      border: none; background: #ff7a59; color: #fff; border-radius: 4px;
      padding: 10px 18px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 13px;
      transition: background .2s; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-hubspot:hover { background: #e56a4a; }
    .btn-hubspot:disabled { opacity: .6; cursor: not-allowed; }
    .btn-hubspot svg { width: 18px; height: 18px; flex-shrink: 0; }

    /* --- HubSpot modal overlay --- */
    .hs-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 900;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn .2s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .hs-modal {
      background: #253a4d; border: 1px solid #2f4a60; border-radius: 4px;
      width: 600px; max-width: 94vw; max-height: 85vh; overflow-y: auto;
      box-shadow: 0 8px 40px rgba(0,0,0,.5);
    }
    .hs-modal-head {
      background: #ff7a59; color: #fff; padding: 14px 20px; border-radius: 4px 4px 0 0;
      font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 10px;
    }
    .hs-modal-body { padding: 20px; }
    .hs-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2f4a60; font-size: 13px; }
    .hs-row:last-child { border-bottom: none; }
    .hs-label { color: #8aa3b8; font-weight: 600; min-width: 140px; }
    .hs-value { color: #e8ecf1; text-align: right; word-break: break-word; }
    .hs-section { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; color: #ff7a59; margin: 16px 0 6px; padding-bottom: 4px; border-bottom: 1px solid #3d5a73; }
    .hs-section:first-child { margin-top: 0; }
    .hs-li-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 6px; }
    .hs-li-table th { text-align: left; color: #8aa3b8; font-weight: 600; padding: 4px 6px; border-bottom: 1px solid #3d5a73; }
    .hs-li-table td { padding: 4px 6px; color: #c0cdd8; border-bottom: 1px solid #2f4a60; }
    .hs-li-table td:nth-child(n+2) { text-align: right; }
    .hs-actions { display: flex; gap: 10px; margin-top: 18px; justify-content: flex-end; }
    .hs-match { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; }
    .hs-match.found { color: #8ec431; }
    .hs-match.not-found { color: #8aa3b8; }

    /* --- HubSpot banner --- */
    .hs-banner {
      padding: 12px 16px; border-radius: 4px; font-size: 13px; font-weight: 600;
      margin-top: 12px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    .hs-banner.success { background: rgba(142,196,49,.15); color: #8ec431; border: 1px solid #8ec431; }
    .hs-banner.error { background: rgba(248,113,113,.12); color: #f87171; border: 1px solid rgba(248,113,113,.3); }
    .hs-banner a { color: inherit; text-decoration: underline; }
    .hs-banner .hs-banner-close { margin-left: auto; cursor: pointer; opacity: .7; }
    .hs-banner .hs-banner-close:hover { opacity: 1; }

    /* --- Persistent settings gear icon (always visible) --- */
    .persistent-gear {
      position: absolute; top: 10px; right: 16px; z-index: 100;
      background: none; border: none; padding: 4px; cursor: pointer;
      display: flex; align-items: center;
      color: #5a7a94; transition: opacity .2s, transform .3s;
    }
    .persistent-gear:hover { opacity: .7; transform: rotate(45deg); }
    .persistent-gear svg { width: 22px; height: 22px; }

    /* --- Document Type row (styled as line item) --- */
    .doc-type-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid #2f4a60;
    }
    .doc-type-row .dt-label {
      font-size: 13px; font-weight: 700; color: #8ec431;
    }
    .doc-type-row select {
      max-width: 220px; border: 1px solid #3d5a73; border-radius: 4px;
      padding: 8px 10px; font-size: 13px; font-family: 'Montserrat', sans-serif;
      background: #1e2e3d; color: #e8ecf1;
    }

    /* --- Settings card --- */
    .settings-card { background: #253a4d; border-radius: 4px; border: 1px solid #2f4a60; margin-bottom: 16px; }
    .settings-body { padding: 16px 20px; }
    .owners-list { max-height: 200px; overflow-y: auto; font-size: 12px; margin-top: 10px; }
    .owners-list .owner-row { padding: 6px 0; border-bottom: 1px solid #2f4a60; color: #c0cdd8; display: flex; justify-content: space-between; }
    .owners-list .owner-row:last-child { border-bottom: none; }
    .owner-id { color: #5a7a94; font-family: monospace; font-size: 11px; }

    /* --- Copy toast --- */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: #8ec431; color: #fff; padding: 10px 20px; border-radius: 4px;
      font-size: 13px; font-weight: 600; opacity: 0; transition: opacity .3s;
      pointer-events: none; z-index: 999;
    }
    .toast.show { opacity: 1; }

    /* --- Line items --- */
    .line-item-row {
      display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px;
      align-items: end; padding: 6px 0; border-bottom: 1px solid #2f4a60;
    }
    .line-item-row:last-child { border-bottom: none; }
    .line-item-row input { font-size: 13px; padding: 8px 10px; }
    .line-item-row .li-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #8aa3b8; margin-bottom: 2px; }
    .btn-remove {
      border: none; background: rgba(180,35,24,.2); color: #f87171; border-radius: 4px;
      padding: 8px 10px; cursor: pointer; font-weight: 700; font-size: 13px;
      font-family: 'Montserrat', sans-serif; transition: background .2s;
    }
    .btn-remove:hover { background: rgba(180,35,24,.35); }
    @media (max-width: 760px) {
      .grid { grid-template-columns: 1fr; }
      .line-item-row { grid-template-columns: 1fr 1fr; }
    }

    /* --- Supplier Template Management --- */
    .template-progress { margin-bottom: 14px; }
    .template-progress-text { font-size: 13px; font-weight: 600; color: #c0cdd8; margin-bottom: 6px; }
    .template-list { max-height: 400px; overflow-y: auto; }
    .template-row {
      display: flex; align-items: center; gap: 10px; padding: 8px 0;
      border-bottom: 1px solid #2f4a60; font-size: 13px;
    }
    .template-row:last-child { border-bottom: none; }
    .template-row .tmpl-name { flex: 1; color: #c0cdd8; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .template-row .tmpl-date { font-size: 11px; color: #5a7a94; white-space: nowrap; }
    .badge-trained { display: inline-block; background: rgba(142,196,49,.18); color: #8ec431; border: 1px solid rgba(142,196,49,.35); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
    .badge-untrained { display: inline-block; background: rgba(90,122,148,.15); color: #8aa3b8; border: 1px solid rgba(90,122,148,.3); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
    .btn-train {
      border: 1px solid #8ec431; background: transparent; color: #8ec431;
      border-radius: 4px; padding: 4px 10px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 11px; transition: background .2s;
      white-space: nowrap;
    }
    .btn-train:hover { background: rgba(142,196,49,.15); }
    .btn-del-tmpl {
      border: 1px solid rgba(248,113,113,.3); background: transparent; color: #f87171;
      border-radius: 4px; padding: 4px 8px; font-weight: 700; cursor: pointer;
      font-family: 'Montserrat', sans-serif; font-size: 11px; transition: background .2s;
      white-space: nowrap;
    }
    .btn-del-tmpl:hover { background: rgba(248,113,113,.12); }
    .template-search { margin-bottom: 10px; }
    .template-search input { width: 100%; font-size: 13px; padding: 8px 12px; }

    /* --- Training modal --- */
    .train-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 900;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn .2s ease-out;
    }
    .train-modal {
      background: #253a4d; border: 1px solid #2f4a60; border-radius: 4px;
      width: 700px; max-width: 96vw; max-height: 90vh; overflow-y: auto;
      box-shadow: 0 8px 40px rgba(0,0,0,.5);
    }
    .train-modal-head {
      background: #8ec431; color: #fff; padding: 14px 20px; border-radius: 4px 4px 0 0;
      font-weight: 700; font-size: 15px; display: flex; align-items: center; justify-content: space-between;
    }
    .train-modal-head .close-x { cursor: pointer; font-size: 20px; opacity: .8; }
    .train-modal-head .close-x:hover { opacity: 1; }
    .train-modal-body { padding: 20px; }
    .train-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .train-grid .full { grid-column: 1 / -1; }
    .train-grid label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; color: #8ec431; }
    .train-grid input, .train-grid textarea, .train-grid select {
      width: 100%; border: 1px solid #3d5a73; border-radius: 4px; padding: 8px 10px;
      font-size: 13px; font-family: 'Montserrat', sans-serif;
      background: #1e2e3d; color: #e8ecf1;
    }
    .train-grid textarea { min-height: 52px; resize: vertical; }
    .train-grid select option { background: #1e2e3d; color: #e8ecf1; }
    .train-section-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px;
      color: #fff; border-bottom: 2px solid #5a7a94; padding-bottom: 4px;
      margin: 14px 0 8px; grid-column: 1 / -1;
    }
    .train-actions { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; }
    .train-li-row {
      display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 6px;
      align-items: end; padding: 4px 0; border-bottom: 1px solid #2f4a60;
    }
    .train-li-row input { font-size: 12px; padding: 6px 8px; }
    .train-upload-area { text-align: center; padding: 24px; border: 2px dashed #3d5a73; border-radius: 4px; }
    .train-upload-area.drag-over { border-color: #8ec431; background: rgba(142,196,49,.1); }

    /* --- Confidence dots --- */
    .conf-dot {
      display: inline-block; width: 8px; height: 8px; border-radius: 50%;
      margin-left: 6px; vertical-align: middle;
    }
    .conf-dot.high { background: #8ec431; }
    .conf-dot.medium { background: #f59e0b; }
    .conf-dot.low { background: #f87171; }
    .conf-low-border { border-color: rgba(245,158,11,.5) !important; box-shadow: 0 0 0 1px rgba(245,158,11,.15) inset !important; }

    /* --- Template prompt banner --- */
    .template-prompt-banner {
      padding: 10px 14px; border-radius: 4px; font-size: 12px; font-weight: 600;
      margin-bottom: 14px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      background: rgba(142,196,49,.1); color: #8ec431; border: 1px solid rgba(142,196,49,.25);
    }
    .template-prompt-banner .dismiss { margin-left: auto; cursor: pointer; opacity: .7; font-size: 14px; }
    .template-prompt-banner .dismiss:hover { opacity: 1; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Persistent settings gear â€” always visible in all states -->
    <button class="persistent-gear" type="button" onclick="toggleSettings()" title="Settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>

    <div class="brand">
      <img src="https://i0.wp.com/wasteexperts.co.uk/wp-content/uploads/2022/11/green-grey-logo-1080.png?w=1920&amp;ssl=1" alt="Waste Experts logo" />
      <h1 class="brand-title">Improving Efficiency, Reducing Input</h1>
      <p class="brand-subtitle">Made with ðŸ’š by Marketing</p>
    </div>

    <div id="state-container">
    <!-- Upload card -->
    <div id="upload-card" class="card">
      <div class="head">Upload Purchase Order PDF</div>
      <div class="body">
        <div id="drop-zone" class="drop">
          <p><strong>Drop a PDF here</strong> or choose a file</p>
          <button class="btn" type="button" onclick="document.getElementById('file-input').click()">Choose PDF</button>
          <input id="file-input" type="file" accept=".pdf" class="hidden" />
          <p id="file-label" style="margin-top:8px; font-size:13px; color:#5a6e80;"></p>
        </div>
      </div>
    </div>

    <!-- Extracted data card (detached from DOM by JS on init) -->
    <div id="edit" class="card">
      <div class="head">Extracted Order Data</div>
      <div class="body">

        <!-- Document header -->
        <div class="doc-header">
          <h2 id="doc-title">Purchase Order</h2>
          <span class="doc-meta" id="doc-supplier-label"></span>
        </div>

        <!-- Template prompt banner (shown for untrained suppliers) -->
        <div id="template-prompt-area"></div>

        <div class="grid">

          <!-- ===== Supplier / Account ===== -->
          <div class="section-title">Supplier &amp; Reference</div>

          <div class="field full typeahead-wrap">
            <label for="account_name">Account Name</label>
            <input id="account_name" type="text" autocomplete="off" placeholder="Enter your supplier here..." />
            <div id="typeahead-dropdown" class="typeahead-list"></div>
            <div id="account-error" class="error hidden">Please choose a valid supplier from the list</div>
          </div>

          <div class="field">
            <label>Supplier (From)</label>
            <input id="supplier" type="text" />
          </div>
          <div class="field">
            <label>Purchase Order Number</label>
            <input id="purchase_order_number" type="text" />
          </div>

          <div class="field full">
            <label>Service / Product Description</label>
            <input id="service_description" type="text" placeholder="e.g. Corrugated Flo Tube Pipe - Exchange" />
          </div>

          <div class="field full">
            <label>Bill To (Representative Address)</label>
            <textarea id="supplier_address" placeholder="Supplier address will appear here"></textarea>
          </div>

          <!-- ===== Products & Services ===== -->
          <div class="section-title">Products &amp; Services</div>

          <div class="full" id="line-items-container">
            <!-- Line item rows are injected here by JS -->
          </div>

          <!-- Document Type as permanent line item row -->
          <div class="full doc-type-row">
            <span class="dt-label">Document Type</span>
            <select id="document_type">
              <option>Consignment Note</option>
              <option>Waste Transfer Note</option>
            </select>
          </div>

          <div class="full" style="display:flex; gap:10px; align-items:center; margin-bottom:4px;">
            <button class="btn-outline" type="button" onclick="addLineItem()">+ Add Line Item</button>
            <span style="margin-left:auto; font-weight:700; font-size:14px; color:#8ec431;">
              Overall Total: <span id="overall_total_display">Â£0.00</span>
            </span>
          </div>

          <!-- ===== Contact Info ===== -->
          <div class="section-title">Contact Information</div>

          <div class="field"><label>Site Contact</label><input id="site_contact" type="text" /></div>
          <div class="field"><label>Site Contact Number</label><input id="site_contact_number" type="text" /></div>
          <div class="field full"><label>Site Contact Email</label><input id="site_contact_email" type="email" /></div>

          <div class="field"><label>Secondary Site Contact</label><input id="secondary_site_contact" type="text" /></div>
          <div class="field"><label>Secondary Site Contact Number</label><input id="secondary_site_contact_number" type="text" /></div>
          <div class="field full"><label>Secondary Site Contact Email</label><input id="secondary_site_contact_email" type="email" /></div>

          <!-- ===== Site Info ===== -->
          <div class="section-title">Site Information</div>

          <div class="field"><label>Site Name</label><input id="site_name" type="text" /></div>
          <div class="field"><label>Site Postcode</label><input id="site_postcode" type="text" /></div>
          <div class="field full"><label>Site Address</label><textarea id="site_address"></textarea></div>

          <!-- ===== Instructions ===== -->
          <div class="section-title">Access &amp; Instructions</div>

          <div class="field"><label>Opening Times</label><textarea id="opening_times"></textarea></div>
          <div class="field"><label>Access</label><textarea id="access"></textarea></div>
          <div class="field"><label>Site Restrictions</label><textarea id="site_restrictions"></textarea></div>
          <div class="field"><label>Special Instructions</label><textarea id="special_instructions"></textarea></div>
        </div>

        <!-- Action bar -->
        <div style="margin-top:18px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <div style="display:flex; gap:10px; align-items:center;">
            <button id="btn-download" class="btn" type="button" onclick="downloadReviewPDF()">Download PDF</button>
            <button id="btn-csv" class="btn-outline" type="button" onclick="downloadCSV()">Download as CSV</button>
          </div>
          <div style="display:flex; gap:10px; align-items:center;">
            <button id="btn-hubspot" class="btn-hubspot" type="button" onclick="openHubSpotPreview()">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.83 11.41V7.55a2.2 2.2 0 0 0 1.27-1.98 2.22 2.22 0 0 0-2.22-2.22h-.04V1.5a.75.75 0 0 0-1.5 0v1.85h-.04a2.22 2.22 0 0 0-2.22 2.22c0 .9.54 1.67 1.31 2.01v3.83a5.1 5.1 0 0 0-2.53 1.27l-6.63-5.16a2.03 2.03 0 0 0 .05-.42 2.08 2.08 0 1 0-2.08 2.08c.4 0 .77-.12 1.09-.32l6.45 5.02a5.17 5.17 0 0 0 .42 5.53l-1.79 1.79a1.7 1.7 0 0 0-.5-.08 1.72 1.72 0 1 0 1.72 1.72c0-.17-.03-.34-.08-.5l1.76-1.76a5.18 5.18 0 1 0 5.96-8.52zM16.84 18a2.68 2.68 0 1 1 0-5.37 2.68 2.68 0 0 1 0 5.37z"/></svg>
              Send to HubSpot
            </button>
            <button class="btn-outline" type="button" onclick="resetToUpload()">&larr; Convert Another Purchase Order</button>
          </div>
        </div>

        <!-- HubSpot feedback banner area -->
        <div id="hs-banner-area"></div>
      </div>
    </div>
    </div>

    <!-- Settings card (OUTSIDE state-container so state transitions don't detach it) -->
    <div id="settings-section" class="hidden">
      <div class="settings-card">
        <div class="head" style="background:#3d5a73; font-size:13px;">Settings</div>
        <div class="settings-body">
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
            <button class="btn-outline" type="button" onclick="fetchHubSpotOwners()" id="btn-fetch-owners">Fetch HubSpot Owners</button>
            <button class="btn-outline" type="button" onclick="testHubSpotConnection()" id="btn-hs-test">Test HubSpot Connection</button>
          </div>
          <pre id="hs-test-output" class="hidden"
               style="margin-top:10px; background:#0d1b28; border:1px solid #2a4054; border-radius:4px; padding:14px; color:#c8dce8; font-size:12px; line-height:1.5; white-space:pre-wrap; word-break:break-word; max-height:400px; overflow:auto;"></pre>
          <div id="owners-list-container" class="owners-list hidden"></div>
        </div>
      </div>

      <!-- Supplier Templates -->
      <div class="settings-card">
        <div class="head" style="background:#3d5a73; font-size:13px;">Supplier Templates</div>
        <div class="settings-body">
          <div class="template-progress">
            <div class="template-progress-text" id="template-progress-label">Loading suppliers...</div>
            <div class="progress-track" style="margin-top:6px;">
              <div class="progress-fill" id="template-progress-fill" style="width:0%; background:#8EC431;"></div>
            </div>
          </div>
          <div class="template-search">
            <input type="text" id="template-search-input" placeholder="Search suppliers..." oninput="filterTemplateList(this.value)" />
          </div>
          <div id="template-supplier-list" class="template-list">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- HubSpot preview modal (injected dynamically) -->
  <div id="hs-modal-root"></div>

  <!-- Training modal (injected dynamically) -->
  <div id="training-modal-root"></div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <script>
    /* â”€â”€ Lottie animation data & setup â”€â”€ */
    const scanAnimation = {"v":"5.5.7","meta":{"g":"LottieFiles AE 0.1.20","a":"","k":"","d":"","tc":"#ffffff"},"fr":60,"ip":0,"op":227,"w":600,"h":600,"nm":"Artboard","ddd":0,"assets":[{"id":"comp_0","layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle Copy 10","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[274,400.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[128,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 3","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"Rectangle Copy 9","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[368.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[41,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 5","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"Rectangle Copy 8","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[348.5,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[81,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 4","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":4,"nm":"Rectangle Copy 7","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[249,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[78,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 2","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":4,"nm":"Rectangle Copy 6","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[270.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[121,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":6,"ty":4,"nm":"Rectangle 3","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[255,234.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[90,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.21960799396,0.545098006725,0.929412007332,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":7,"ty":4,"nm":"Rectangle 2","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[299.89,304.75,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[245.78,319.5],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":19,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[1,1,1,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0}]},{"id":"comp_1","layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle Copy 3","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[274,400.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[128,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 3","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"Rectangle Copy 5","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[368.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[41,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 5","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"Rectangle Copy 4","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[348.5,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[81,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 4","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":4,"nm":"Rectangle Copy 2","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[249,351.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[78,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy 2","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":4,"nm":"Rectangle Copy","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[270.5,302.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[121,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle Copy","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":6,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[255,234.5,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[90,25],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":12.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.882352941176,0.913725490196,0.949019607843,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":3,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":7,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":60,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[299.89,304.75,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[245.78,319.5],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":19,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[1,1,1,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0}]}],"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"Rectangle","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.376,"y":1},"o":{"x":0.275,"y":0},"t":0,"s":[300,485.5,0],"to":[0,-60,0],"ti":[0,0,0]},{"i":{"x":0.725,"y":1},"o":{"x":0.632,"y":0},"t":110,"s":[300,125.5,0],"to":[0,0,0],"ti":[0,-60,0]},{"t":220,"s":[300,485.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,9],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":4.5,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"fl","c":{"a":0,"k":[0.094117999077,0.439215987921,0.843137025833,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"bottom-grad","sr":1,"ks":{"o":{"a":1,"k":[{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":120,"s":[0]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":152,"s":[40]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":199,"s":[40]},{"t":218,"s":[0]}],"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.374,"y":1},"o":{"x":0.274,"y":0},"t":1,"s":[300,463.5,0],"to":[0,-52.833,0],"ti":[0,-7.167,0]},{"i":{"x":0.726,"y":1},"o":{"x":0.621,"y":0},"t":111,"s":[300,146.5,0],"to":[0,7.167,0],"ti":[0,-60,0]},{"t":221,"s":[300,506.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,-100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,45],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":0,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"gf","o":{"a":0,"k":100,"ix":10},"r":1,"bm":0,"g":{"p":3,"k":{"a":0,"k":[0,0.094,0.439,0.843,0.5,0.094,0.439,0.843,1,0.094,0.439,0.843,0,0,0.252,0.2,0.505,0.4,0.752,0.7,1,1],"ix":9}},"s":{"a":0,"k":[0,-22.5],"ix":5},"e":{"a":0,"k":[0,22.5],"ix":6},"t":1,"nm":"Gradient Fill 1","mn":"ADBE Vector Graphic - G-Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"top-grad","sr":1,"ks":{"o":{"a":1,"k":[{"i":{"x":[0.833],"y":[1]},"o":{"x":[0.167],"y":[0]},"t":0,"s":[0]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":14,"s":[40]},{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":89,"s":[40]},{"i":{"x":[0.833],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":108,"s":[0]},{"t":221,"s":[0]}],"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":1,"k":[{"i":{"x":0.376,"y":1},"o":{"x":0.271,"y":0},"t":1,"s":[300,463.5,0],"to":[0,-60,0],"ti":[0,0,0]},{"i":{"x":0.725,"y":1},"o":{"x":0.632,"y":0},"t":111,"s":[300,103.5,0],"to":[0,0,0],"ti":[0,-60,0]},{"t":221,"s":[300,463.5,0]}],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ty":"rc","d":1,"s":{"a":0,"k":[300,45],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"r":{"a":0,"k":0,"ix":4},"nm":"Rectangle Path 1","mn":"ADBE Vector Shape - Rect","hd":false},{"ty":"gf","o":{"a":0,"k":100,"ix":10},"r":1,"bm":0,"g":{"p":3,"k":{"a":0,"k":[0,0.094,0.439,0.843,0.5,0.094,0.439,0.843,1,0.094,0.439,0.843,0,0,0.252,0.2,0.505,0.4,0.752,0.7,1,1],"ix":9}},"s":{"a":0,"k":[0,-22.5],"ix":5},"e":{"a":0,"k":[0,22.5],"ix":6},"t":1,"nm":"Gradient Fill 1","mn":"ADBE Vector Graphic - G-Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Rectangle","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":4,"ty":0,"nm":"full","refId":"comp_0","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[300,300,0],"ix":2},"a":{"a":0,"k":[300,300,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"hasMask":true,"masksProperties":[{"inv":false,"mode":"i","pt":{"a":1,"k":[{"i":{"x":0.364,"y":1},"o":{"x":0.272,"y":0},"t":0,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,479.957],[448.801,479.957]],"c":true}]},{"i":{"x":0.73,"y":1},"o":{"x":0.631,"y":0},"t":110,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,129.957],[448.801,129.957]],"c":true}]},{"t":220,"s":[{"i":[[0,0],[0,0],[0,0],[0,0]],"o":[[0,0],[0,0],[0,0],[0,0]],"v":[[448.801,109],[153,109],[153,479.957],[448.801,479.957]],"c":true}]}],"ix":1},"o":{"a":0,"k":100,"ix":3},"x":{"a":0,"k":0,"ix":4},"nm":"Mask 1"}],"w":600,"h":600,"ip":0,"op":3600,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":0,"nm":"trans","refId":"comp_1","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[300,300,0],"ix":2},"a":{"a":0,"k":[300,300,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"w":600,"h":600,"ip":0,"op":3600,"st":0,"bm":0}],"markers":[]};

    /* Replace all blue and green colors with grey #6B7280 (RGB 0.42, 0.447, 0.502) */
    (function recolorLottie(obj) {
      var GREY = [0.42, 0.447, 0.502];
      function isBlue(r, g, b) { return b > 0.5 && b > r * 2; }
      function isGreen(r, g, b) { return g > 0.5 && g > r * 1.2 && g > b * 1.2; }
      function shouldReplace(r, g, b) { return isBlue(r, g, b) || isGreen(r, g, b); }

      function walk(node) {
        if (Array.isArray(node)) { node.forEach(walk); return; }
        if (!node || typeof node !== 'object') return;

        /* Solid fill / stroke color */
        if ((node.ty === 'fl' || node.ty === 'st') && node.c) {
          var k = node.c.k;
          if (Array.isArray(k) && k.length >= 4 && typeof k[0] === 'number') {
            if (shouldReplace(k[0], k[1], k[2])) { k[0] = GREY[0]; k[1] = GREY[1]; k[2] = GREY[2]; }
          }
        }

        /* Gradient fill / stroke */
        if ((node.ty === 'gf' || node.ty === 'gs') && node.g) {
          var p = node.g.p;
          var gk = node.g.k;
          if (gk && gk.a === 0 && Array.isArray(gk.k)) {
            for (var i = 0; i < p; i++) {
              var base = i * 4;
              if (shouldReplace(gk.k[base + 1], gk.k[base + 2], gk.k[base + 3])) {
                gk.k[base + 1] = GREY[0]; gk.k[base + 2] = GREY[1]; gk.k[base + 3] = GREY[2];
              }
            }
          }
        }

        Object.keys(node).forEach(function(key) { walk(node[key]); });
      }

      walk(obj);
    })(scanAnimation);

    /* Lottie player â€” created fresh each scan, destroyed after */
    var lottieAnim = null;

    /* â”€â”€ Three-state flow: "upload" | "scanning" | "results" â”€â”€ */
    var appState = 'upload';

    /* â”€â”€ Broker data from Flask â”€â”€ */
    const BROKERS = {{ brokers_json|safe }};
    const brokerNames = BROKERS.map(b => b.name);
    const brokerAddressMap = Object.fromEntries(BROKERS.map(b => [b.name, b.address || '']));

    /* â”€â”€ DOM refs (cached before setState detaches elements) â”€â”€ */
    const stateContainer = document.getElementById('state-container');
    const uploadCard     = document.getElementById('upload-card');
    const editCard       = document.getElementById('edit');
    const fileInput      = document.getElementById('file-input');
    const dropZone       = document.getElementById('drop-zone');
    const accountInput   = document.getElementById('account_name');
    const dropdown       = document.getElementById('typeahead-dropdown');
    let activeIdx        = -1;

    /* â”€â”€ State management â”€â”€ */
    function setState(newState, filename) {
      /* Clean up scanning state */
      if (appState === 'scanning') {
        clearInterval(progressTimer);
        if (lottieAnim) { lottieAnim.destroy(); lottieAnim = null; }
      }

      /* Remove all children from container (detach, not destroy) */
      while (stateContainer.firstChild) {
        stateContainer.removeChild(stateContainer.firstChild);
      }

      appState = newState;

      if (newState === 'upload') {
        fileInput.value = '';
        stateContainer.appendChild(uploadCard);

      } else if (newState === 'scanning') {
        /* Build scanning section dynamically */
        var section = document.createElement('div');
        section.className = 'lottie-loading';
        var safeName = (filename || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        section.innerHTML =
          '<div id="lottie-player"></div>' +
          '<p class="loading-text">We\'re attempting to read <em>' + safeName + '</em>. Hold tight!</p>' +
          '<div class="progress-wrap">' +
            '<div class="progress-pct" id="progress-pct">0%</div>' +
            '<div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>' +
          '</div>';
        stateContainer.appendChild(section);

        /* Init Lottie */
        lottieAnim = lottie.loadAnimation({
          container: document.getElementById('lottie-player'),
          renderer: 'svg',
          loop: true,
          autoplay: true,
          animationData: JSON.parse(JSON.stringify(scanAnimation))
        });
        startProgress();

      } else if (newState === 'results') {
        editCard.classList.remove('fade-in');
        stateContainer.appendChild(editCard);
      }
    }

    /* â”€â”€ Reset back to upload state â”€â”€ */
    function resetToUpload() {
      /* Clear all form fields while edit card is still in DOM */
      [
        'supplier', 'purchase_order_number', 'service_description',
        'site_contact', 'site_contact_number', 'site_contact_email',
        'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
        'site_name', 'site_address', 'site_postcode',
        'opening_times', 'access', 'site_restrictions', 'special_instructions',
        'account_name', 'supplier_address'
      ].forEach(function(key) { setField(key, ''); });
      setField('document_type', 'Consignment Note');
      clearLineItems();
      var elDocTitle = document.getElementById('doc-title');
      if (elDocTitle) elDocTitle.textContent = 'Purchase Order';
      var elDocLabel = document.getElementById('doc-supplier-label');
      if (elDocLabel) elDocLabel.textContent = '';
      var elAccErr = document.getElementById('account-error');
      if (elAccErr) elAccErr.classList.add('hidden');
      var elBanner = document.getElementById('hs-banner-area');
      if (elBanner) elBanner.innerHTML = '';
      var elTmplArea = document.getElementById('template-prompt-area');
      if (elTmplArea) elTmplArea.innerHTML = '';
      document.querySelectorAll('.conf-dot').forEach(function(d) { d.remove(); });
      document.querySelectorAll('.conf-low-border').forEach(function(el) { el.classList.remove('conf-low-border'); });
      if (dropdown) dropdown.classList.remove('open');
      _lastExtractedData = null;
      _lastConfidence = null;
      _lastSupplierTrained = false;

      setState('upload');
    }

    /* â”€â”€ Helpers â”€â”€ */
    function setField(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value || '';
    }
    function getField(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    }

    /* â”€â”€ Typeahead dropdown â”€â”€ */
    function renderDropdown(term) {
      if (!dropdown) return;
      const q = (term || '').trim().toLowerCase();
      let matches = brokerNames;
      if (q) {
        matches = brokerNames.filter(name => name.toLowerCase().includes(q));
      }
      matches = matches.slice(0, 40);
      activeIdx = -1;

      if (matches.length === 0) {
        dropdown.innerHTML = '<div class="typeahead-item" style="color:#8a9bb0; cursor:default;">No matching suppliers</div>';
        dropdown.classList.add('open');
        return;
      }

      dropdown.innerHTML = matches.map((name, i) => {
        let display = name;
        if (q) {
          const idx = name.toLowerCase().indexOf(q);
          if (idx !== -1) {
            display = name.substring(0, idx)
              + '<mark>' + name.substring(idx, idx + q.length) + '</mark>'
              + name.substring(idx + q.length);
          }
        }
        return `<div class="typeahead-item" data-index="${i}" data-value="${name}">${display}</div>`;
      }).join('');

      dropdown.classList.add('open');
    }

    function closeDropdown() {
      setTimeout(() => {
        if (dropdown) dropdown.classList.remove('open');
        activeIdx = -1;
      }, 150);
    }

    function selectSupplier(name) {
      if (accountInput) accountInput.value = name;
      if (dropdown) dropdown.classList.remove('open');
      updateSupplierAddress();
      validateAccount();
    }

    dropdown.addEventListener('mousedown', e => {
      const item = e.target.closest('.typeahead-item');
      if (item && item.dataset.value) {
        e.preventDefault();
        selectSupplier(item.dataset.value);
      }
    });

    accountInput.addEventListener('focus', () => renderDropdown(accountInput.value));
    accountInput.addEventListener('input', () => {
      renderDropdown(accountInput.value);
      updateSupplierAddress();
      validateAccount();
    });
    accountInput.addEventListener('blur', closeDropdown);
    accountInput.addEventListener('keydown', e => {
      const items = dropdown.querySelectorAll('.typeahead-item[data-value]');
      if (!items.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIdx = Math.min(activeIdx + 1, items.length - 1);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
        items[activeIdx].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIdx = Math.max(activeIdx - 1, 0);
        items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
        items[activeIdx].scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (activeIdx >= 0 && activeIdx < items.length) {
          selectSupplier(items[activeIdx].dataset.value);
        }
      } else if (e.key === 'Escape') {
        if (dropdown) dropdown.classList.remove('open');
      }
    });

    /* â”€â”€ Smart supplier address lookup (exact â†’ case-insensitive â†’ partial) â”€â”€ */
    function lookupSupplierAddress(name) {
      if (!name) return '';

      /* 1. Exact match */
      if (brokerAddressMap[name]) return brokerAddressMap[name];

      var nameLower = name.trim().toLowerCase();

      /* 2. Case-insensitive match */
      for (var key in brokerAddressMap) {
        if (key.toLowerCase() === nameLower) return brokerAddressMap[key];
      }

      /* 3. Partial match â€” input is substring of a key, or key is substring of input */
      var best = '';
      var bestLen = 0;
      for (var key in brokerAddressMap) {
        if (!brokerAddressMap[key]) continue;
        var keyLower = key.toLowerCase();
        if (keyLower.includes(nameLower) || nameLower.includes(keyLower)) {
          /* Prefer longest matching key (most specific) */
          if (key.length > bestLen) {
            best = brokerAddressMap[key];
            bestLen = key.length;
          }
        }
      }

      return best;
    }

    /* â”€â”€ Address / validation â”€â”€ */
    function updateSupplierAddress() {
      const account = getField('account_name');
      const current = getField('supplier_address');
      const suggested = lookupSupplierAddress(account);
      if (!current || current === suggested || brokerNames.includes(account)) {
        setField('supplier_address', suggested);
      }
    }

    function validateAccount() {
      const account = getField('account_name');
      const valid = brokerNames.includes(account);
      var elErr = document.getElementById('account-error');
      if (elErr) elErr.classList.toggle('hidden', valid);
      if (!valid) {
        var elAddr = document.getElementById('supplier_address');
        if (elAddr) elAddr.value = '';
      }
      return valid;
    }

    /* â”€â”€ Line items â”€â”€ */
    let lineItemCounter = 0;

    function addLineItem(desc, qty, unitPrice, lineTotal) {
      const container = document.getElementById('line-items-container');
      const idx = lineItemCounter++;
      const row = document.createElement('div');
      row.className = 'line-item-row';
      row.dataset.liIdx = idx;
      row.innerHTML = `
        <div><div class="li-label">Description</div><input type="text" class="li-desc" value="${(desc || '').replace(/"/g, '&quot;')}" /></div>
        <div><div class="li-label">Quantity</div><input type="number" class="li-qty" value="${qty || 1}" min="0" step="1" onchange="recalcLineItem(this)" /></div>
        <div><div class="li-label">Price / Unit</div><input type="number" class="li-unit" value="${unitPrice || 0}" min="0" step="0.01" onchange="recalcLineItem(this)" /></div>
        <div><div class="li-label">Line Total</div><input type="number" class="li-total" value="${lineTotal || 0}" min="0" step="0.01" onchange="recalcOverallTotal()" /></div>
        <div style="padding-bottom:1px;"><button class="btn-remove" type="button" onclick="removeLineItem(this)">&times;</button></div>
      `;
      container.appendChild(row);
      recalcOverallTotal();
    }

    function removeLineItem(btn) {
      btn.closest('.line-item-row').remove();
      recalcOverallTotal();
    }

    function recalcLineItem(input) {
      const row = input.closest('.line-item-row');
      const qty = parseFloat(row.querySelector('.li-qty').value) || 0;
      const unit = parseFloat(row.querySelector('.li-unit').value) || 0;
      row.querySelector('.li-total').value = (qty * unit).toFixed(2);
      recalcOverallTotal();
    }

    function recalcOverallTotal() {
      let total = 0;
      document.querySelectorAll('.line-item-row').forEach(row => {
        total += parseFloat(row.querySelector('.li-total').value) || 0;
      });
      document.getElementById('overall_total_display').textContent = 'Â£' + total.toFixed(2);
    }

    function getLineItems() {
      const items = [];
      document.querySelectorAll('.line-item-row').forEach(row => {
        items.push({
          description: row.querySelector('.li-desc').value.trim(),
          quantity: parseFloat(row.querySelector('.li-qty').value) || 1,
          unit_price: parseFloat(row.querySelector('.li-unit').value) || 0,
          line_total: parseFloat(row.querySelector('.li-total').value) || 0
        });
      });
      return items;
    }

    function clearLineItems() {
      document.getElementById('line-items-container').innerHTML = '';
      lineItemCounter = 0;
      recalcOverallTotal();
    }

    /* â”€â”€ Fill form from extraction response â”€â”€ */
    var _lastExtractedData = null;  /* Stored for template save */
    var _lastConfidence = null;
    var _lastSupplierTrained = false;

    function fillForm(data, confidence, supplierTrained) {
      _lastExtractedData = JSON.parse(JSON.stringify(data));
      _lastConfidence = confidence || {};
      _lastSupplierTrained = !!supplierTrained;

      [
        'supplier', 'purchase_order_number', 'service_description',
        'site_contact', 'site_contact_number', 'site_contact_email',
        'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
        'site_name', 'site_address', 'site_postcode',
        'opening_times', 'access', 'site_restrictions', 'special_instructions'
      ].forEach(key => setField(key, data[key]));

      /* Account name left blank â€” user must select via typeahead */
      setField('account_name', '');

      const docType = data.document_type === 'Waste Transfer Note' ? 'Waste Transfer Note' : 'Consignment Note';
      setField('document_type', docType);

      /* Update document header */
      const supplierName = data.supplier || 'Unknown Supplier';
      const poNum = data.purchase_order_number || '';
      document.getElementById('doc-title').textContent = 'Purchase Order' + (poNum ? ' â€” ' + poNum : '');
      document.getElementById('doc-supplier-label').textContent = 'From: ' + supplierName;

      setField('supplier_address', '');
      validateAccount();

      /* Populate line items */
      clearLineItems();
      const items = data.line_items || [];
      items.forEach(item => {
        addLineItem(item.description, item.quantity, item.unit_price, item.line_total);
      });

      /* Render confidence dots */
      renderConfidenceDots(confidence || {});

      /* Show template prompt for untrained suppliers */
      showTemplatePrompt(supplierName, supplierTrained);
    }

    /* â”€â”€ Collect payload â”€â”€ */
    function collectReviewPayload() {
      const items = getLineItems();
      const overallTotal = items.reduce((sum, i) => sum + (i.line_total || 0), 0);
      return {
        account_name: getField('account_name'),
        supplier_address: getField('supplier_address'),
        purchase_order_number: getField('purchase_order_number'),
        service_description: getField('service_description'),
        document_type: getField('document_type'),
        site_contact: getField('site_contact'),
        site_contact_number: getField('site_contact_number'),
        site_contact_email: getField('site_contact_email'),
        secondary_site_contact: getField('secondary_site_contact'),
        secondary_site_contact_number: getField('secondary_site_contact_number'),
        secondary_site_contact_email: getField('secondary_site_contact_email'),
        site_name: getField('site_name'),
        site_address: getField('site_address'),
        site_postcode: getField('site_postcode'),
        opening_times: getField('opening_times'),
        access: getField('access'),
        site_restrictions: getField('site_restrictions'),
        special_instructions: getField('special_instructions'),
        line_items: items,
        overall_total: overallTotal
      };
    }

    /* â”€â”€ Download PDF â”€â”€ */
    async function downloadReviewPDF() {
      if (!validateAccount()) return;
      const btn = document.getElementById('btn-download');
      const origText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Generating PDF\u2026';
      const payload = collectReviewPayload();
      try {
        const resp = await fetch('/download-review-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ error: 'Unable to download PDF' }));
          throw new Error(err.error || 'Unable to download PDF');
        }
        const blob = await resp.blob();
        if (blob.size === 0) throw new Error('Received empty PDF \u2014 please try again');
        const disposition = resp.headers.get('Content-Disposition') || '';
        const match = disposition.match(/filename[^;=\n]*=\s*(?:UTF-8''|"?)([^";\n]+)/i);
        const filename = match ? decodeURIComponent(match[1].replace(/"/g, '')) : 'review.pdf';
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 2000);
        showToast('PDF downloaded successfully');
      } catch (err) { alert(err.message); }
      finally { btn.disabled = false; btn.textContent = origText; }
    }

    /* â”€â”€ Download as CSV â”€â”€ */
    function csvEscape(val) {
      var s = String(val == null ? '' : val);
      if (s.indexOf(',') !== -1 || s.indexOf('"') !== -1 || s.indexOf('\n') !== -1) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }

    function downloadCSV() {
      var payload = collectReviewPayload();
      var items = payload.line_items || [];
      var total = (payload.overall_total || 0).toFixed(2);
      var rows = [];

      /* Purchase Order Summary */
      rows.push('PURCHASE ORDER SUMMARY');
      rows.push('Field,Value');
      rows.push('PO Number,' + csvEscape(payload.purchase_order_number || ''));
      rows.push('Supplier,' + csvEscape(payload.account_name || payload.supplier || ''));
      rows.push('Service Description,' + csvEscape(payload.service_description || ''));
      rows.push('Document Type,' + csvEscape(payload.document_type || ''));
      rows.push('Total Amount,' + csvEscape('\u00a3' + total));
      rows.push('');

      /* Line Items */
      rows.push('LINE ITEMS');
      rows.push('Item #,Description,Quantity,Unit Price,Line Total');
      items.forEach(function(li, i) {
        rows.push(
          (i + 1) + ',' +
          csvEscape(li.description || '') + ',' +
          (li.quantity || 0) + ',' +
          csvEscape('\u00a3' + (li.unit_price || 0).toFixed(2)) + ',' +
          csvEscape('\u00a3' + (li.line_total || 0).toFixed(2))
        );
      });
      rows.push('');

      /* Delivery Details */
      rows.push('DELIVERY DETAILS');
      rows.push('Site Name,' + csvEscape(payload.site_name || ''));
      rows.push('Delivery Address,' + csvEscape(payload.site_address || ''));
      rows.push('Site Postcode,' + csvEscape(payload.site_postcode || ''));
      rows.push('Bill To Address,' + csvEscape(payload.supplier_address || ''));
      rows.push('');

      /* Contact Information */
      rows.push('CONTACT INFORMATION');
      rows.push('Site Contact,' + csvEscape(payload.site_contact || ''));
      rows.push('Site Contact Number,' + csvEscape(payload.site_contact_number || ''));
      rows.push('Site Contact Email,' + csvEscape(payload.site_contact_email || ''));
      rows.push('Secondary Contact,' + csvEscape(payload.secondary_site_contact || ''));
      rows.push('Secondary Contact Number,' + csvEscape(payload.secondary_site_contact_number || ''));
      rows.push('Secondary Contact Email,' + csvEscape(payload.secondary_site_contact_email || ''));
      rows.push('');

      /* Notes */
      rows.push('NOTES');
      var notes = [
        payload.opening_times ? 'Opening Times: ' + payload.opening_times : '',
        payload.access ? 'Access: ' + payload.access : '',
        payload.site_restrictions ? 'Site Restrictions: ' + payload.site_restrictions : '',
        payload.special_instructions ? 'Special Instructions: ' + payload.special_instructions : ''
      ].filter(Boolean).join('; ');
      rows.push(csvEscape(notes || 'None'));

      /* BOM + CSV content for proper Excel Â£ rendering */
      var csvContent = '\uFEFF' + rows.join('\r\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var filename = (uploadedFileName || 'purchase_order') + '_extracted.csv';
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(function() { URL.revokeObjectURL(url); }, 2000);
      showToast('CSV downloaded');
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => { if (toast) toast.classList.remove('show'); }, 2000);
    }

    /* â”€â”€ Progress bar helpers â”€â”€ */
    var progressTimer = null;
    var currentProgress = 0;

    function startProgress() {
      currentProgress = 0;
      updateProgressUI(0);
      progressTimer = setInterval(function() {
        /* Ease towards 90% â€” slows as it approaches */
        var remaining = 90 - currentProgress;
        currentProgress += remaining * 0.03;
        if (currentProgress > 89.5) currentProgress = 90;
        updateProgressUI(currentProgress);
        if (currentProgress >= 90) clearInterval(progressTimer);
      }, 200);
    }

    function finishProgress() {
      clearInterval(progressTimer);
      currentProgress = 100;
      updateProgressUI(100);
    }

    function resetProgress() {
      clearInterval(progressTimer);
      currentProgress = 0;
      updateProgressUI(0);
    }

    function updateProgressUI(pct) {
      var rounded = Math.round(pct);
      var pctEl = document.getElementById('progress-pct');
      var fillEl = document.getElementById('progress-fill');
      if (pctEl) pctEl.textContent = rounded + '%';
      if (fillEl) fillEl.style.width = rounded + '%';
    }

    /* â”€â”€ Upload & extract â”€â”€ */
    async function uploadAndExtract(file) {
      /* Transition to scanning state (removes upload card, shows animation) */
      setState('scanning', file.name);

      const fd = new FormData();
      fd.append('pdf', file);

      try {
        const resp = await fetch('/extract', { method: 'POST', body: fd });
        const json = await resp.json();
        if (!resp.ok || json.error) throw new Error(json.error || 'Extraction failed');

        /* Jump progress to 100% */
        finishProgress();

        /* Brief delay so user sees 100% before transition (~500ms) */
        await new Promise(function(r) { setTimeout(r, 500); });

        /* Transition to results state (removes scanning, shows edit card) */
        setState('results');
        fillForm(json.data || {}, json.confidence || {}, json.supplier_trained);
        requestAnimationFrame(function() { if (editCard) editCard.classList.add('fade-in'); });
      } catch (err) {
        alert(err.message);
        setState('upload');
      }
    }

    /* â”€â”€ Drag & drop â”€â”€ */
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      if (dropZone) dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => {
      if (dropZone) dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      if (dropZone) dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.pdf')) uploadAndExtract(file);
    });
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) uploadAndExtract(file);
    });

    /* â”€â”€ Initialize: show only upload state â”€â”€ */
    setState('upload');

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HubSpot Integration
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    var uploadedFileName = '';  /* Stored when file is uploaded */

    /* â”€â”€ Test HubSpot Connection â”€â”€ */
    async function testHubSpotConnection() {
      var btn = document.getElementById('btn-hs-test');
      var output = document.getElementById('hs-test-output');
      btn.disabled = true;
      btn.textContent = 'Testingâ€¦';
      output.classList.remove('hidden');
      output.textContent = 'Connecting to HubSpotâ€¦';
      try {
        var resp = await fetch('/api/hubspot/test');
        var data = await resp.json();
        output.textContent = JSON.stringify(data, null, 2);
      } catch(err) {
        output.textContent = 'Error: ' + err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test HubSpot Connection';
      }
    }

    /* Patch uploadAndExtract to remember filename */
    var _origUploadAndExtract = uploadAndExtract;
    uploadAndExtract = async function(file) {
      uploadedFileName = file.name.replace(/\.pdf$/i, '');
      return _origUploadAndExtract(file);
    };

    /* â”€â”€ Settings toggle â”€â”€ */
    function toggleSettings() {
      var s = document.getElementById('settings-section');
      if (s) s.classList.toggle('hidden');
    }

    /* â”€â”€ Fetch HubSpot Owners â”€â”€ */
    async function fetchHubSpotOwners() {
      var btn = document.getElementById('btn-fetch-owners');
      var container = document.getElementById('owners-list-container');
      if (!btn || !container) return;
      btn.disabled = true;
      btn.textContent = 'Fetchingâ€¦';
      try {
        var resp = await fetch('/api/hubspot/owners');
        var data = await resp.json();
        if (!resp.ok || data.error) throw new Error(data.error || 'Failed to fetch owners');
        var owners = data.owners || [];
        container.innerHTML = owners.map(function(o) {
          return '<div class="owner-row"><span>' + escHtml(o.name) + ' <span style="color:#5a7a94">(' + escHtml(o.email) + ')</span></span><span class="owner-id">' + escHtml(o.id) + '</span></div>';
        }).join('');
        if (!owners.length) container.innerHTML = '<div style="color:#8aa3b8; padding:8px 0;">No owners found</div>';
        container.classList.remove('hidden');
        if (data.nathan_id) {
          showToast('Nathan Malone found â€” Owner ID: ' + data.nathan_id);
        }
      } catch(err) {
        container.innerHTML = '<div style="color:#f87171; padding:8px 0;">' + escHtml(err.message) + '</div>';
        container.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Fetch HubSpot Owners';
      }
    }

    function escHtml(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* â”€â”€ HubSpot preview modal â”€â”€ */
    function openHubSpotPreview() {
      var payload = collectReviewPayload();
      var dealName = uploadedFileName || 'Untitled Deal';
      var today = new Date().toISOString().split('T')[0];
      var totalAmount = (payload.overall_total || 0).toFixed(2);
      var poNumber = payload.purchase_order_number || 'â€”';
      var supplierName = payload.account_name || payload.supplier || '';
      var items = payload.line_items || [];

      /* Build description from line items */
      var desc = items.map(function(li, i) {
        return (i+1) + '. ' + (li.description || 'Item') + ' (x' + li.quantity + ' @ Â£' + (li.unit_price||0).toFixed(2) + ')';
      }).join('; ');

      /* Build line items table */
      var liHtml = '';
      if (items.length) {
        liHtml = '<table class="hs-li-table"><thead><tr><th>Description</th><th>Qty</th><th>Unit Price</th><th>Line Total</th></tr></thead><tbody>';
        items.forEach(function(li) {
          liHtml += '<tr><td>' + escHtml(li.description) + '</td><td>' + li.quantity + '</td><td>Â£' + (li.unit_price||0).toFixed(2) + '</td><td>Â£' + (li.line_total||0).toFixed(2) + '</td></tr>';
        });
        liHtml += '</tbody></table>';
      } else {
        liHtml = '<div style="color:#8aa3b8; font-size:12px;">No line items</div>';
      }

      var modalHtml =
        '<div class="hs-overlay" id="hs-overlay" onclick="if(event.target===this)closeHubSpotModal()">' +
          '<div class="hs-modal">' +
            '<div class="hs-modal-head">' +
              '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.83 11.41V7.55a2.2 2.2 0 0 0 1.27-1.98 2.22 2.22 0 0 0-2.22-2.22h-.04V1.5a.75.75 0 0 0-1.5 0v1.85h-.04a2.22 2.22 0 0 0-2.22 2.22c0 .9.54 1.67 1.31 2.01v3.83a5.1 5.1 0 0 0-2.53 1.27l-6.63-5.16a2.03 2.03 0 0 0 .05-.42 2.08 2.08 0 1 0-2.08 2.08c.4 0 .77-.12 1.09-.32l6.45 5.02a5.17 5.17 0 0 0 .42 5.53l-1.79 1.79a1.7 1.7 0 0 0-.5-.08 1.72 1.72 0 1 0 1.72 1.72c0-.17-.03-.34-.08-.5l1.76-1.76a5.18 5.18 0 1 0 5.96-8.52zM16.84 18a2.68 2.68 0 1 1 0-5.37 2.68 2.68 0 0 1 0 5.37z"/></svg>' +
              'HubSpot Deal Preview' +
            '</div>' +
            '<div class="hs-modal-body">' +
              '<div class="hs-section">Deal Properties</div>' +
              '<div class="hs-row"><span class="hs-label">Deal Name</span><span class="hs-value">' + escHtml(dealName) + '</span></div>' +
              '<div class="hs-row"><span class="hs-label">Create Date</span><span class="hs-value">' + today + '</span></div>' +
              '<div class="hs-row"><span class="hs-label">Close Date</span><span class="hs-value">' + today + '</span></div>' +
              '<div class="hs-row"><span class="hs-label">Forecast Amount</span><span class="hs-value">Â£' + totalAmount + '</span></div>' +
              '<div class="hs-row"><span class="hs-label">Deal Owner</span><span class="hs-value">Nathan Malone</span></div>' +
              '<div class="hs-row"><span class="hs-label">Is Deal Closed</span><span class="hs-value">Yes</span></div>' +
              '<div class="hs-row"><span class="hs-label">PO Number</span><span class="hs-value">' + escHtml(poNumber) + '</span></div>' +

              '<div class="hs-section">Line Items</div>' +
              liHtml +

              '<div class="hs-section">Company Association</div>' +
              '<div class="hs-row"><span class="hs-label">Supplier</span><span class="hs-value">' + escHtml(supplierName || 'â€”') + '</span></div>' +
              '<div style="padding:6px 0; font-size:12px; color:#8aa3b8;"><em>Company match will be checked when creating the deal</em></div>' +

              '<div class="hs-actions">' +
                '<button class="btn-outline" type="button" onclick="closeHubSpotModal()">Cancel</button>' +
                '<button class="btn-hubspot" type="button" id="btn-hs-confirm" onclick="confirmCreateDeal()">' +
                  'Confirm &amp; Create Deal' +
                '</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      document.getElementById('hs-modal-root').innerHTML = modalHtml;

      /* Store deal data for submission */
      window._hsDealData = {
        deal_name: dealName,
        amount: payload.overall_total || 0,
        po_number: payload.purchase_order_number || '',
        supplier_name: supplierName,
        line_items: items,
        description: desc
      };
    }

    function closeHubSpotModal() {
      document.getElementById('hs-modal-root').innerHTML = '';
    }

    /* â”€â”€ Create deal â”€â”€ */
    async function confirmCreateDeal() {
      var btn = document.getElementById('btn-hs-confirm');
      btn.disabled = true;
      btn.textContent = 'Creating dealâ€¦';

      try {
        var resp = await fetch('/api/hubspot/create-deal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(window._hsDealData)
        });
        var data = await resp.json();

        if (!resp.ok || data.error) {
          throw new Error(data.error || 'Failed to create deal');
        }

        closeHubSpotModal();

        /* Success banner */
        var bannerHtml = '<div class="hs-banner success">' +
          '<span>Deal created in HubSpot &#10003;</span>' +
          '<a href="' + escHtml(data.deal_url) + '" target="_blank" rel="noopener">View in HubSpot</a>';

        if (!data.company_id) {
          bannerHtml += '<div style="width:100%; font-size:11px; margin-top:4px; color:#8aa3b8;">No matching company found in HubSpot â€” deal created without association. You can link it manually.</div>';
        } else {
          bannerHtml += '<div style="width:100%; font-size:11px; margin-top:4px;"><span class="hs-match found">&#10003; Company matched: ' + escHtml(data.company_found || 'Unknown') + '</span></div>';
        }

        if (data.po_number_warning) {
          bannerHtml += '<div style="width:100%; font-size:11px; margin-top:4px; color:#ff7a59;">' + escHtml(data.po_number_warning) + '</div>';
        }

        if (data.association_warnings && data.association_warnings.length) {
          data.association_warnings.forEach(function(w) {
            bannerHtml += '<div style="width:100%; font-size:11px; margin-top:2px; color:#ff7a59;">' + escHtml(w) + '</div>';
          });
        }

        bannerHtml += '<span class="hs-banner-close" onclick="this.parentNode.remove()">&#10005;</span></div>';
        document.getElementById('hs-banner-area').innerHTML = bannerHtml;

      } catch(err) {
        closeHubSpotModal();

        /* Error banner with retry */
        var errHtml = '<div class="hs-banner error">' +
          '<span>' + escHtml(err.message) + '</span>' +
          '<button class="btn-hubspot" style="padding:6px 12px; font-size:12px;" onclick="openHubSpotPreview()">Retry</button>' +
          '<span class="hs-banner-close" onclick="this.parentNode.remove()">&#10005;</span>' +
          '</div>';
        document.getElementById('hs-banner-area').innerHTML = errHtml;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Supplier Template Training System
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    var _allTemplateSuppliers = [];

    /* â”€â”€ Load & render templates in settings â”€â”€ */
    async function loadTemplates() {
      try {
        var resp = await fetch('/api/templates');
        var data = await resp.json();
        _allTemplateSuppliers = data.suppliers || [];
        renderTemplateList(_allTemplateSuppliers, data.trained_count, data.total_count);
      } catch(e) {
        document.getElementById('template-progress-label').textContent = 'Failed to load suppliers';
      }
    }

    function renderTemplateList(suppliers, trainedCount, totalCount) {
      var pct = totalCount > 0 ? Math.round((trainedCount / totalCount) * 100) : 0;
      document.getElementById('template-progress-label').textContent = trainedCount + '/' + totalCount + ' suppliers trained';
      document.getElementById('template-progress-fill').style.width = pct + '%';

      var sorted = suppliers.slice().sort(function(a, b) {
        if (a.trained !== b.trained) return a.trained ? 1 : -1;
        return a.name.localeCompare(b.name);
      });

      var container = document.getElementById('template-supplier-list');
      container.innerHTML = sorted.map(function(s) {
        var badge = s.trained
          ? '<span class="badge-trained">Trained</span>'
          : '<span class="badge-untrained">Untrained</span>';
        var dateStr = s.trained_date
          ? '<span class="tmpl-date">' + new Date(s.trained_date).toLocaleDateString() + '</span>'
          : '';
        var safeName = s.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        var trainBtn = '<button class="btn-train" onclick="startTraining(\'' + safeName + '\')">' + (s.trained ? 'Re-train' : 'Train') + '</button>';
        var delBtn = s.trained
          ? '<button class="btn-del-tmpl" onclick="deleteTemplate(\'' + safeName + '\')">&times;</button>'
          : '';
        return '<div class="template-row" data-supplier="' + escHtml(s.name) + '">' +
          '<span class="tmpl-name" title="' + escHtml(s.name) + '">' + escHtml(s.name) + '</span>' +
          dateStr + badge + trainBtn + delBtn + '</div>';
      }).join('');
    }

    function filterTemplateList(term) {
      var q = (term || '').trim().toLowerCase();
      document.querySelectorAll('#template-supplier-list .template-row').forEach(function(row) {
        var name = (row.getAttribute('data-supplier') || '').toLowerCase();
        row.style.display = (!q || name.indexOf(q) !== -1) ? '' : 'none';
      });
    }

    /* â”€â”€ Delete template â”€â”€ */
    async function deleteTemplate(supplier) {
      if (!confirm('Delete template for ' + supplier + '?')) return;
      try {
        await fetch('/api/templates/' + encodeURIComponent(supplier), { method: 'DELETE' });
        showToast('Template deleted');
        loadTemplates();
      } catch(e) { alert('Failed to delete template'); }
    }

    /* â”€â”€ Training flow â”€â”€ */
    var _trainingSupplier = '';
    var _trainingOriginalData = null;

    function startTraining(supplier) {
      _trainingSupplier = supplier;
      _trainingOriginalData = null;

      var html =
        '<div class="train-overlay" id="train-overlay" onclick="if(event.target===this)closeTrainingModal()">' +
          '<div class="train-modal">' +
            '<div class="train-modal-head">' +
              '<span>Train Template: ' + escHtml(supplier) + '</span>' +
              '<span class="close-x" onclick="closeTrainingModal()">&times;</span>' +
            '</div>' +
            '<div class="train-modal-body" id="train-modal-body">' +
              '<div class="train-upload-area" id="train-drop-zone">' +
                '<p style="margin:0 0 10px; color:#c0cdd8;"><strong>Upload a sample PO PDF</strong> from this supplier</p>' +
                '<button class="btn" type="button" onclick="document.getElementById(\'train-file-input\').click()">Choose PDF</button>' +
                '<input id="train-file-input" type="file" accept=".pdf" class="hidden" />' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      document.getElementById('training-modal-root').innerHTML = html;

      var trainDrop = document.getElementById('train-drop-zone');
      var trainInput = document.getElementById('train-file-input');

      trainDrop.addEventListener('dragover', function(e) { e.preventDefault(); trainDrop.classList.add('drag-over'); });
      trainDrop.addEventListener('dragleave', function() { trainDrop.classList.remove('drag-over'); });
      trainDrop.addEventListener('drop', function(e) {
        e.preventDefault(); trainDrop.classList.remove('drag-over');
        var f = e.dataTransfer.files[0];
        if (f && f.name.toLowerCase().endsWith('.pdf')) uploadTrainingPDF(f);
      });
      trainInput.addEventListener('change', function(e) {
        var f = e.target.files[0];
        if (f) uploadTrainingPDF(f);
      });
    }

    function closeTrainingModal() {
      document.getElementById('training-modal-root').innerHTML = '';
      _trainingSupplier = '';
      _trainingOriginalData = null;
    }

    async function uploadTrainingPDF(file) {
      var body = document.getElementById('train-modal-body');
      body.innerHTML =
        '<div style="text-align:center; padding:32px;">' +
          '<p style="color:#c0cdd8; margin:0 0 12px;">Extracting data from <em>' + escHtml(file.name) + '</em>...</p>' +
          '<div class="progress-track" style="width:240px; margin:0 auto;">' +
            '<div class="progress-fill" id="train-progress" style="width:0%;"></div>' +
          '</div>' +
        '</div>';

      var tp = 0;
      var tTimer = setInterval(function() {
        tp += (90 - tp) * 0.03;
        var el = document.getElementById('train-progress');
        if (el) el.style.width = Math.round(tp) + '%';
        if (tp >= 89) clearInterval(tTimer);
      }, 200);

      var fd = new FormData();
      fd.append('pdf', file);
      fd.append('training', 'true');
      fd.append('training_supplier', _trainingSupplier);

      try {
        var resp = await fetch('/extract', { method: 'POST', body: fd });
        var json = await resp.json();
        clearInterval(tTimer);
        if (!resp.ok || json.error) throw new Error(json.error || 'Extraction failed');

        _trainingOriginalData = JSON.parse(JSON.stringify(json.data || {}));
        showTrainingForm(json.data || {});
      } catch(err) {
        clearInterval(tTimer);
        body.innerHTML = '<div style="padding:20px; color:#f87171;">' + escHtml(err.message) +
          '<br><br><button class="btn-outline" onclick="closeTrainingModal()">Close</button></div>';
      }
    }

    function showTrainingForm(data) {
      var body = document.getElementById('train-modal-body');
      var fields = [
        { id: 'purchase_order_number', label: 'PO Number', type: 'input' },
        { id: 'service_description', label: 'Service Description', type: 'input', full: true },
        { id: 'document_type', label: 'Document Type', type: 'select', options: ['Consignment Note', 'Waste Transfer Note'] },
        { id: 'site_contact', label: 'Site Contact', type: 'input' },
        { id: 'site_contact_number', label: 'Contact Number', type: 'input' },
        { id: 'site_contact_email', label: 'Contact Email', type: 'input', full: true },
        { id: 'secondary_site_contact', label: 'Secondary Contact', type: 'input' },
        { id: 'secondary_site_contact_number', label: 'Sec. Contact Number', type: 'input' },
        { id: 'secondary_site_contact_email', label: 'Sec. Contact Email', type: 'input', full: true },
        { id: 'site_name', label: 'Site Name', type: 'input' },
        { id: 'site_postcode', label: 'Site Postcode', type: 'input' },
        { id: 'site_address', label: 'Site Address', type: 'textarea', full: true },
        { id: 'opening_times', label: 'Opening Times', type: 'textarea' },
        { id: 'access', label: 'Access', type: 'textarea' },
        { id: 'site_restrictions', label: 'Site Restrictions', type: 'textarea' },
        { id: 'special_instructions', label: 'Special Instructions', type: 'textarea' },
      ];

      var html = '<p style="font-size:12px; color:#8aa3b8; margin:0 0 12px;">Review and correct the extracted data, then save as template.</p>';
      html += '<div class="train-grid">';
      html += '<div class="train-section-title">Extraction Results</div>';

      fields.forEach(function(f) {
        var val = escHtml(String(data[f.id] || ''));
        var cls = f.full ? 'full' : '';
        html += '<div class="field ' + cls + '">';
        html += '<label>' + escHtml(f.label) + '</label>';
        if (f.type === 'select') {
          html += '<select id="train_' + f.id + '">';
          f.options.forEach(function(opt) {
            var sel = (data[f.id] || '') === opt ? ' selected' : '';
            html += '<option' + sel + '>' + escHtml(opt) + '</option>';
          });
          html += '</select>';
        } else if (f.type === 'textarea') {
          html += '<textarea id="train_' + f.id + '">' + val + '</textarea>';
        } else {
          html += '<input id="train_' + f.id + '" type="text" value="' + val + '" />';
        }
        html += '</div>';
      });

      html += '<div class="train-section-title">Line Items</div>';
      html += '<div class="full" id="train-line-items">';
      var items = data.line_items || [];
      if (items.length) {
        html += '<div class="train-li-row" style="border:none; padding-bottom:2px;">' +
          '<span style="font-size:10px; font-weight:700; color:#8aa3b8; text-transform:uppercase;">Description</span>' +
          '<span style="font-size:10px; font-weight:700; color:#8aa3b8; text-transform:uppercase;">Qty</span>' +
          '<span style="font-size:10px; font-weight:700; color:#8aa3b8; text-transform:uppercase;">Unit Price</span>' +
          '<span style="font-size:10px; font-weight:700; color:#8aa3b8; text-transform:uppercase;">Total</span></div>';
        items.forEach(function(li) {
          html += '<div class="train-li-row">' +
            '<input type="text" class="tli-desc" value="' + escHtml(String(li.description || '')) + '" />' +
            '<input type="number" class="tli-qty" value="' + (li.quantity || 1) + '" min="0" step="1" />' +
            '<input type="number" class="tli-unit" value="' + (li.unit_price || 0) + '" min="0" step="0.01" />' +
            '<input type="number" class="tli-total" value="' + (li.line_total || 0) + '" min="0" step="0.01" />' +
            '</div>';
        });
      } else {
        html += '<div style="color:#8aa3b8; font-size:12px;">No line items extracted</div>';
      }
      html += '</div></div>';

      html += '<div class="train-actions">' +
        '<button class="btn-outline" type="button" onclick="closeTrainingModal()">Cancel</button>' +
        '<button class="btn" type="button" id="btn-save-template" onclick="saveTrainingTemplate()">Save Template</button>' +
        '</div>';

      body.innerHTML = html;
    }

    async function saveTrainingTemplate() {
      var btn = document.getElementById('btn-save-template');
      btn.disabled = true;
      btn.textContent = 'Saving\u2026';

      var corrected = {};
      ['purchase_order_number', 'service_description', 'document_type',
       'site_contact', 'site_contact_number', 'site_contact_email',
       'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
       'site_name', 'site_postcode', 'site_address',
       'opening_times', 'access', 'site_restrictions', 'special_instructions'
      ].forEach(function(f) {
        var el = document.getElementById('train_' + f);
        corrected[f] = el ? el.value.trim() : '';
      });

      var liRows = document.querySelectorAll('#train-line-items .train-li-row');
      var lineItems = [];
      liRows.forEach(function(row) {
        var desc = row.querySelector('.tli-desc');
        if (!desc) return;
        lineItems.push({
          description: desc.value || '',
          quantity: parseFloat((row.querySelector('.tli-qty') || {}).value) || 1,
          unit_price: parseFloat((row.querySelector('.tli-unit') || {}).value) || 0,
          line_total: parseFloat((row.querySelector('.tli-total') || {}).value) || 0,
        });
      });
      corrected.line_items = lineItems;

      try {
        var resp = await fetch('/api/templates/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            supplier: _trainingSupplier,
            original_data: _trainingOriginalData || {},
            corrected_data: corrected,
          })
        });
        var data = await resp.json();
        if (!resp.ok || data.error) throw new Error(data.error || 'Failed to save template');

        closeTrainingModal();
        showToast('Template saved for ' + _trainingSupplier);
        loadTemplates();
      } catch(err) {
        alert(err.message);
        btn.disabled = false;
        btn.textContent = 'Save Template';
      }
    }

    /* â”€â”€ Confidence dots â”€â”€ */
    function renderConfidenceDots(confidence) {
      document.querySelectorAll('.conf-dot').forEach(function(d) { d.remove(); });
      document.querySelectorAll('.conf-low-border').forEach(function(el) { el.classList.remove('conf-low-border'); });

      var fieldIds = [
        'purchase_order_number', 'service_description',
        'site_contact', 'site_contact_number', 'site_contact_email',
        'secondary_site_contact', 'secondary_site_contact_number', 'secondary_site_contact_email',
        'site_name', 'site_address', 'site_postcode',
        'opening_times', 'access', 'site_restrictions',
        'special_instructions', 'document_type'
      ];

      fieldIds.forEach(function(fieldId) {
        var level = confidence[fieldId] || 'medium';
        var input = document.getElementById(fieldId);
        if (!input) return;

        var wrapper = input.closest('.field');
        if (wrapper) {
          var lbl = wrapper.querySelector('label');
          if (lbl) {
            var dot = document.createElement('span');
            dot.className = 'conf-dot ' + level;
            dot.title = level.charAt(0).toUpperCase() + level.slice(1) + ' confidence';
            lbl.appendChild(dot);
          }
        }
        if (level === 'low') input.classList.add('conf-low-border');
      });
    }

    /* â”€â”€ Template prompt for untrained suppliers â”€â”€ */
    function showTemplatePrompt(supplierName, isTrained) {
      var area = document.getElementById('template-prompt-area');
      if (!area) return;
      if (isTrained || !supplierName || supplierName === 'Unknown Supplier') {
        area.innerHTML = '';
        return;
      }
      area.innerHTML =
        '<div class="template-prompt-banner">' +
          '<span>This supplier hasn\'t been trained yet. Save as template?</span>' +
          '<button class="btn-train" onclick="saveCurrentAsTemplate()" style="padding:5px 12px;">Save as Template</button>' +
          '<span class="dismiss" onclick="this.parentNode.remove()">&times;</span>' +
        '</div>';
    }

    async function saveCurrentAsTemplate() {
      var supplier = getField('supplier');
      if (!supplier) { alert('No supplier identified'); return; }
      var corrected = collectReviewPayload();
      corrected.document_type = getField('document_type');
      try {
        var resp = await fetch('/api/templates/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            supplier: supplier,
            original_data: _lastExtractedData || {},
            corrected_data: corrected,
          })
        });
        var data = await resp.json();
        if (!resp.ok || data.error) throw new Error(data.error || 'Failed to save template');
        var area = document.getElementById('template-prompt-area');
        if (area) area.innerHTML = '<div class="template-prompt-banner"><span>Template saved for ' + escHtml(supplier) + ' &#10003;</span><span class="dismiss" onclick="this.parentNode.remove()">&times;</span></div>';
        showToast('Template saved');
        loadTemplates();
      } catch(err) { alert(err.message); }
    }

    /* â”€â”€ Init templates â”€â”€ */
    loadTemplates();
  </script>
</body>
</html>
